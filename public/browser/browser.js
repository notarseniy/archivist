!function t(e,n,i){function r(s,a){if(!n[s]){if(!e[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var u=n[s]={exports:{}};e[s][0].call(u.exports,function(t){var n=e[s][1][t];return r(n?n:t)},u,u.exports,t,e,n,i)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(t,e,n){"use strict";var i=(t("substance/helpers"),t("substance-application")),r=t("./browser_controller"),o=t("substance-application").DefaultRouter,s=function(t){i.call(this),this.controller=new r(this,t);var e=new o(this);this.setRouter(e)};s.Prototype=function(){var t=i.prototype;this.start=function(e){t.start.call(this,e),this.el.appendChild(this.controller.view.render().el),window.location.hash||this.switchState([{id:"main"}],{updateRoute:!0,replace:!0})}},s.Prototype.prototype=i.prototype,s.prototype=new s.Prototype,e.exports=s},{"./browser_controller":4,"substance-application":250,"substance/helpers":27}],2:[function(t,e,n){var i={};e.exports=i},{}],3:[function(t,e,n){var i=[];e.exports=i},{}],4:[function(t,e,n){"use strict";var i=t("substance/helpers"),r=t("substance-application").Controller,o=t("./browser_view"),s=t("./search_query"),a=t("./search_result"),c=(t("./available_facets"),t("./available_keywords")),l={searchStr:"",filters:{}},u=function(t,e){r.call(this,t),this.config=e,this.searchQuery=new s(l),this.createView(),this.searchQuery.on("query:changed",i.bind(this.startSearch,this))};u.Prototype=function(){this.initialize=function(t,e){console.log("loading the map.."),e(null)},this.startSearch=function(){this.switchState({id:"main",searchQuery:this.searchQuery.toJSON()})},this.getSuggestions=function(t){var e=[];return i.each(c,function(n){n.toLowerCase().match(t.toLowerCase())&&e.push({value:n.replace(t,"<b>"+t+"</b>"),rawValue:n})}),e},this.createView=function(){return this.view||(this.view=new o(this)),this.view},this.transition=function(t,e){console.log("BrowserController.transition(%s -> %s)",this.state.id,t.id);var n=this;if("main"!==t.id)return console.log("state not explicitly handled",this.state,t),e(null);if("uninitialized"===this.state.id){var r;return t.searchQuery?r=JSON.parse(JSON.stringify(t.searchQuery)):(r=l,t.searchQuery=JSON.parse(JSON.stringify(r))),this.searchQuery.setQuery(r),void this.config.backend.getNameMap(function(i,r){n.names=r,n.config.backend.getSubjectsModel(function(i,r){n.subjects=r,n.loadSearchResult(t,e)})})}return i.isEqual(t.searchQuery,this.state.searchQuery)?(console.log("no state change detected, skipping",this.state,t),e(null,{skip:!0})):void this.loadSearchResult(t,e)},this.loadSearchResult=function(t,e){this.view.showLoading();var n=t.searchQuery,i=this;this.config.backend.findDocuments(n,function(t,n,r){i.searchResult=new a({searchQuery:i.searchQuery,result:n},{}),i.searchResult.subjects=i.subjects,i.previewData=null,e(null)})},this.afterTransition=function(t){var e=this.state;this.view.afterTransition(t,e)},this.getName=function(t){return this.names[t].name},this.getType=function(t){return this.names[t].type}},u.Prototype.prototype=r.prototype,u.prototype=new u.Prototype,u.Controller=u,e.exports=u},{"./available_facets":2,"./available_keywords":3,"./browser_view":5,"./search_query":8,"./search_result":9,"substance-application":250,"substance/helpers":27}],5:[function(t,e,n){"use strict";var i=t("substance/helpers"),r=t("substance-application").View,o=t("substance-application").$$,s=t("./searchbar_view"),a=t("./preview_view"),c=t("./util"),l=t("../shared/components/tree"),u=function(t){r.call(this),this.controller=t,this.$el.attr({id:"container"}),this.searchbarView=new s(this.controller,{getSuggestions:i.bind(this.controller.getSuggestions,this.controller)}),this.facetsEl=o("#facet_filters"),this.facetsWrapperEl=o("#facets"),this.facetsWrapperEl.appendChild(o(".facets_title",{text:i18n.t("browser.facets_title")})),this.facetsWrapperEl.appendChild(this.facetsEl),this.documentsEl=o("#documents"),this.documentsEl.appendChild(o(".stats",{text:i18n.t("browser.loading")})),this.previewEl=o("#preview"),this.modalEl=o("#modal.modal.hidden"),this.panelWrapperEl=o(".panel-wrapper"),this.panelWrapperEl.appendChild(this.facetsWrapperEl),this.panelWrapperEl.appendChild(this.documentsEl),this.panelWrapperEl.appendChild(this.previewEl),this.progressbarEl=o(".progress-bar",{html:'<div class="progress loading"></div>'}),this.$el.on("click",".available-facets .value",i.bind(this.toggleFilter,this)),this.$el.on("click",".document .toggle-preview",i.bind(this.togglePreview,this)),this.$el.on("click",".toggle-details",i.bind(this.toggleDetails,this)),$(this.facetsEl).on("click",i.bind(this.blockFiltering,this))};u.Prototype=function(){this.blockFiltering=function(t){this.loading&&(t.preventDefault(),t.stopPropagation())},this._preventDefault=function(t){t.preventDefault()},this.togglePreview=function(t){t.preventDefault();var e=this.controller.searchQuery,n=$(t.currentTarget).parent(),i=n.attr("data-id"),r=this,o=n.find(".preview");o.length>0?o.toggle():(this.showLoading(),this.controller.loadPreview(i,e.searchStr,function(t){r.renderPreview(),r.hideLoading()}))},this.toggleFilter=function(t){t.preventDefault();var e=$(t.currentTarget).attr("data-facet"),n=$(t.currentTarget).attr("data-value");this.controller.searchQuery.toggleFilter(e,n)},this.addEntityFilter=function(t){t.preventDefault();var e=$(t.currentTarget).attr("data-facet"),n=$(t.currentTarget).attr("data-value");this.controller.searchQuery.toggleFilter(e,n)},this.showLoading=function(){this.loading=!0,$(".progress-bar").removeClass("done loading").show(),$("#facets").addClass("disabled"),i.delay(function(){$(".progress-bar").addClass("loading")},10)},this.hideLoading=function(){$(this.loadingEl).hide(),this.loading=!1,$("#facets").removeClass("disabled"),$(".progress-bar").addClass("done"),i.delay(function(){$(".progress-bar").hide()},1e3)},this.afterTransition=function(t,e){"main"===e.id&&(i.isEqual(e.searchQuery,t.searchQuery)||(this.renderSearchResult(),this.hideLoading()))},this.renderPreview=function(){var t=this.controller.previewData,e=t.document.id;if(this.controller.previewData){var n=new a(t);this.$(".document").each(function(){e===this.dataset.id&&this.appendChild(n.render().el)})}},this.renderDetails=function(){console.log("rendering modal...");var t=o(".body",{children:[o(".header.toolbar.clearfix.menubar.fill-light",{html:'<div class="title float-left large">Details</div><div class="menu-group small"></div><button class="button toggle-details float-right"><i class="fa fa-close"></i></button>'}),o(".content",{text:"DETAIL_VIEW CONTENT GOES HERE"})]});this.modalEl.appendChild(t)},this.renderFacets=function(){var t=this.controller.state.searchQuery.filters.subjects||[];React.render(React.createElement(l,{selectedNodes:t,tree:this.controller.searchResult.subjects.getTree(),counts:this.controller.searchResult.getFacetCounts("subjects"),onSelectionChanged:function(t){var e=Object.keys(t);console.log("selected nodes",e),this.controller.searchQuery.setFilter("subjects",e)}.bind(this)}),this.facetsEl)},this.getName=function(t){return this.controller.getName(t)},this.renderSearchResult=function(){var t=this.controller.state.searchQuery,e=this.controller.searchResult,n=t.searchStr;t.filters;if(this.controller.searchResult){this.documentsEl.innerHTML="";var r=e.getDocuments(),s=e.getSearchMetrics(),l=window.storage||window.localStorage,u=l.getItem("locale")||"ru",h=[];if(i.each(e.rawResult.suggestedEntities,function(t,e){var n=o("span.entity",{text:t.name});$(n).click(function(){window.location.href="/resources/"+e+window.location.hash}),h.push(n)}),h.length>0){var f=o(".suggested",{text:i18n.t("browser.entity_suggestion"),children:h});this.documentsEl.className="has-suggestions",0==r.length&&(this.documentsEl.className="no-results"),this.documentsEl.appendChild(f)}else this.documentsEl.className="",0==r.length&&(this.documentsEl.className="no-results");r.length>0?(this.documentsEl.appendChild(o(".stats",{text:s.hits+" "+i18n.t("browser.found")})),i.each(r,function(t,r){var s=o(".filters");i.each(t.facets,function(e,n){i.each(e,function(e,n){var i=o(".filter",{children:[o("a",{href:"/documents/"+t.id+"#contextId=subjects;subjectId="+n,target:"_blank",text:this.getName(n)+" ("+e+")"})]});s.appendChild(i)},this)},this),i.each(t.suggestedEntities,function(t,n){if(!e.isSelected("entities",n)){var i=o(".filter",{children:[o("i.fa.fa-square-o"),o("a",{"data-facet":"entities","data-value":n,href:"#",text:t.name})]});s.appendChild(i)}});var l;"en"==u||"de"==u?l=t.summary_en:"ru"==u&&(l=t.summary);var h="video"===t.record_type?"fa-video-camera":"fa-volume-up",f=[o(".meta-info",{children:[o(".project",{text:t.project_name+" "}),o(".length",{text:t.interview_duration+" "+i18n.t("browser.minutes")+" "}),o(".date",{text:c.formatDate(t.interview_date)}),o(".source-type",{children:[o("i",{"class":"fa "+h})]})]}),o(".title",{children:[o("a",{href:"/documents/"+t.id,target:"_blank",html:t.title})]})],d=t.interviewee_photo,p=d?window.mediaServer+"/photos/"+t.interviewee_photo:window.mediaServer+"/photos/default.png";f.unshift(o(".photo",{style:"background-image: url("+p+")"})),l&&f.push(o(".intro",{html:l})),s.childNodes.length>0&&f.push(s);var g=o(".document",{"data-id":t.id,children:f});if(t.fragments){var v=new a({document:t,fragments:t.fragments,searchStr:n});g.appendChild(v.render().el)}this.documentsEl.appendChild(g)},this)):this.documentsEl.appendChild(o(".stats",{text:i18n.t("browser.no_results")})),this.renderFacets(),this.searchbarView.renderFilters()}},this.toggleDetails=function(t){console.log("TOGGLING",t.currentTarget),t.preventDefault(),$(this.modalEl).hasClass("hidden")?(this.renderDetails(),$(this.modalEl).removeClass("hidden")):$(this.modalEl).addClass("hidden")},this.render=function(){return this.el.innerHTML="",this.el.appendChild(this.searchbarView.render().el),this.el.appendChild(this.panelWrapperEl),this.el.appendChild(this.progressbarEl),this.el.appendChild(this.modalEl),this},this.dispose=function(){this.stopListening(),this.mainView&&this.mainView.dispose()}},u.Prototype.prototype=r.prototype,u.prototype=new u.Prototype,e.exports=u},{"../shared/components/tree":128,"./preview_view":7,"./searchbar_view":10,"./util":11,"substance-application":250,"substance/helpers":27}],6:[function(t,e,n){e.exports=t("./archivist_browser")},{"./archivist_browser":1}],7:[function(t,e,n){"use strict";var i=t("underscore"),r=t("substance-application").View,o=t("substance-application").$$,s=function(t,e){r.call(this),this.model=t,this.$el.addClass("preview")};s.Prototype=function(){this.render=function(){return this.renderPreview(),this},this.renderPreview=function(){this.el.innerHTML="";var t=o(".fragments");i.each(this.model.fragments,function(e){t.appendChild(o(".fragment",{children:[o(".separator"),o(".content",{html:e.content})]}))},this),this.el.appendChild(t)},this.dispose=function(){this.stopListening()}},s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,e.exports=s},{"substance-application":250,underscore:268}],8:[function(t,e,n){var i=t("underscore"),r=t("substance-util"),o=function(t,e){this.searchStr=t.searchStr,this.filters=t.filters};o.Prototype=function(){this.addFilter=function(t,e){this.filters[t]||(this.filters[t]=[]),this.filters[t].push(e),this.trigger("query:changed")},this.setFilter=function(t,e){this.filters[t]=e,this.trigger("query:changed")},this.removeFilter=function(t,e){var n=this.filters[t];this.filters[t]=i.without(n,e),0===n.length&&delete this.filters[t],this.trigger("query:changed")},this.clearFilters=function(){this.filters={},this.trigger("query:changed")},this.hasFilter=function(t,e){var n=this.filters[t];return!!n&&n.indexOf(e)>=0},this.toggleFilter=function(t,e){this.hasFilter(t,e)?this.removeFilter(t,e):this.addFilter(t,e)},this.removeLastFilter=function(){console.log("TODO: Implement.")},this.updateSearchStr=function(t){this.searchStr=t,this.trigger("query:changed")},this.setQuery=function(t){this.searchStr=t.searchStr,this.filters=t.filters},this.toJSON=function(){return{searchStr:this.searchStr,filters:this.filters}}},o.Prototype.prototype=r.Events,o.prototype=new o.Prototype,e.exports=o},{"substance-util":259,underscore:268}],9:[function(t,e,n){var i=(t("underscore"),function(t){this.rawResult=t.result,this.searchQuery=t.searchQuery});i.Prototype=function(){this.getSearchMetrics=function(){return{hits:this.rawResult.count}},this.getDocuments=function(){return this.rawResult.interviews},this.getFacetCounts=function(t){return this.rawResult.facets[t]},this.getFacets=function(){return this.rawResult.facets},this.isSelected=function(t,e){var n=this.searchQuery.filters[t];return!!n&&n.indexOf(e)>=0},this.getNameForFilterValue=function(t){var e=this.subjects.get(t);if(e)return e.name}},i.prototype=new i.Prototype,e.exports=i},{underscore:268}],10:[function(t,e,n){"use strict";var i=t("underscore"),r=t("substance-application").View,o=t("substance-application").$$,s={subjects:"fa-tags",article_type:"fa-align-left",organisms:"fa-leaf"},a=function(t,e){r.call(this),this.controller=t,this.searchQuery=t.searchQuery,this.options=e,this.$el.addClass("searchbar"),this.searchFieldEl=o(".search-field"),this.searchFieldFilters=o(".search-field-filters"),this.searchFieldEl.appendChild(this.searchFieldFilters),this.searchFieldInputEl=o("input.search-field-input",{type:"text",placeholder:i18n.t("browser.search_placeholder")}),this.searchFieldEl.appendChild(this.searchFieldInputEl),this.searchButton=o("a.search-button",{href:"#",text:i18n.t("browser.search_button")}),this.searchFieldEl.appendChild(this.searchButton),this.searchFieldSuggestionsEl=o(".search-field-suggestions"),$(this.searchFieldSuggestionsEl).hide(),this.searchFieldEl.appendChild(this.searchFieldSuggestionsEl),this.el.appendChild(this.searchFieldEl),$(this.searchFieldInputEl).keyup(i.bind(this._updateSuggestions,this)),$(this.searchFieldInputEl).keydown(i.bind(this._interpretKey,this)),$(this.searchFieldInputEl).blur(i.bind(this._hideSuggestions,this)),$(this.el).click(i.bind(this._hideSuggestions,this)),this.$el.on("click",".search-field-suggestion",i.bind(this._useKeyword,this)),this.$el.on("click",".remove-filter",i.bind(this._removeFilter,this)),this.$el.on("click",".clear-filters",i.bind(this._clearFilters,this)),$(this.searchFieldInputEl).change(i.bind(this._updateSearchStr,this)),this.searchQuery.on("query:changed",i.bind(this.updateView,this))};a.Prototype=function(){this._updateSearchStr=function(t){var e=$(this.searchFieldInputEl).val();this.searchQuery.updateSearchStr(e),t.preventDefault()},this._removeFilter=function(t){t.preventDefault();var e=$(t.currentTarget).attr("data-facet"),n=$(t.currentTarget).attr("data-value");this.searchQuery.removeFilter(e,n)},this._clearFilters=function(t){t.preventDefault(),this.searchQuery.clearFilters()},this._interpretKey=function(t){$(t.currentTarget).val();40===t.keyCode?(this.nextSuggestion(),t.preventDefault()):38===t.keyCode?(this.prevSuggestion(),t.preventDefault()):13===t.keyCode&&this.chooseSuggestion()},this._updateSuggestions=function(t){var e=$(t.currentTarget).val();i.include([40,38,13],t.keyCode)||this.renderSuggestions(e)},this._hideSuggestions=function(t){var e=this.searchFieldSuggestionsEl;i.delay(function(){$(e).hide()},200,this)},this._useKeyword=function(t){var e=$(t.currentTarget),n=e.attr("data-value");this._hideSuggestions(),$(this.searchFieldInputEl).val(n).focus(),this._updateSearchStr(t),t.preventDefault()},this.chooseSuggestion=function(){var t=this.$(".search-field-suggestion.active");t.length>0?t.trigger("click"):this._hideSuggestions()},this.render=function(){return this.updateView(),this},this.renderFilters=function(){this.searchFieldFilters.innerHTML="";var t=0;if(i.each(this.searchQuery.filters,function(e,n){i.each(e,function(e){var n=o(".search-field-filter",{html:this.controller.getName(e)});t<3&&this.searchFieldFilters.appendChild(n),t+=1},this)},this),t>3){var e=o(".search-field-filter",{text:"and "+(t-3)+" more"});this.searchFieldFilters.appendChild(e)}if(t>0){var n=o(".search-field-filter",{children:[o("a.clear-filters",{href:"#",text:i18n.t("browser.clear_filters")})]});this.searchFieldFilters.appendChild(n)}},this.updateView=function(){$(this.searchFieldInputEl).val(this.searchQuery.searchStr)},this.prevSuggestion=function(){var t=this.searchFieldSuggestionsEl.childNodes;if(t.length>0){var e=this.$(".search-field-suggestion.active");0===e.length?$(i.last(t)).addClass("active"):(e.removeClass("active"),e.prev().addClass("active"))}},this.nextSuggestion=function(){var t=this.searchFieldSuggestionsEl.childNodes;if(t.length>0){var e=this.$(".search-field-suggestion.active");0===e.length?$(t[0]).addClass("active"):(e.removeClass("active"),e.next().addClass("active"))}},this.renderSuggestions=function(t){var e=this.options.getSuggestions(t);return 0===e.length?void $(this.searchFieldSuggestionsEl).hide():(this.searchFieldSuggestionsEl.innerHTML="",i.each(e,function(t){var e=o("a.search-field-suggestion",{html:'<i class="fa '+s[t.facet]+'"></i> '+t.value,href:"#","data-value":t.rawValue,"data-facet":t.facet});this.searchFieldSuggestionsEl.appendChild(e)},this),void $(this.searchFieldSuggestionsEl).show())},this.dispose=function(){this.stopListening()}},a.Prototype.prototype=r.prototype,a.prototype=new a.Prototype,e.exports=a},{"substance-application":250,underscore:268}],11:[function(t,e,n){var i={1:"January",2:"February",3:"March",4:"April",5:"May",6:"June",7:"July",8:"August",9:"September",10:"October",11:"November",12:"December"},r=function(t){var e=t.getDate(),n=e.toString();return n.length>1?n:n+"0"},o=function(t){var e=t.getMonth(),n=(e+1).toString();return n.length>1?n:"0"+n},s={};s.formatDate=function(t){if(!t)return"N/A";var e=t.split("-");if(e.length>=3){var n=new Date(e[0],e[1]-1,e[2]),s=r(n)+"."+o(n)+"."+n.getFullYear();return s}if(2===e.length){var a=e[1].replace(/^0/,""),c=e[0];return i[a]+" "+c}return c},e.exports=s},{}],12:[function(t,e,n){e.exports={Substance:t("substance")}},{substance:28}],13:[function(t,e,n){var i=(t("substance"),t("substance/helpers")),r=function(t){this.entities={},this.byType={person:[],prison:[],toponym:[],definition:[]},i.each(t,function(t){this.entities[t.id]=t,this.byType[t.type].push(t)},this)};r.prototype.getEntity=function(t){return this.entities[t]},r.prototype.getEntities=function(t){return t?void this.findByType(t):i.map(this.entities)},r.prototype.findByType=function(t){return this.byType[t]},e.exports=r},{substance:28,"substance/helpers":27}],14:[function(t,e,n){var i=t("./interview"),r=t("./subjects_model"),o=t("./entities_model");i.SubjectsModel=r,i.EntitiesModel=o,e.exports=i},{"./entities_model":13,"./interview":15,"./subjects_model":25}],15:[function(t,e,n){"use strict";var i=t("substance"),r=i.Document,o=t("./nodes/document_node"),s=r.Paragraph,a=t("./nodes/text_node"),c=r.Emphasis,l=r.Strong,u=t("./nodes/remark"),h=t("./nodes/comment"),f=t("./nodes/reply"),d=t("./nodes/timecode"),p=t("./nodes/subject_reference"),g=t("./nodes/entity_reference"),v=t("./nodes/waypoint"),y=new r.Schema("archivist-interview","0.2.0");y.getDefaultTextType=function(){return"paragraph"},y.addNodes([o,a,s,c,l,u,h,f,d,p,g,v]);var m=function(){m["super"].call(this,y)};m.Prototype=function(){this.initialize=function(){this["super"].initialize.apply(this,arguments),this.create({type:"container",id:"content",nodes:[]}),this.entityReferencesIndex=this.addIndex("entityReferencesIndex",i.Data.Index.create({type:"entity_reference",property:"target"})),this.remarksIndex=this.addIndex("remarksIndex",i.Data.Index.create({type:"remark",property:"id"})),this.commentsIndex=this.addIndex("commentsIndex",i.Data.Index.create({type:"comment",property:"id"})),this.subjectReferencesIndex=this.addIndex("subjectReferencesIndex",i.Data.Index.create({type:"subject_reference",property:"target"}))},this.documentDidLoad=function(){m["super"].prototype.documentDidLoad.call(this)},this.toXml=function(){}},i.inherit(m,r),m.schema=y,m.fromJson=function(t){var e=new m;return e.loadSeed(t),e},m.fromXml=function(t){},m.HtmlExporter=i.Document.HtmlExporter,e.exports=m},{"./nodes/comment":16,"./nodes/document_node":17,"./nodes/entity_reference":18,"./nodes/remark":19,"./nodes/reply":20,"./nodes/subject_reference":21,"./nodes/text_node":22,"./nodes/timecode":23,"./nodes/waypoint":24,substance:28}],16:[function(t,e,n){var i=t("substance").Document.ContainerAnnotation,r=i.extend({name:"comment",properties:{content:"string",creator:"string",created_at:"date",replies:["array","id"]}});e.exports=r},{substance:28}],17:[function(t,e,n){var i=t("substance"),r=i.Document.Node.extend({name:"document",properties:{guid:"string",creator:"string",title:"string",short_summary:"string",short_summary_en:"string","abstract":"string",abstract_en:"string",abstract_de:"string",created_at:"string",updated_at:"string",published_on:"string",project_name:"string",project_location:"string",conductor:"string",operator:"string",sound_operator:"string",record_type:"string",media_id:"string",interview_location:"string",interview_date:"string",persons_present:"string",interview_duration:"number",interviewee_bio:"string",interviewee_bio_en:"string",interviewee_bio_de:"string",interviewee_category:"string",interviewee_forced_labor_type:"string",interviewee_photo:"string",interviewee_waypoints:["array","waypoint"],transcripted:"boolean",verified:"boolean",finished:"boolean",published:"boolean"},getWaypoints:function(){return this.interviewee_waypoints.map(function(t){return this.getDocument().get(t)}.bind(this))}});e.exports=r},{substance:28}],18:[function(t,e,n){var i=t("substance").Document,r=i.Annotation.extend({name:"entity_reference",properties:{target:"string"}});e.exports=r},{substance:28}],19:[function(t,e,n){var i=t("substance").Document.ContainerAnnotation,r=i.extend({name:"remark",properties:{content:"string"}});e.exports=r},{substance:28}],20:[function(t,e,n){var i=t("substance").Document.ContainerAnnotation,r=i.extend({name:"reply",properties:{content:"string"}});e.exports=r},{substance:28}],21:[function(t,e,n){var i=t("substance").Document.ContainerAnnotation,r=i.extend({name:"subject_reference",properties:{target:["array","string"]}});e.exports=r},{substance:28}],22:[function(t,e,n){var i=t("substance"),r=i.Document,o=r.TextNode.extend({name:"text"});o["static"].blockType=!0,o["static"].fromHtml=function(t,e){var n=e.defaultId(t,"p"),i={id:n,content:""};return i.content=e.annotatedText(t,[n,"content"]),i},o["static"].toHtml=function(t,e){var n=t.id,i=$("<p>").attr("id",n);return i.append(e.annotatedText([n,"content"])),i},e.exports=o},{substance:28}],23:[function(t,e,n){var i=t("substance"),r=i.Document.Annotation.extend({name:"timecode"});e.exports=r},{substance:28}],24:[function(t,e,n){var i=t("substance"),r=i.Document.Node.extend({name:"waypoint",properties:{entityId:"string",density:"string"}});e.exports=r},{substance:28}],25:[function(t,e,n){var i=t("./tree"),r=t("substance"),o=t("substance/helpers"),s=function(t,e){this.doc=t,this.subjects={},r.each(e,function(e){if(this.subjects[e.id]=e,t){var n=t.subjectReferencesIndex.get(e.id);this.subjects[e.id].references=r._.pluck(n,"id")}},this),this.tree=new i(this.subjects)};s.prototype.get=function(t){return this.subjects[t]},s.prototype.getTree=function(){function t(n){var i=[],o=e.getChildren(n);return 0===o.length?i:(r.each(o,function(e){var n={id:e.id,text:e.name,children:t(e.id)};i.push(n)}),i)}var e=this.tree;return t("root")},s.prototype.getAllReferencedSubjects=function(){var t=this.doc,e=t.subjectReferencesIndex.get(),n=[];return r.each(e,function(t){r.each(t.target,function(t){var e=this.tree.get(t);r.includes(n,e)||(void 0===e?console.log("You have outdated subjects in this interview"):n.push(e))},this)},this),n},s.prototype.getTree=function(){return this.tree},s.prototype.getReferencedSubjectsTree=function(){var t=this.getAllReferencedSubjectsWithParents(),e=new s(this.doc,t);return e.tree},s.prototype.getFullPathForSubject=function(t){function e(t){var r=n.get(t),o=n.getParent(t);return o&&e(o.id),i.push(r.name),i}var n=this.tree,i=[];return e(t)},s.prototype.getReferencesForSubject=function(t){var e=this.getReferencedSubjectsTree(),n=e.getAllChildren(t).concat(t),i=this.doc,r=[];return o.each(n,function(t){r=r.concat(Object.keys(i.subjectReferencesIndex.get(t)))}),o.uniq(r)},s.prototype.getAllReferencedSubjectsWithParents=function(){function t(e){var r=i.get(e),o=i.getParent(e);o&&t(o.id),n.push(r)}var e=this.getAllReferencedSubjects(),n=r.clone(e),i=this.tree;return r.each(e,function(e){t(e.id)}),n=r.uniq(n)},e.exports=s},{"./tree":26,substance:28,"substance/helpers":27}],26:[function(t,e,n){var i=t("substance"),r=t("substance/helpers"),o=function(t){this.nodes=t,this.buildIndexes()};o.Prototype=function(){this.buildIndexes=function(){this.parentIndex={},r.each(this.nodes,function(t){var e=t.parent||"root";this.parentIndex[e]?this.parentIndex[e].push(t):this.parentIndex[e]=[t]},this),r.each(this.parentIndex,function(t,e){this.parentIndex[e]=r.sortBy(t,function(t){return t.position})},this)},this.get=function(t){return this.nodes[t]},this.getChildren=function(t){return this.parentIndex[t]||[]},this.getParent=function(t){var e=this.nodes[t];return this.nodes[e.parent]},this.getParents=function(t){for(var e=this.get(t),n=[];e=this.getParent(e.id);)n.push(e.id);return n},this.getAllChildren=function(t){var e=this.getChildren(t);if(0===e.length)return[];var n=r.pluck(e,"id");return r.each(e,function(t){n=n.concat(this.getAllChildren(t.id))},this),n},this.walkTree=function(t,e){function n(t,e,o){"root"!==t&&e.call(o,t);r.getChildren(t.id);i.each(r.getChildren(t.id||t),function(t){n(t,e,o)})}var r=this;return e||(e=this),n("root",t,e)}},o.prototype=new o.Prototype,e.exports=o},{substance:28,"substance/helpers":27}],27:[function(t,e,n){e.exports=t("./src/basics/helpers")},{"./src/basics/helpers":32}],28:[function(t,e,n){var i=t("./src/basics");i.Data=t("./src/data"),i.Document=t("./src/document"),i.Operator=t("./src/operator"),i.Surface=t("./src/surface"),i._=t("./src/basics/helpers"),e.exports=i},{"./src/basics":33,"./src/basics/helpers":32,"./src/data":40,"./src/document":63,"./src/operator":98,"./src/surface":107}],29:[function(t,e,n){"use strict";function i(){Error.apply(this,arguments)}var r=t("./oo");r.inherit(i,Error),e.exports=i},{"./oo":34}],30:[function(t,e,n){"use strict";function i(){this.__events__={}}var r=t("./oo");i.Prototype=function(){function t(t,e){if("string"==typeof t){if(void 0===e||null===e)throw new Error('Method name "'+t+'" has no context.');if(!(t in e))throw new Error('Method not found: "'+t+'"');if("function"!=typeof e[t])throw new Error('Property "'+t+'" is not a function')}else if("function"!=typeof t)throw new Error("Invalid callback. Function or method name expected.")}function e(t,e){return e.priority-t.priority}this._on=function(e,n,i,r){var o;return t(n,i),o=this.__events__.hasOwnProperty(e)?this.__events__[e]:this.__events__[e]=[],o.push({method:n,context:i||null,priority:r}),this},this._off=function(e,n,i){var r,o;if(1===arguments.length)return delete this.__events__[e],this;if(t(n,i),!(e in this.__events__&&this.__events__[e].length))return this;for(arguments.length<3&&(i=null),o=this.__events__[e],r=o.length;r--;)o[r].method===n&&o[r].context===i&&o.splice(r,1);return 0===o.length&&delete this.__events__[e],this},this.emit=function(t){if(t in this.__events__){for(var e=this.__events__[t].slice(),n=Array.prototype.slice.call(arguments,1),i=0,r=e.length;i<r;i++){var o=e[i];o.method.apply(o.context,n)}return!0}return!1},this.connect=function(t,n,i){var r=0;3===arguments.length&&(r=i.priority||r);for(var o in n){var s=n[o];this._on(o,s,t,r)}return this.__events__[o].sort(e),this},this.on=function(t,n,i,r){var o=0;3===arguments.length&&(o=r.priority||o),this._on(t,n,i,o),this.__events__[t].sort(e)},this.disconnect=function(t){var e,n,i;for(n in this.__events__)for(i=this.__events__[n],e=i.length;e--;)i[e]&&i[e].context===t&&this._off(n,i[e].method,t);return this}},r.initClass(i),e.exports=i},{"./oo":34}],31:[function(t,e,n){"use strict";function i(){i["super"].call(this)}var r=t("./oo"),o=t("./registry");i.Prototype=function(){this.create=function(t){var e=this.get(t);if(!e)throw new Error("No class registered by that name: "+t);var n=Array.prototype.slice.call(arguments,1),i=Object.create(e.prototype);return e.apply(i,n),i}},r.inherit(i,o),e.exports=i},{"./oo":34,"./registry":36}],32:[function(t,e,n){"use strict";var i={};i.isEqual=t("lodash/lang/isEqual"),i.isObject=t("lodash/lang/isObject"),i.isArray=t("lodash/lang/isArray"),i.isString=t("lodash/lang/isString"),i.isNumber=t("lodash/lang/isNumber"),i.isBoolean=t("lodash/lang/isBoolean"),i.isFunction=t("lodash/lang/isFunction"),i.cloneDeep=t("lodash/lang/cloneDeep"),i.clone=t("lodash/lang/clone"),i.isEmpty=t("lodash/lang/isEmpty"),i.bind=t("lodash/function/bind"),i.delay=t("lodash/function/delay"),i.debounce=t("lodash/function/debounce"),i.extend=t("lodash/object/extend"),i.omit=t("lodash/object/omit"),i.last=t("lodash/array/last"),i.first=t("lodash/array/first"),i.compact=t("lodash/array/compact"),i.uniq=t("lodash/array/uniq"),i.intersection=t("lodash/array/intersection"),i.union=t("lodash/array/union"),i.without=t("lodash/array/without"),i.each=t("lodash/collection/forEach"),i.filter=t("lodash/collection/filter"),i.includes=t("lodash/collection/includes"),i.find=t("lodash/collection/find"),i.map=t("lodash/collection/map"),i.pluck=t("lodash/collection/pluck"),i.indexBy=t("lodash/collection/indexBy"),i.sortBy=t("lodash/collection/sortBy"),i.isArrayEqual=function(t,e){if(t===e)return!0;if(null===t||null===e)return!1;if(t.length!=e.length)return!1;for(var n=0;n<t.length;++n)if(t[n]!==e[n])return!1;return!0},i.deleteFromArray=function(t,e){for(var n=0;n<t.length;n++)t[n]===e&&(t.splice(n,1),n--)},i.deepclone=function(t){return null===t||void 0===t?t:i.isFunction(t.clone)?t.clone():i.deepclone(t)},i.deepclone=i.cloneDeep,i.getRelativeOffset=function(t,e){var n=t.offset(),i=e.offset();return n.left-=i.left,n.top-=i.top,n},i.uuid=function(t,e){t&&"_"!==t[t.length-1]&&(t=t.concat("_"));var n,i="0123456789abcdefghijklmnopqrstuvwxyz".split(""),r=[],o=16;if(e=e||32)for(n=0;n<e;n++)r[n]=i[0|Math.random()*o];else{var s;for(r[8]=r[13]=r[18]=r[23]="-",r[14]="4",n=0;n<36;n++)r[n]||(s=0|16*Math.random(),r[n]=i[19==n?3&s|8:s])}return(t?t:"")+r.join("")},e.exports=i},{"lodash/array/compact":130,"lodash/array/first":132,"lodash/array/intersection":133,"lodash/array/last":134,"lodash/array/union":135,"lodash/array/uniq":136,"lodash/array/without":137,"lodash/collection/filter":138,"lodash/collection/find":139,"lodash/collection/forEach":140,"lodash/collection/includes":141,"lodash/collection/indexBy":142,"lodash/collection/map":143,"lodash/collection/pluck":144,"lodash/collection/sortBy":145,"lodash/function/bind":147,"lodash/function/debounce":148,"lodash/function/delay":149,"lodash/lang/clone":224,"lodash/lang/cloneDeep":225,"lodash/lang/isArray":227,"lodash/lang/isBoolean":228,"lodash/lang/isEmpty":229,"lodash/lang/isEqual":230,"lodash/lang/isFunction":231,"lodash/lang/isNumber":233,"lodash/lang/isObject":234,"lodash/lang/isString":235,"lodash/object/extend":238,"lodash/object/omit":241}],33:[function(t,e,n){"use strict";var i=t("./helpers"),r={};i.extend(r,t("./helpers")),i.extend(r,t("./oo")),r.PathAdapter=t("./path_adapter"),r.EventEmitter=t("./event_emitter"),r.Error=t("./error"),r.Registry=t("./registry"),r.Factory=t("./factory"),i.extend(r,t("./tic")),e.exports=r},{"./error":29,"./event_emitter":30,"./factory":31,"./helpers":32,"./oo":34,"./path_adapter":35,"./registry":36,"./tic":37}],34:[function(t,e,n){"use strict";var i=t("./helpers"),r={},o=function(t,e){var n=function(){t.apply(this,arguments),this.init&&this.init.apply(this,arguments)};r.inherit(n,t);for(var i in e)if(e.hasOwnProperty(i)){
if("name"===i)continue;n.prototype[i]=e[i]}return n["static"].name=e.name,n};r.initClass=function(t){!t.Prototype||t.prototype instanceof t.Prototype||(t.prototype=new t.Prototype,t.prototype.constructor=t),t["static"]=t["static"]||{},t.extend=t.extend||i.bind(o,null,t)},r.inherit=function(t,e){if(t.prototype instanceof e)throw new Error("Target already inherits from origin");var n=t.prototype.constructor,s=t.Prototype;t["super"]=e,s?(s.prototype=e.prototype,t.prototype=new s,t.prototype.constructor=t):t.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),t.prototype["super"]=e.prototype,r.initClass(e),t["static"]=Object.create(e["static"]),t.extend=i.bind(o,null,t)},r.mixin=function(t,e){var n,i=e.prototype;e.Prototype&&(i=new e.Prototype);for(n in i)"constructor"!==n&&i.hasOwnProperty(n)&&(t.prototype[n]=i[n]);if(r.initClass(t),e["static"])for(n in e["static"])e["static"].hasOwnProperty(n)&&(t["static"][n]=e["static"][n]);else r.initClass(e)},e.exports=r},{"./helpers":32}],35:[function(t,e,n){"use strict";function i(t){t&&(this.root=t)}var r=t("./helpers"),o=t("./oo");i.Prototype=function(){this.childrenScope=!1,this.getRoot=function(){return this.root||this},this._resolve=function(t,e){for(var n=t.length-1,i=this.getRoot(),r=0;r<n;r++){var o=t[r];if(void 0===i[o]){if(!e)return;i[o]={},this.childrenScope&&(i[o].children={})}i=i[o],this.childrenScope&&(i=i.children)}return i},this.get=function(t){if(r.isString(t))return this[t];if(t&&0!==t.length){var e=t[t.length-1],n=this._resolve(t);return n?n[e]:void 0}return this.getRoot()},this.set=function(t,e){if(r.isString(t))this[t]=e;else{var n=t[t.length-1];this._resolve(t,!0)[n]=e}},this["delete"]=function(t,e){if(r.isString(t))delete this[t];else{var n=t[t.length-1],i=this._resolve(t);if(e&&!i||!i[n])throw new Error("Invalid path.");delete i[n]}},this.clear=function(){var t=this.getRoot();for(var e in t)t.hasOwnProperty(e)&&delete t[e]},this._traverse=function(t,e,n,i){for(var r in t)if(t.hasOwnProperty(r)&&"__values__"!==r){var o=e.concat([r]);n.call(i,o,t[r]),this._traverse(t[r],o,n,i)}},this.traverse=function(t,e){this._traverse(this.getRoot(),[],t,e)}},o.initClass(i),i.Arrays=function(){i.apply(this,arguments)},i.Arrays.Prototype=function(){this.get=function(t){if(r.isString(t))return this[t];if(t&&0!==t.length){var e=t[t.length-1],n=this._resolve(t);return n&&n[e]?n[e].__values__:void 0}return this.getRoot()},this.add=function(t,e){var n=t[t.length-1],i=this._resolve(t,!0);i[n]||(i[n]={__values__:[]});var r=i[n].__values__;r.push(e)},this.remove=function(t,e){var n=this.get(t);n?r.deleteFromArray(n,e):console.warn("Warning: trying to remove a value for an unknown path.",t,e)},this.removeAll=function(t){var e=this.get(t);e.splice(0,e.length)},this.set=function(){throw new Error("This method is not available for PathAdapter.Arrays")},this._traverse=function(t,e,n,i){for(var r in t)if(t.hasOwnProperty(r))if("__values__"===r)n.call(i,e,t.__values__);else{var o=e.concat([r]);this._traverse(t[r],o,n,i)}}},o.inherit(i.Arrays,i),e.exports=i},{"./helpers":32,"./oo":34}],36:[function(t,e,n){"use strict";function i(){this.entries={},this.names=[]}var r=t("./oo");i.Prototype=function(){this.contains=function(t){return!!this.entries[t]},this.add=function(t,e){this.contains(t)&&this.remove(t),this.entries[t]=e,this.names.push(t)},this.remove=function(t){var e=this.names.indexOf(t);e>=0&&this.names.splice(e,1),delete this.entries[t]},this.clear=function(){this.names=[],this.entries=[]},this.get=function(t){var e=this.entries[t];return e||console.error("No entry with name",t),e},this.each=function(t,e){for(var n=0;n<this.names.length;n++){var i=this.names[n],r=t.call(e,this.entries[i],i);if(r===!1)break}}},r.initClass(i),e.exports=i},{"./oo":34}],37:[function(t,e,n){"use strict";var i=Date.now();e.exports={tic:function(){i=Date.now()},toc:function(){return Date.now()-i}}},{}],38:[function(t,e,n){"use strict";function i(t,e){a.call(this),this.schema=t,this.nodes=new s,this.indexes={},e=e||{},this.didCreateNode=e.didCreateNode||function(){},this.didDeleteNode=e.didDeleteNode||function(){}}var r=t("../basics/helpers"),o=t("../basics"),s=o.PathAdapter,a=o.EventEmitter;i.Prototype=function(){this.get=function(t){if(!t)throw new Error("Path or id required");return this.nodes.get(t)},this.getNodes=function(){return this.nodes},this.create=function(t){var e=this.schema.getNodeFactory().create(t.type,t);if(!e)throw new Error("Illegal argument: could not create node for data:",t);if(this.contains(e.id))throw new Error("Node already exists: "+e.id);if(!e.id||!e.type)throw new Error("Node id and type are mandatory.");return this.nodes[e.id]=e,r.each(this.indexes,function(t){t.select(e)&&t.create(e)}),this.didCreateNode(e),e},this["delete"]=function(t){var e=this.nodes[t];return delete this.nodes[t],this.didDeleteNode(e),r.each(this.indexes,function(t){t.select(e)&&t["delete"](e)}),e},this.set=function(t,e){var n=this.get(t[0]),i=this.nodes.get(t);return this.nodes.set(t,e),r.each(this.indexes,function(r){r.select(n)&&r.update(n,t,e,i)}),i},this.update=function(t,e){var n,i=this.nodes.get(t);if(e.isOperation)n=e.apply(i);else{var o,s,a,c;if(r.isString(i))if(e["delete"])o=e["delete"].start,s=e["delete"].end,n=i.split("").splice(o,s-o).join("");else{if(!e.insert)throw new Error("Diff is not supported:",JSON.stringify(e));a=e.insert.offset,c=e.insert.value,n=[i.substring(0,a),c,i.substring(a)].join("")}else{if(!r.isArray(i))throw new Error("Diff is not supported:",JSON.stringify(e));if(n=i.slice(0),e["delete"])a=e["delete"].offset,n.splice(a,1);else{if(!e.insert)throw new Error("Diff is not supported:",JSON.stringify(e));a=e.insert.offset,c=e.insert.value,n.splice(a,0,c)}}}this.nodes.set(t,n);var l=this.get(t[0]);return r.each(this.indexes,function(e){e.select(l)&&e.update(l,t,i,n)}),i},this.toJSON=function(){return{schema:[this.schema.id,this.schema.version],nodes:r.deepclone(this.nodes)}},this.contains=function(t){return!!this.nodes[t]},this.reset=function(){this.nodes=new s},this.addIndex=function(t,e){return this.indexes[t]&&console.error("Index with name %s already exists.",t),e.reset(this),this.indexes[t]=e,e},this.getIndex=function(t){return this.indexes[t]}},o.inherit(i,a),e.exports=i},{"../basics":33,"../basics/helpers":32}],39:[function(t,e,n){"use strict";var i=t("../basics/oo"),r=t("../basics/helpers"),o=t("./data"),s=t("../operator"),a=s.ObjectOperation,c=s.ArrayOperation,l=s.TextOperation,u=function(t,e){u["super"].call(this,t,e)};u.Prototype=function(){this.create=function(t){var e=a.Create([t.id],t);return this.apply(e),e},this["delete"]=function(t){var e=null,n=this.get(t);if(n){var i=n.toJSON();e=a.Delete([t],i),this.apply(e)}return e},this.update=function(t,e){var n=this._getDiffOp(t,e),i=a.Update(t,n);return this.apply(i),i},this.set=function(t,e){var n=this.get(t),i=a.Set(t,n,e);return this.apply(i),i},this.apply=function(t){if(t.type!==a.NOP){if(t.type===a.CREATE)this["super"].create.call(this,r.deepclone(t.val));else if(t.type===a.DELETE)this["super"]["delete"].call(this,t.val.id);else if(t.type===a.UPDATE){var e=this.get(t.path),n=t.diff;if("array"===t.propertyType)n instanceof c||(n=c.fromJSON(n)),n.apply(e);else{if("string"!==t.propertyType)throw new Error("Unsupported type for operational update.");n instanceof l||(n=l.fromJSON(n));var i=n.apply(e);this["super"].set.call(this,t.path,i)}}else{if(t.type!==a.SET)throw new Error("Illegal state.");this["super"].set.call(this,t.path,t.val)}this.emit("operation:applied",t,this)}},this._getDiffOp=function(t,e){var n=null;if(e.isOperation)n=e;else{var i,o,s,a,u=this.get(t);if(null===u||void 0===u)throw new Error("Property has not been initialized: "+JSON.stringify(t));r.isString(u)?e["delete"]?(i=e["delete"].start,o=e["delete"].end,n=l.Delete(i,u.substring(i,o))):e.insert&&(s=e.insert.offset,a=e.insert.value,n=l.Insert(s,a)):r.isArray(u)&&(e["delete"]?(s=e["delete"].offset,n=c.Delete(s,u[s])):e.insert&&(s=e.insert.offset,a=e.insert.value,n=c.Insert(s,a)))}if(!n)throw new Error("Unsupported diff: "+JSON.stringify(e));return n}},i.inherit(u,o),e.exports=u},{"../basics/helpers":32,"../basics/oo":34,"../operator":98,"./data":38}],40:[function(t,e,n){"use strict";var i=t("./data");i.Incremental=t("./incremental_data"),i.Node=t("./node"),i.Schema=t("./schema"),i.Index=t("./node_index"),e.exports=i},{"./data":38,"./incremental_data":39,"./node":41,"./node_index":43,"./schema":44}],41:[function(t,e,n){"use strict";function i(t){o.call(this),this.properties=r.extend({},this.getDefaultProperties(),t),this.properties.type=this.constructor["static"].name,this.properties.id=this.properties.id||r.uuid(this.properties.type)}var r=t("../basics"),o=r.EventEmitter;i.Prototype=function(){this.toJSON=function(){return this.properties},this.getDefaultProperties=function(){},this.isInstanceOf=function(t){return i.isInstanceOf(this.constructor,t)},this.getTypeNames=function(){for(var t=[],e=this.constructor["static"];e&&"node"!==e.name;)t.push(e.name),e=Object.getPrototypeOf(e);return t},this.getPropertyType=function(t){var e=this.constructor["static"].schema;return e[t]}},r.inherit(i,o),i["static"].name="node",i["static"].schema={type:"string",id:"string"},i["static"].readOnlyProperties=["type","id"],i.isInstanceOf=function(t,e){for(var n=t["static"];n&&"node"!==n.name;){if(n&&n.name===e)return!0;n=Object.getPrototypeOf(n)}return!1},i["static"].isInstanceOf=i.isInstanceOf;var s,a=function(t,e,n){var i,r;i=function(){return this.properties[e]},r=n?function(){throw new Error("Property "+e+" is readonly!")}:function(t){return this.properties[e]=t,this};var o={get:i,set:r};Object.defineProperty(t,e,o)},c=function(t){var e=t.prototype;if(t["static"].schema)for(var n=Object.keys(t["static"].schema),i=0;i<n.length;i++){var r=n[i];if(!e.hasOwnProperty(r)){var o=t["static"].readOnlyProperties&&t["static"].readOnlyProperties.indexOf(r)>0;a(e,r,o)}}},l=function(t){var e=t["static"].schema,n=Object.getPrototypeOf(t["static"]),i=n.schema;i&&(t["static"].schema=r.extend(Object.create(i),e))},u=function(t){t.extend=r.bind(s,null,t),c(t),l(t),t.type=t["static"].name};s=function(t,e){var n=function(){t.apply(this,arguments),this.init&&this.init.apply(this,arguments)};r.inherit(n,t);for(var i in e)if(e.hasOwnProperty(i)){if("name"===i||"properties"===i)continue;n.prototype[i]=e[i]}return n["static"].name=e.name,n["static"].schema=e.properties,u(n),n},u(i),i.initNodeClass=u,e.exports=i},{"../basics":33}],42:[function(t,e,n){"use strict";function i(){s.call(this)}var r=t("../basics"),o=t("./node"),s=r.Factory;i.Prototype=function(){this.register=function(t){var e=t["static"]&&t["static"].name;if("string"!=typeof e||""===e)throw new Error("Node names must be strings and must not be empty");if(!(t.prototype instanceof o))throw new Error("Nodes must be subclasses of Substance.Data.Node");if(this.contains(e))throw new Error("Node class is already registered: "+e);this.add(e,t)}},r.inherit(i,s),e.exports=i},{"../basics":33,"./node":41}],43:[function(t,e,n){"use strict";var i=t("../basics"),r=i.PathAdapter,o=function(){this.index=new r};o.Prototype=function(){this.reset=function(t){this.index.clear(),this._initialize(t)},this._initialize=function(t){i.each(t.getNodes(),function(t){this.select(t)&&this.create(t)},this)},this.property="id",this.select=function(t){return!this.type||t.isInstanceOf(this.type)},this.get=function(t){return t?this.index.get(t)||{}:this.getAll()},this.getAll=function(){var t={};return i.each(this.index,function(e){i.extend(t,e)}),t},this.create=function(t){var e=t[this.property];i.isArray(e)||(e=[e]),i.each(e,function(e){this.index.set([e,t.id],t)},this)},this["delete"]=function(t){var e=t[this.property];i.isArray(e)||(e=[e]),i.each(e,function(e){this.index["delete"]([e,t.id])},this)},this.update=function(t,e,n,r){if(this.select(t)&&e[1]===this.property){var o=r;i.isArray(o)||(o=[o]),i.each(o,function(e){this.index["delete"]([e,t.id])},this),o=n,i.isArray(o)||(o=[o]),i.each(o,function(e){this.index.set([e,t.id],t)},this)}},this.clone=function(){var t=this.constructor,e=new t;return e}},i.initClass(o),o.create=function(t){var e=i.extend(new o,t);return e.clone=function(){return o.create(t)},e},e.exports=o},{"../basics":33}],44:[function(t,e,n){"use strict";function i(t,e){this.name=t,this.version=e,this.nodeFactory=new a,this.tocTypes=[],this.addNodes(this.getBuiltIns())}var r=t("../basics/helpers"),o=t("../basics/oo"),s=t("./node"),a=t("./node_factory");i.Prototype=function(){function t(t){var e={};return t["static"].hasOwnProperty("schema")&&(e.properties=r.clone(t["static"].schema)),e}this.addNodes=function(t){if(t)for(var e=0;e<t.length;e++){var n=t[e];this.nodeFactory.register(n),n["static"].tocType&&this.tocTypes.push(n["static"].name)}},this.getNodeClass=function(t){return this.nodeFactory.get(t)},this.getNodeFactory=function(){return this.nodeFactory},this.toJSON=function(){var e={id:this.name,version:this.version,types:{}};return this.nodeFactory.each(function(n,i){e.types[i]=t(n)}),e},this.createNode=function(t,e){var n=this.nodeFactory.create(t,e);return n},this.getBuiltIns=function(){return[s]},this.isInstanceOf=function(t,e){var n=this.getNodeClass(t);return!!n&&s["static"].isInstanceOf(n,e)},this.each=function(){this.nodeFactory.each.apply(this.nodeFactory,arguments)},this.getTocTypes=function(){return this.tocTypes},this.getDefaultTextType=function(){throw new Error("Schmema.prototype.getDefaultTextType() must be overridden.")}},o.initClass(i),e.exports=i},{"../basics/helpers":32,"../basics/oo":34,"./node":41,"./node_factory":42}],45:[function(t,e,n){"use strict";function i(t){o.EventEmitter.call(this),this.schema=t,this.AUTO_ATTACH=!0,this.FOR_CLIPBOARD=!1,this.data=new s.Incremental(t,{didCreateNode:r.bind(this._didCreateNode,this),didDeleteNode:r.bind(this._didDeleteNode,this)})}var r=t("../basics/helpers"),o=t("../basics"),s=t("../data"),a=t("./selection"),c=t("./property_selection"),l=t("./container_selection"),u=t("./table_selection");i.Prototype=function(){this.isTransaction=function(){return!1},this.isClipboard=function(){return this.FOR_CLIPBOARD},this.newInstance=function(){throw new Error("Must be implemented in subclass.")},this.initialize=function(){},this.addIndex=function(t,e){return this.data.addIndex(t,e)},this.getIndex=function(t){return this.data.getIndex(t)},this._setAutoAttach=function(t){this.AUTO_ATTACH=t},this._setForClipboard=function(t){this.FOR_CLIPBOARD=t},this._resetContainers=function(){var t=this.getIndex("type").get("container");o.each(t,function(t){t.reset()})},this._create=function(t){var e=this.data.create(t);return this._updateContainers(e),e},this._delete=function(t){var e=this.data["delete"](t);return this._updateContainers(e),e},this._update=function(t,e){var n=this.data.update(t,e);return this._updateContainers(n),n},this._set=function(t,e){var n=this.data.set(t,e);return this._updateContainers(n),n},this.documentDidLoad=function(){},this.getSchema=function(){return this.schema},this.get=function(t){return this.data.get(t)},this.getNodes=function(){return this.data.getNodes()},this.addIndex=function(t,e){return this.data.addIndex(t,e)},this.getIndex=function(t){return this.data.getIndex(t)},this.loadSeed=function(t){r.each(this.data.nodes,function(t){this["delete"](t.id)},this),this._setAutoAttach(!1),r.each(t.nodes,function(t){this.create(t)},this),this._setAutoAttach(!0),r.each(this.data.nodes,function(t){t.attach(this)},this),this.documentDidLoad()},this.getTextForSelection=function(t){var e,n=[];if(!t||t.isNull())return"";if(t.isPropertySelection())e=this.get(t.start.path),n.push(e.substring(t.start.offset,t.end.offset));else if(t.isContainerSelection())for(var i=this.get(t.containerId),r=i.getComponentsForRange(t.range),o=0;o<r.length;o++){var s=r[o];e=this.get(s.path),1===r.length?n.push(e.substring(t.start.offset,t.end.offset)):0===o?n.push(e.substring(t.start.offset)):o===r.length-1?n.push(e.substring(0,t.end.offset)):n.push(e)}return n.join("")},this.toJSON=function(){var t={};return r.each(this.getNodes(),function(e){t[e.id]=e.toJSON()}),{schema:[this.schema.name,this.schema.version],nodes:t}},this.create=function(t){throw new Error("Method is abstract.")},this["delete"]=function(t){throw new Error("Method is abstract.")},this.set=function(t,e){throw new Error("Method is abstract.")},this.update=function(t,e){throw new Error("Method is abstract.")},this.setText=function(t,e,n){var i,r=this.getIndex("annotations").get(t);for(i=0;i<r.length;i++)this["delete"](r[i].id);for(this.set(t,e),i=0;i<n.length;i++)this.create(n[i])},this.createSelection=function(t){if(!t)return a.nullSelection;switch(t.type){case"property":return new c(t).attach(this);case"container":return new l(t).attach(this);case"table":return new u(t).attach(this);default:throw new Error("Unsupported selection type",t.type)}},this._didCreateNode=function(t){this.AUTO_ATTACH&&t.attach(this)},this._didDeleteNode=function(t){t.detach(this)},this._updateContainers=function(t){var e=this.getIndex("type").get("container");r.each(e,function(e){e.update(t)})}},o.inherit(i,o.EventEmitter),e.exports=i},{"../basics":33,"../basics/helpers":32,"../data":40,"./container_selection":56,"./property_selection":79,"./selection":81,"./table_selection":82}],46:[function(t,e,n){"use strict";var i=t("../basics"),r=i.PathAdapter,o=t("../data"),s=t("./container_annotation"),a=function(t){this.doc=t,this.byPath=new r.Arrays,this.byId={}};a.Prototype=function(){this.select=function(t){return t instanceof s},this.reset=function(t){this.byPath.clear(),this.byId={},this._initialize(t)},this.get=function(t,e){var n=this.byPath.get(t)||[];if(!i.isArray(n)){var r=[];this.byPath._traverse(n,[],function(t,e){r=r.concat(e)}),n=r}return e?i.filter(n,function(t){return t.container===e}):n.slice(0)},this.create=function(t){var e=t.getStartAnchor(),n=t.getEndAnchor();this.byPath.add(e.path,e),this.byPath.add(n.path,n),this.byId[t.id]=t},this["delete"]=function(t){var e=t.getStartAnchor(),n=t.getEndAnchor();this.byPath.remove(e.path,e),this.byPath.remove(n.path,n),delete this.byId[t.id]},this.update=function(t,e,n,i){if(this.select(t)){var r=null;if("startPath"===e[1])r=t.getStartAnchor();else{if("endPath"!==e[1])return;r=t.getEndAnchor()}this.byPath.remove(i,r),this.byPath.add(r.path,r)}}},i.inherit(a,o.Index),e.exports=a},{"../basics":33,"../data":40,"./container_annotation":54}],47:[function(t,e,n){"use strict";var i=t("../basics"),r=t("./node"),o=r.extend({name:"annotation",properties:{path:["array","string"],startOffset:"number",endOffset:"number"},canSplit:function(){return!0},getSelection:function(){return this.getDocument().createSelection({type:"property",path:this.path,startOffset:this.startOffset,endOffset:this.endOffset})},updateRange:function(t,e){if(!e.isPropertySelection())throw new Error("Cannot change to ContainerAnnotation.");i.isEqual(this.startPath,e.start.path)||t.set([this.id,"path"],e.start.path),this.startOffset!==e.start.offset&&t.set([this.id,"startOffset"],e.start.offset),this.endOffset!==e.end.offset&&t.set([this.id,"endOffset"],e.end.offset)},getText:function(){var t=this.getDocument();if(!t)return console.warn("Trying to use an Annotation which is not attached to the document."),"";var e=t.get(this.path);return e.substring(this.startOffset,this.endOffset)},setActive:function(t){this.active!==t&&(this.active=t,this.emit("active",t))}});o["static"].isInline=!0,o["static"].toHtml=function(t,e,n){var i=t.id,r=t.constructor["static"].tagName||"span",o=$("<"+r+">").attr("id",i).append(n);return o},Object.defineProperties(o.prototype,{startPath:{get:function(){return this.path}},endPath:{get:function(){return this.path}}}),e.exports=o},{"../basics":33,"./node":64}],48:[function(t,e,n){"use strict";var i=t("../basics"),r=i.PathAdapter,o=t("../data"),s=t("./annotation"),a=function(){this.byPath=new r,this.byType=new r};a.Prototype=function(){this.property="path",this.select=function(t){return t instanceof s},this.reset=function(t){this.byPath.clear(),this.byType.clear(),this._initialize(t)},this.get=function(t,e,n,r){var o=this.byPath.get(t)||{};if(i.isString(t)||1===t.length){var s=o;o=[],i.each(s,function(t){o=o.concat(i.map(t,function(t){return t}))})}else o=i.map(o,function(t){return t});return null!=e&&(o=i.filter(o,a.filterByRange(e,n))),r&&(o=i.filter(o,a.filterByType(r))),o},this.create=function(t){this.byType.set([t.type,t.id],t),this.byPath.set(t.path.concat([t.id]),t)},this["delete"]=function(t){this.byType["delete"]([t.type,t.id]),this.byPath["delete"](t.path.concat([t.id]))},this.update=function(t,e,n,i){this.select(t)&&e[1]===this.property&&(this["delete"]({id:t.id,type:t.type,path:i}),this.create(t))}},i.inherit(a,o.Index),a.filterByRange=function(t,e){return function(n){var i=n.startOffset,r=n.endOffset,o=r>=t;return null!=e&&(o=o&&i<=e),o}},a.filterByType=function(t){return function(e){return e.isInstanceOf(t)}},e.exports=a},{"../basics":33,"../data":40,"./annotation":47}],49:[function(t,e,n){"use strict";var i=t("../basics/helpers"),r=function(t,e,n){if(n){var r=t.getIndex("annotations"),o=r.get(e.path);i.each(o,function(i){var r=e.offset,o=i.startOffset,s=i.endOffset,a=o,c=s;(r<o||r===o)&&(a+=n),(r<s||r===s&&!i.isExternal())&&(c+=n),a!==o&&t.set([i.id,"startOffset"],a),c!==s&&t.set([i.id,"endOffset"],c)}),r=t.getIndex("container-annotation-anchors");var s=r.get(e.path);i.each(s,function(i){var r=e.offset,o=i.offset,s=!1;if((r<o||r===o&&!e.after)&&(o+=n,s=!0),s){var a=i.isStart?"startOffset":"endOffset";t.set([i.id,a],o)}})}},o=function(t,e,n,r){if(n!==r){var o=t.getIndex("annotations"),s=o.get(e),a=r-n;i.each(s,function(e){var i=n,o=r,s=e.startOffset,c=e.endOffset,l=s,u=c;o<=s?(l-=a,u-=a,t.set([e.id,"startOffset"],l),t.set([e.id,"endOffset"],u)):(i<=s&&(l=s-Math.min(o-i,s-i)),i<=c&&(u=c-Math.min(o-i,c-i)),s!==c&&l===u?t["delete"](e.id):(s!==l&&t.set([e.id,"startOffset"],l),c!==u&&t.set([e.id,"endOffset"],u)))}),o=t.getIndex("container-annotation-anchors");var c=o.get(e),l=[];i.each(c,function(e){l.push(e.id);var i=n,o=r,s=e.offset,c=!1;if(o<=s)s-=a,c=!0;else if(i<=s){var u=s-Math.min(o-i,s-i);s!==u&&(s=u,c=!0)}if(c){var h=e.isStart?"startOffset":"endOffset";t.set([e.id,h],s)}}),i.each(i.uniq(l),function(e){var n=t.get(e),i=n.getSelection();i.isCollapsed()&&(console.log("...deleting container annotation because it has collapsed"+e),t["delete"](e))})}},s=function(t,e,n,r,o){var s=t.getIndex("annotations"),a=s.get(e,n);i.each(a,function(e){var s,a,c=n>e.startOffset&&n<e.endOffset,l=e.startOffset,u=e.endOffset;if(c){if(e.canSplit()){var h=i.clone(e.properties);h.id=i.uuid(e.type+"_"),h.startOffset=o,h.endOffset=o+e.endOffset-n,h.path=r,t.create(h)}s=e.startOffset,a=n,a===s?t["delete"](e.id):(s!==l&&t.set([e.id,"startOffset"],s),a!==u&&t.set([e.id,"endOffset"],a))}else e.startOffset>=n&&(s=o+e.startOffset-n,a=o+e.endOffset-n,t.set([e.id,"path"],r),t.set([e.id,"startOffset"],s),t.set([e.id,"endOffset"],a))}),s=t.getIndex("container-annotation-anchors");var c=s.get(e),l=[];i.each(c,function(e){l.push(e.id);var i=e.offset;if(n<=i){var s=e.isStart?"startPath":"endPath",a=e.isStart?"startOffset":"endOffset";t.set([e.id,s],r),t.set([e.id,a],o+e.offset-n)}}),i.each(i.uniq(l),function(e){var n=t.get(e),i=n.getSelection();i.isCollapsed()&&(console.log("...deleting container annotation because it has collapsed"+e),t["delete"](e))})};e.exports={insertedText:r,deletedText:o,transferAnnotations:s}},{"../basics/helpers":32}],50:[function(t,e,n){"use strict";var i=t("../basics"),r=1,o=-1,s=-2,a=function(t){i.extend(this,t)};a.Prototype=function(){var t=function(t,e){if(t.pos<e.pos)return-1;if(t.pos>e.pos)return 1;if(t.id===e.id)return e.mode-t.mode;if(t.mode<e.mode)return-1;if(t.mode>e.mode)return 1;if(t.mode===r){if(t.level<e.level)return-1;if(t.level>e.level)return 1}if(t.mode===o){if(t.level>e.level)return-1;if(t.level<e.level)return 1}return 0},e=function(t){var e=[];return i.each(t,function(t){if(t.zeroWidth)e.push({pos:t.offset,mode:s,id:t.id,level:Number.MAX_VALUE,type:"anchor",node:t});else{var n=t.constructor["static"].level||1e3;e.push({pos:t.startOffset,mode:r,level:n,id:t.id,type:t.type,node:t}),e.push({pos:t.endOffset,mode:o,level:n,id:t.id,type:t.type,node:t})}}),e};this.onText=function(){},this.onEnter=function(){return null},this.onExit=function(){},this.enter=function(t,e){return this.onEnter(t,e)},this.exit=function(t,e,n){this.onExit(t,e,n)},this.createText=function(t,e){e.length>0&&this.onText(t,e)},this.start=function(n,i,a){var c=this,l=e.call(this,a);l.sort(t.bind(this));for(var u=[{context:n,entry:null}],h=0,f=0;f<l.length;f++){var d=l[f];this.createText(u[u.length-1].context,i.substring(h,d.pos)),h=d.pos;var p,g;if(d.mode===r||d.mode===s){for(p=1;p<u.length&&!(d.level<u[p].entry.level);p++);for(g=u.length-1;g>=p;g--)this.exit(u[g].entry,u[g].context,u[g-1].context);for(u.splice(p,0,{entry:d}),g=p;g<u.length;g++)u[g].context=c.enter(u[g].entry,u[g-1].context)}if(d.mode===o||d.mode===s){for(p=1;p<u.length&&u[p].entry.node!==d.node;p++);for(g=u.length-1;g>=p;g--)this.exit(u[g].entry,u[g].context,u[g-1].context);for(u.splice(p,1),g=p;g<u.length;g++)u[g].context=c.enter(u[g].entry,u[g-1].context)}}this.createText(n,i.substring(h))}},i.initClass(a),e.exports=a},{"../basics":33}],51:[function(t,e,n){function i(){i["super"].call(this)}var r=t("../basics/oo"),o=(t("./clipboard_importer"),t("./html_exporter"));i.Prototype=function(){this.convert=function(t,e){this.initialize(t,e);var n=this.createHtmlDocument(),i=t.get("clipboard_content");return n.find("body").append(this.convertContainer(i)),n.find("html").html()}},r.inherit(i,o),e.exports=i},{"../basics/oo":34,"./clipboard_importer":52,"./html_exporter":61}],52:[function(t,e,n){function i(t){if(!t.schema)throw new Error("Missing argument: config.schema is required.");r.extend(t,{trimWhitespaces:!0,REMOVE_INNER_WS:!0}),i["super"].call(this,t)}var r=t("../basics/helpers"),o=t("../basics/oo"),s=t("./html_importer"),a=t("./transformations/copy_selection").CLIPBOARD_CONTAINER_ID;i.Prototype=function(){this.convert=function(t,e){this.initialize(e,t);var n=t.find("body");n=this.sanitizeBody(n),this.convertContainer(n,a),this.finish()},this.sanitizeBody=function(t){var e=t.find("b > p");return e.length&&(t=$(e[0].parentNode)),t},this.checkQuality=function(t){var e=t.find("body");return!!e.children("b").children("p").length||(!!e.children("p").length||!e.find("* p").length&&!!e.children("a,b,i,strong,italic").length)}},o.inherit(i,s),e.exports=i},{"../basics/helpers":32,"../basics/oo":34,"./html_importer":62,"./transformations/copy_selection":86}],53:[function(t,e,n){"use strict";function i(){a.apply(this,arguments),this.components=[],this.nodeComponents={},this.byPath=new s({})}var r=t("../basics/helpers"),o=t("../basics/oo"),s=t("../basics/path_adapter"),a=t("./node"),c=t("./container_annotation");i.Prototype=function(){this.didAttach=function(){this.reset()},this.getPosition=function(t){var e=this.nodes.indexOf(t);return e},this.show=function(t,e){var n=this.getDocument();null==e&&(e=this.nodes.length),n.update([this.id,"nodes"],{insert:{offset:e,value:t}})},this.hide=function(t){var e=this.getDocument(),n=this.nodes.indexOf(t);n>=0&&e.update([this.id,"nodes"],{"delete":{offset:n}})},this.getComponents=function(){return this.components},this.getComponent=function(t){var e=this.byPath.get(t);return e},this.getComponentsForRange=function(t){var e=[],n=this.byPath.get(t.start.path),i=this.byPath.get(t.end.path),r=n.getIndex(),o=i.getIndex();e.push(n);for(var s=r+1;s<=o;s++)e.push(this.getComponentAt(s));return e},this.getComponentAt=function(t){return this.components[t]},this.getFirstComponent=function(){return this.components[0]},this.getLastComponent=function(){return r.last(this.components)},this.getComponentsForNode=function(t){var e=this.nodeComponents[t];if(e)return e.components.slice(0)},this.getNodeForComponentPath=function(t){var e=this.getComponent(t);if(!e)return null;var n=e.rootId;return this.getDocument().get(n)},this.getAnnotationFragments=function(t){var e=[],n=t.getDocument(),i=t,o=i.getStartAnchor(),s=i.getEndAnchor();if(r.isEqual(o.path,s.path))e.push(new c.Fragment(i,o.path,"property"));else{var a=n.get(o.path),l=this.getComponent(o.path),u=this.getComponent(s.path);if(!l||!u)throw new Error("Could not find components of AbstractContainerAnnotation");e.push(new c.Fragment(i,o.path,"start"));for(var h=l.idx+1;h<u.idx;h++){var f=this.getComponentAt(h);a=n.get(f.path),e.push(new c.Fragment(i,f.path,"inner"))}e.push(new c.Fragment(i,s.path,"end"))}return e},this.reset=function(){this.byPath=new s;var e=this.getDocument(),n=[];r.each(this.nodes,function(i){var r=e.get(i);n=n.concat(t(r))},this),this.components=[],this.nodeComponents={},this._insertComponentsAt(0,n),this._updateComponentPositions(0)},this.update=function(t){if("create"!==t.type&&"delete"!==t.type&&t.path[0]===this.id&&"nodes"===t.path[1])if("set"===t.type)this.reset();else{var e=t.diff;if(e.isInsert()){var n=this._handleInsert(e.getValue(),e.getOffset());this._updateComponentPositions(n)}else{if(!e.isDelete())throw new Error("Illegal state");var i=this._handleDelete(e.getValue());this._updateComponentPositions(i)}}},this.updateNode=function(e){var n=this.getDocument().get(e),i=this._handleDelete(e),r=t(n);this._insertComponentsAt(i,r),this._updateComponentPositions(i)},this._insertComponentsAt=function(t,e){for(var n=this.components[t-1],r=this.components[t],o=this.nodeComponents,s=this.byPath,a=0;a<e.length;a++){var c=e[a],l=c.rootId,u=o[l];u||(u=new i.NodeComponent(l),o[l]=u),c.parentNode=u,0===a&&n?(n.next=c,c.previous=n):a>0&&(c.previous=e[a-1],e[a-1].next=c),u.components.push(c),s.set(c.path,c)}r&&(e[e.length-1].next=r,r.previous=e[e.length-1]),this.components.splice.apply(this.components,[t,0].concat(e))},this._updateComponentPositions=function(t){for(var e=t;e<this.components.length;e++)this.components[e].idx=e},this._handleInsert=function(e,n){var i,r=this.getDocument(),o=r.get(e),s=this.nodes.length;if(n===s-1)i=this.components.length;else{var a=this.nodes[n+1],c=this.nodeComponents[a].components[0];i=c.getIndex()}var l=t(o);return this._insertComponentsAt(i,l),i},this._handleDelete=function(t){for(var e=this.nodeComponents[t],n=e.components,i=e.components[0].getIndex(),o=r.last(n).getIndex(),s=0;s<n.length;s++){var a=n[s];this.byPath["delete"](a.path)}return delete this.nodeComponents[t],this.components.splice(i,o-i+1),this.components.length>i&&(this.components[i].previous=this.components[i-1]),i>0&&(this.components[i-1].next=this.components[i]),i};var t=function(e,n){n=n||e;for(var o,s=[],a=e.getComponents(),c=0;c<a.length;c++){var l=a[c],u=e.getPropertyType(l);if("string"===u){var h=[e.id,l];s.push(new i.Component(h,n.id))}else if("id"===u){var f=e[l];o=e.getDocument().get(f),s=s.concat(t(o,n))}else{if(!r.isEqual(u,["array","id"]))throw new Error("Not yet implemented.");for(var d=e[l],p=0;p<d.length;p++)o=e.getDocument().get(d[p]),s=s.concat(t(o,n))}}return s}},o.inherit(i,a),i["static"].name="container",i["static"].schema={nodes:["array","string"]},a.initNodeClass(i),i.Component=function(t,e){this.path=t,this.rootId=e,this.idx=-1,this.parentNode=null,this.previous=null,this.next=null},i.Component.Prototype=function(){this.getPath=function(){return this.path},this.hasPrevious=function(){return!!this.previous},this.getPrevious=function(){return this.previous},this.hasNext=function(){return!!this.next},this.getNext=function(){return this.next},this.getIndex=function(){return this.idx},this.getParentNode=function(){return this.parentNode}},o.initClass(i.Component),i.NodeComponent=function(t){this.id=t,this.components=[]},o.initClass(i.NodeComponent),e.exports=i},{"../basics/helpers":32,"../basics/oo":34,"../basics/path_adapter":35,"./container_annotation":54,"./node":64}],54:[function(t,e,n){"use strict";var i=t("../basics/helpers"),r=t("../basics/oo"),o=t("../basics/event_emitter"),s=t("./node"),a=t("./selection"),c=t("../basics/path_adapter"),l=s.extend({
name:"container_annotation",properties:{container:"string",startPath:["array","string"],startOffset:"number",endPath:["array","string"],endOffset:"number"},getStartAnchor:function(){return this._startAnchor||(this._startAnchor=new l.Anchor(this,"isStart")),this._startAnchor},getEndAnchor:function(){return this._endAnchor||(this._endAnchor=new l.Anchor(this)),this._endAnchor},getSelection:function(){var t=this.getDocument();return t?t.createSelection({type:"container",containerId:this.container,startPath:this.startPath,startOffset:this.startOffset,endPath:this.endPath,endOffset:this.endOffset}):(console.warn("Trying to use a ContainerAnnotation which is not attached to the document."),a.nullSelection())},getText:function(){var t=this.getDocument();return t?t.getTextForSelection(this.getSelection()):(console.warn("Trying to use a ContainerAnnotation which is not attached to the document."),"")},updateRange:function(t,e){if(!e.isContainerSelection())throw new Error("Cannot change to ContainerAnnotation.");i.isEqual(this.startPath,e.start.path)||t.set([this.id,"startPath"],e.start.path),this.startOffset!==e.start.offset&&t.set([this.id,"startOffset"],e.start.offset),i.isEqual(this.endPath,e.end.path)||t.set([this.id,"endPath"],e.end.path),this.endOffset!==e.end.offset&&t.set([this.id,"endOffset"],e.end.offset)},setActive:function(t){this.active!==t&&(this.active=t,this.emit("active",t),i.each(this.fragments,function(e){e.emit("active",t)}))},getFragments:function(){this._fragments||(this._fragments=new c);var t,e=[],n=this.getDocument(),r=this.getStartAnchor(),o=this.getEndAnchor(),s=n.get(this.container);if(i.isEqual(r.path,o.path))t=this._fragments.get(r.path),t?"property"===!t.mode&&(t.mode="property"):(t=new l.Fragment(this,r.path,"property"),this._fragments.set(t.path,t)),e.push(t);else{var a=n.get(r.path),u=s.getComponent(r.path),h=s.getComponent(o.path);if(!u||!h)throw new Error("Could not find components of AbstractContainerAnnotation");t=this._fragments.get(r.path),t?"start"!==t.mode&&(t.mode="start"):(t=new l.Fragment(this,r.path,"start"),this._fragments.set(t.path,t)),e.push(t);for(var f=u.idx+1;f<h.idx;f++){var d=s.getComponentAt(f);a=n.get(d.path),t=this._fragments.get(d.path),t?"inner"!==t.mode&&(t.mode="inner"):(t=new l.Fragment(this,d.path,"inner"),this._fragments.set(t.path,t)),e.push(t)}t=this._fragments.get(o.path),t?"end"!==t.mode&&(t.mode="end"):(t=new l.Fragment(this,o.path,"end"),this._fragments.set(t.path,t)),e.push(t)}return this.fragments=e,e}});l.Anchor=function(t,e){o.call(this),this.type="container-annotation-anchor",this.anno=t,this.node=t,this.id=t.id,this.container=t.container,this.isStart=!!e,Object.freeze(this)},l.Anchor.Prototype=function(){i.extend(this,o.prototype),this.zeroWidth=!0,this.getTypeNames=function(){return[this.type]}},r.initClass(l.Anchor),l.Fragment=function(t,e,n){o.call(this),this.type="container_annotation_fragment",this.anno=t,this.id=t.id,this.path=e,this.mode=n},l.Fragment.Prototype=function(){i.extend(this,o.prototype),this.getTypeNames=function(){return[this.type]}},r.initClass(l.Fragment),l.Fragment["static"].toHtml=function(t,e,n){var i=t.anno.id,r=$("<span>").attr("id",i).append(n);return r},Object.defineProperties(l.Fragment.prototype,{startOffset:{get:function(){return"start"===this.mode||"property"===this.mode?this.anno.startOffset:0},set:function(){throw new Error("Immutable!")}},endOffset:{get:function(){var t=this.anno.getDocument(),e=t.get(this.path),n=e.length;return"end"===this.mode||"property"===this.mode?this.anno.endOffset:n},set:function(){throw new Error("Immutable!")}},active:{get:function(){return this.anno.active},set:function(){throw new Error("Immutable!")}}}),l.Fragment["static"].level=1e4,Object.defineProperties(l.Anchor.prototype,{path:{get:function(){return this.isStart?this.node.startPath:this.node.endPath},set:function(){throw new Error("Immutable!")}},offset:{get:function(){return this.isStart?this.node.startOffset:this.node.endOffset},set:function(){throw new Error("Immutable!")}}}),e.exports=l},{"../basics/event_emitter":30,"../basics/helpers":32,"../basics/oo":34,"../basics/path_adapter":35,"./node":64,"./selection":81}],55:[function(t,e,n){"use strict";var i=t("../basics/helpers"),r=t("../basics/oo"),o=t("../basics/path_adapter"),s=t("../data"),a=t("./container_annotation"),c=function(t){this.doc=t,this.indexes={},this.containers={},this.containerAnnotations={}};c.Prototype=function(){this.getFragments=function(t,e){var n=this.indexes[e];return n?n.get(t)||[]:[]},this.getAllContainerAnnotations=function(){return this.containerAnnotations},this.reset=function(){this.indexes={},this._initialize(this.doc.data)},this._initialize=function(t){i.each(t.getNodes(),function(t){this.select(t)&&this.create(t,"isInitializing")},this),i.each(this.containers,function(t){this.recompute(t.id)},this)},this.select=function(t){return"container"===t.type||t.isInstanceOf(a["static"].name)},this.create=function(t,e){if("container"===t.type)this.containers[t.id]=t,this.indexes[t.id]=new o.Arrays;else if(t.isInstanceOf(a["static"].name)){var n=t.container;this.containerAnnotations[t.id]=t,e||this.recompute(n)}},this.recompute=function(t){var e=(this.containers[t],this.indexes[t]=new o.Arrays);i.each(this.containerAnnotations,function(t){var n=t.getFragments();i.each(n,function(t){e.add(t.path,t)})})},this.onDocumentChange=function(t){for(var e=!1,n={},r=this.doc,o=r.getSchema(),s=0;s<t.ops.length;s++){var c=t.ops[s];if(c.isCreate()||c.isDelete()){var l=c.getValue();"container"===l.type?(n[l.id]=!0,c.isCreate()?this.containers[l.id]=r.get(l.id):delete this.containers[l.id],e=!0):o.isInstanceOf(l.type,a["static"].name)&&(n[l.container]=!0,c.isCreate()?this.containerAnnotations[l.id]=r.get(l.id):delete this.containerAnnotations[l.id],e=!0)}else{var u=c.path[0];if(t.deleted[u])continue;var h=r.get(u);"container"===h.type?(n[h.id]=!0,e=!0):h.isInstanceOf(a["static"].name)&&(n[h.container]=!0,e=!0)}}e&&i.each(n,function(t,e){this.recompute(e)},this)}},r.inherit(c,s.Index),e.exports=c},{"../basics/helpers":32,"../basics/oo":34,"../basics/path_adapter":35,"../data":40,"./container_annotation":54}],56:[function(t,e,n){"use strict";function i(t){var e=t.containerId,n=t.startPath,i=t.endPath||t.startPath,r=t.startOffset,s=t.endOffset||t.startOffset;if(!e||!n||!o.isNumber(r))throw new Error("Invalid arguments: `containerId`, `startPath` and `startOffset` are mandatory");this.containerId=e,this.range=new c(new l(n,r),new l(i,s)),this.reverse=t.reverse,this._internal={},Object.freeze(this)}var r=t("../basics/oo"),o=t("../basics/helpers"),s=t("./property_selection"),a=t("./selection"),c=t("./range"),l=t("./coordinate");i.Prototype=function(){this.toJSON=function(){return{type:"container",containerId:this.containerId,startPath:this.startPath,startOffset:this.startOffset,endPath:this.endPath,endOffset:this.endOffset,reverse:this.reverse}},this.attach=function(t){return this._internal.doc=t,this},this.isPropertySelection=function(){return!1},this.isContainerSelection=function(){return!0},this.toString=function(){return"ContainerSelection("+JSON.stringify(this.range.start.path)+":"+this.range.start.offset+" -> "+JSON.stringify(this.range.end.path)+":"+this.range.end.offset+(this.reverse?", reverse":"")+")"},this.getDocument=function(){var t=this._internal.doc;if(!t)throw new Error("Selection is not attached to a document.");return t},this.getContainer=function(){return this.getDocument().get(this.containerId)},this.expand=function(t){var e=this._coordinates(this),i=this._coordinates(t),r=e.start,o=i.start,s=e.end,a=i.end,c={start:{pos:r.pos,offset:r.offset},end:{pos:s.pos,offset:s.offset}};return r.pos>o.pos?(c.start.pos=o.pos,c.start.offset=o.offset):r.pos===o.pos&&(c.start.offset=Math.min(r.offset,o.offset)),s.pos<a.pos?(c.end.pos=a.pos,c.end.offset=a.offset):s.pos===a.pos&&(c.end.offset=Math.max(s.offset,a.offset)),n(this,c)},this.truncate=function(i){var r=this._coordinates(this),o=this._coordinates(i),s={};if(t(o.start,r.start,"strict"))s.start=r.start,s.end=o.end;else if(t(r.end,o.end,"strict"))s.start=o.start,s.end=r.end;else if(e(r.start,o.start)){if(e(r.end,o.end))return a.nullSelection;s.start=o.end,s.end=r.end}else e(r.end,o.end)&&(s.start=r.start,s.end=o.start);return n(this,s)},this.isInsideOf=function(e,n){if(e.isNull())return!1;var i=this._coordinates(this),r=this._coordinates(e);return t(r.start,i.start,n)&&t(i.end,r.end,n)},this.contains=function(e){var n=this._coordinates(this),i=this._coordinates(e);return t(n.start,i.start)&&t(i.end,n.end)},this.includesWithOneBoundary=function(n){var i=this._coordinates(this),r=this._coordinates(n);return e(i.start,r.start)&&t(r.end,i.end)||e(i.end,r.end)&&t(i.start,r.start)},this.overlaps=function(e){var n=this._coordinates(this),i=this._coordinates(e);return!(t(n.end,i.start)||t(i.end,n.start))},this.isLeftAlignedWith=function(t){var n=this._coordinates(this),i=this._coordinates(t);return e(n.start,i.start)},this.isRightAlignedWith=function(t){var n=this._coordinates(this),i=this._coordinates(t);return e(n.end,i.end)},this.splitIntoPropertySelections=function(){for(var t=[],e=this.getContainer(),n=e.getComponentsForRange(this.range),i=e.getDocument(),r=0;r<n.length;r++){var o,s,a=n[r];o=0===r?this.startOffset:0,s=r===n.length-1?this.endOffset:i.get(a.path).length,t.push(i.createSelection({type:"property",path:a.path,startOffset:o,endOffset:s}))}return t},this._coordinates=function(t){if(t._internal.containerRange)return t._internal.containerRange;var e,n=this.getContainer(),r=t.getRange(),o=n.getComponent(r.start.path).getIndex();e=t.isCollapsed()?o:n.getComponent(r.end.path).getIndex();var s={start:{pos:o,offset:r.start.offset},end:{pos:e,offset:r.end.offset}};return t instanceof i&&(t._internal.containerRange=s),s};var t=function(t,e,n){return n?!(t.pos>=e.pos)&&!(t.pos==e.pos&&t.offset>=e.offset):!(t.pos>e.pos)&&!(t.pos==e.pos&&t.offset>e.offset)},e=function(t,e){return t.pos===e.pos&&t.offset===e.offset},n=function(t,e){var n=t.getContainer();return e.start.path=n.getComponentAt(e.start.pos).path,e.end.path=n.getComponentAt(e.end.pos).path,new i({containerId:t.containerId,startPath:e.start.path,startOffset:e.start.offset,endPath:e.end.path,endOffset:e.end.offset})}},r.inherit(i,s),Object.defineProperties(i.prototype,{path:{get:function(){throw new Error("ContainerSelection has no path property. Use startPath and endPath instead")},set:function(){throw new Error("immutable.")}},startPath:{get:function(){return this.range.start.path},set:function(){throw new Error("immutable.")}},endPath:{get:function(){return this.range.end.path},set:function(){throw new Error("immutable.")}}}),e.exports=i},{"../basics/helpers":32,"../basics/oo":34,"./coordinate":57,"./property_selection":79,"./range":80,"./selection":81}],57:[function(t,e,n){"use strict";function i(t,e,n){if(this.path=t,this.offset=e,this.after=n,!o.isArray(t))throw new Error("Invalid arguments: path should be an array.");if(!o.isNumber(e)||e<0)throw new Error("Invalid arguments: offset must be a positive number.");Object.isFrozen(t)||Object.freeze(t),Object.freeze(this)}var r=t("../basics/oo"),o=t("../basics/helpers");i.Prototype=function(){this.equals=function(t){return t===this||o.isArrayEqual(t.path,this.path)&&t.offset===this.offset},this.withCharPos=function(t){return new i(this.path,t)},this.getNodeId=function(){return this.path[0]},this.getPath=function(){return this.path},this.getOffset=function(){return this.offset}},r.initClass(i),e.exports=i},{"../basics/helpers":32,"../basics/oo":34}],58:[function(t,e,n){"use strict";function i(t){a.call(this,t),this.__id__=v++,this.nodeIndex=this.addIndex("type",s.Index.create({property:"type"})),this.annotationIndex=this.addIndex("annotations",new c),this.anchorIndex=this.addIndex("container-annotation-anchors",new l),this.containerAnnotationIndex=new u(this),this.done=[],this.undone=[],this.eventProxies={path:new d(this)},this.initialize(),this.stage=new h(this),this.isTransacting=!1,this.FORCE_TRANSACTIONS=!1,this.connect(this,{"document:changed":this.updateEventProxies})}var r=t("../basics/helpers"),o=t("../basics"),s=t("../data"),a=t("./abstract_document"),c=t("./annotation_index"),l=t("./anchor_index"),u=t("./container_annotation_index"),h=t("./transaction_document"),f=t("./document_change"),d=t("./path_event_proxy"),p=t("./clipboard_importer"),g=t("./clipboard_exporter"),v=0;i.Prototype=function(){this.isTransaction=function(){return!1},this.newInstance=function(){var t=this.constructor;return new t(this.schema)},this.fromSnapshot=function(t){var e=this.newInstance();return e.loadSeed(t),e},this.documentDidLoad=function(){this.stage.reset(),this.containerAnnotationIndex.reset(),this.done=[],this.FORCE_TRANSACTIONS=!0},this.getEventProxy=function(t){return this.eventProxies[t]},this.transaction=function(t,e,n){if(1===arguments.length&&(n=arguments[0],e={},t={}),2===arguments.length?(n=arguments[1],e={}):e=e||{},!r.isFunction(n))throw new Error("Document.transaction() requires a transformation function.");var i=this.startTransaction(r.clone(t));try{var o=n(i),s={};for(var a in t)o[a]?s[a]=o[a]:s[a]=t[a];this.isTransacting&&i.save(s,e)}finally{i.finish()}},this.startTransaction=function(t){if(this.isTransacting)throw new Error("Nested transactions are not supported.");return this.isTransacting=!0,this.stage.before=t||{},this.emit("transaction:started",this.stage),this.stage},this.create=function(t){if(this.FORCE_TRANSACTIONS)throw new Error("Use a transaction!");return this.isTransacting?this.stage.create(t):(this.stage&&this.stage.create(t),this._create(t)),this.data.get(t.id)},this["delete"]=function(t){if(this.FORCE_TRANSACTIONS)throw new Error("Use a transaction!");this.isTransacting?this.stage["delete"](t):(this.stage&&this.stage["delete"](t),this._delete(t))},this.set=function(t,e){if(this.FORCE_TRANSACTIONS)throw new Error("Use a transaction!");this.isTransacting?this.stage.set(t,e):(this.stage&&this.stage.set(t,e),this._set(t,e))},this.update=function(t,e){if(this.FORCE_TRANSACTIONS)throw new Error("Use a transaction!");this.isTransacting?this.stage.update(t,e):(this._update(t,e),this.stage&&this.stage.update(t,e))},this.undo=function(){var t=this.done.pop();if(t){var e=t.invert();this._apply(e),this.undone.push(e),this._notifyChangeListeners(e,{replay:!0})}else console.error("No change can be undone.")},this.redo=function(){var t=this.undone.pop();if(t){var e=t.invert();this._apply(e),this.done.push(e),this._notifyChangeListeners(e,{replay:!0})}else console.error("No change can be redone.")},this.getAnnotationsForSelection=function(t,e){e=e||{};var n,i,o,s;return t.isPropertySelection()?(i=t.getPath(),o=t.getStartOffset(),s=t.getEndOffset(),n=this.annotationIndex.get(i,o,s),e.type&&(n=r.filter(n,c.filterByType(e.type))),n):[]},this.getContainerAnnotationsForSelection=function(t,e,n){if(!e)return[];var i;return i=n.type?this.getIndex("type").get(n.type):this.getIndex("container-annotation-anchors").byId,i=r.filter(i,function(e){var n=e.getSelection();return t.overlaps(n)})},this.getDocumentMeta=function(){return this.get("document")},this.getClipboardImporter=function(){return new p({schema:this.getSchema()})},this.getClipboardExporter=function(){return new g},this._setAutoAttach=function(t){i["super"].prototype._setAutoAttach.call(this,t),this.stage._setAutoAttach(t)},this._saveTransaction=function(t,e,n){if(!this.isTransacting)throw new Error("Not in a transaction.");this.isTransacting=!1;var i=this.stage.getOperations();if(i.length>0){var r=new f(i,t,e);this._apply(r,"skipStage"),this.done.push(r),this.undone=[],this._notifyChangeListeners(r,n)}},this._cancelTransaction=function(){if(!this.isTransacting)throw new Error("Not in a transaction.");this.isTransacting=!1},this._apply=function(t,e){if(this.isTransacting)throw new Error("Can not replay a document change during transaction.");"skipStage"!==e&&this.stage.apply(t),r.each(t.ops,function(t){this.data.apply(t),this._updateContainers(t),this.emit("operation:applied",t)},this)},this._notifyChangeListeners=function(t,e){e=e||{},this.containerAnnotationIndex.onDocumentChange(t),this.emit("document:changed",t,e,this)},this.updateEventProxies=function(t,e){r.each(this.eventProxies,function(n){n.onDocumentChanged(t,e,this)},this)}},o.inherit(i,a),Object.defineProperty(i.prototype,"id",{get:function(){return this.getDocumentMeta().guid},set:function(){throw new Error("Id is an immutable property.")}}),e.exports=i},{"../basics":33,"../basics/helpers":32,"../data":40,"./abstract_document":45,"./anchor_index":46,"./annotation_index":48,"./clipboard_exporter":51,"./clipboard_importer":52,"./container_annotation_index":55,"./document_change":59,"./path_event_proxy":78,"./transaction_document":84}],59:[function(t,e,n){"use strict";function i(t,e,n){this.id=r.uuid(),this.ops=t.slice(0),this.before=e,this.after=n,this.updated=null,this.created=null,this.deleted=null,this._init(),Object.freeze(this),Object.freeze(this.ops),Object.freeze(this.before),Object.freeze(this.after)}var r=t("../basics"),o=r.PathAdapter;i.Prototype=function(){this._init=function(){var t,e=this.ops,n={},i={},r=new o.Arrays;for(t=0;t<e.length;t++){var s=e[t];"create"===s.type&&(n[s.val.id]=s.val,delete i[s.val.id]),"delete"===s.type&&(delete n[s.val.id],delete r[s.val.id],i[s.val.id]=s.val),"set"!==s.type&&"update"!==s.type||r.add(s.path,s)}this.created=n,this.deleted=i,this.updated=r},this.isAffected=function(t){return!!this.updated.get(t)},this.isUpdated=this.isAffected,this.invert=function(){for(var t=[],e=this.ops.length-1;e>=0;e--)t.push(this.ops[e].invert());var n=this.after,r=this.before;return new i(t,n,r)},this.traverse=function(t,e){this.updated.traverse(function(){t.apply(e,arguments)})},this.getUpdates=function(t){return this.updated.get(t)||[]},this.getCreated=function(){return this.created},this.getDeleted=function(){return this.deleted}},r.initClass(i),e.exports=i},{"../basics":33}],60:[function(t,e,n){"use strict";function i(t,e){i["super"].call(this,t,e)}var r=t("../basics"),o=t("../data"),s=t("./node"),a=t("./annotation"),c=t("./container"),l=t("./container_annotation");i.Prototype=function(){this.getDefaultTextType=function(){throw new Error("DocumentSchema.getDefaultTextType() is abstract and must be overridden.")},this.isAnnotationType=function(t){var e=this.getNodeClass(t);return e&&e.prototype instanceof a},this.getBuiltIns=function(){return[s,a,c,l]}},r.inherit(i,o.Schema),e.exports=i},{"../basics":33,"../data":40,"./annotation":47,"./container":53,"./container_annotation":54,"./node":64}],61:[function(t,e,n){"use strict";function i(t){this.config=t||{},this.state=null}var r=t("../basics"),o=t("./annotator"),s="undefined"!=typeof window;i.Prototype=function(){this.convert=function(t,e){throw new Error("Method is abstract.")},this.getNodeConverter=function(t){return t.constructor},this.convertProperty=function(t,e,n){return this.initialize(t,n),$("<span>").append(this.annotatedText(e))},this.initialize=function(t,e){e={}||e,this.state={doc:t,options:e}},this.convertNode=function(t){var e=this.getNodeConverter(t);return e["static"].toHtml(t,this)},this.convertContainer=function(t){for(var e=this.state,n=t.nodes,i=[],r=0;r<n.length;r++){var o=e.doc.get(n[r]),s=this.convertNode(o);if(!s||!this.isElementNode(s[0]))throw new Error("Contract: Node.static.toHtml() must return a DOM element. NodeType: "+o.type);s.attr("id",o.id),i.push(s)}return i},this.annotatedText=function(t){var e=this,n=this.state.doc,i=n.getIndex("annotations").get(t);this.config.exportAnnotationFragments&&this.config.containerId&&(i=i.concat(n.containerAnnotationIndex.getFragments(t,this.config.containerId)));var r=n.get(t),s=new o;s.onText=function(t,e){t.children.push(e)},s.onEnter=function(t){var e=t.node;return{annotation:e,children:[]}},s.onExit=function(t,n,i){var r=n.annotation;if(!e.config.skipTypes||!e.config.skipTypes[r.type]){var o=e.getNodeConverter(r),s=o["static"].toHtml(r,e,n.children);if(!s||!e.isElementNode(s[0]))throw new Error("Contract: Annotation.toHtml() must return a DOM element.");s.attr("id",r.id),i.children.push(s)}};var a={children:[]};return s.start(a,r,i),a.children},this.isElementNode=function(t){return s?t.nodeType===window.Node.ELEMENT_NODE:"tag"===t.type},this.createHtmlDocument=function(){var t="<!DOCTYPE html><html><head></head><body></body></html>";if(s){var e=new window.DOMParser,n=e.parseFromString(t,"text/html");return $(n)}var i=$.load(t).root();return i},this.createXmlDocument=function(){var t='<article xmlns="http://www.w3.org/1999/xhtml"></article>';if(s){var e=new window.DOMParser,n=e.parseFromString(t,"text/xml");return $(n)}var i=$.load(t).root();return i}},r.initClass(i),e.exports=i},{"../basics":33,"./annotator":50}],62:[function(t,e,n){(function(n){function i(t){this.config=t||{},this.nodeTypesByName={},this.nodeTypes=[],this.blockTypes=[],this.inlineTypes=[],this.config.schema&&this.config.schema.each(function(t){this.defineNodeImporter(t)},this),this.$=n.$}var r=t("../basics"),o=r,s="undefined"!=typeof window;i.Prototype=function(){this.defineNodeImporter=function(t){t["static"].matchElement&&(this.nodeTypes.push(t),this.nodeTypesByName[t["static"].name]=t,t["static"].blockType?this.blockTypes.push(t):t["static"].isInline&&this.inlineTypes.push(t))},this.defaultConverter=function(t,e){console.warn("This element is not handled by the converters you provided. This is the default implementation which just skips conversion. Override HtmlImporter.defaultConverter(el, converter) to change this behavior.",this.$toStr(t));var n=this.state.doc.getSchema().getDefaultTextType(),i=this.nodeTypesByName[n];if(!i)throw new Error("Could not class for default text type",n);var r=i["static"].fromHtml(t,e);return r&&(r.type=n),r},this.initialize=function(t,e){var n={doc:t,$root:e,inlineNodes:[],trimWhitespaces:!!this.config.trimWhitespaces,stack:[],lastChar:"",skipTypes:{},ignoreAnnotations:!1};this.state=n},this.convert=function(t,e){throw new Error("This method is abstract.")},this.convertContainer=function(t,e){var n=this.state,o=n.doc,s=o.get(e);n.containerNode=s;for(var a=new i.ChildNodeIterator(t[0]);a.hasNext();){var c,l=a.next(),u=this.$(l),h=this._getBlockTypeForElement(u);if(h){if(c=h["static"].fromHtml(u,this),!c)throw new Error("Contract: a Node's fromHtml() method must return a node",this.$toStr(u));c.type=h["static"].name,c.id=c.id||u.attr("id")||r.uuid(c.type),o.create(c),s.show(c.id)}else if(this.isCommentNode(l));else if(this.isTextNode(l)){var f=u.text();if(/^\s*$/.exec(f))continue;a.back(),this.wrapInlineElementsIntoBlockElement(a)}else if(this.isElementNode(l)){var d=this._getInlineTypeForElement(u);d||"span"===this.getTagName(l)?(a.back(),this.wrapInlineElementsIntoBlockElement(a)):this.createDefaultBlockElement(u)}}},this.finish=function(){for(var t=this.state.doc,e=0;e<this.state.inlineNodes.length;e++)t.create(this.state.inlineNodes[e])},this.convertProperty=function(t,e,n){var i=this.$("<div>").html(n);this.initialize(t,i);var r=this.annotatedText(i,e);t.setText(e,r,this.state.inlineNodes)},this.convertElement=function(t,e){var n=this.state.doc,i=this._getNodeTypeForElement(t);if(!i)throw new Error("Could not find a node class associated to element:"+this.$toStr(t));var r=i["static"].fromHtml(t,this);return r.type=i["static"].name,r.id=r.id||this.defaultId(t,r.type),o.extend(r,e),n.create(r)},this.getDocument=function(){return this.state.doc},this.getTagName=function(t){return t.tagName?t.tagName.toLowerCase():""},this.isTextNode=function(t){return s?t.nodeType===window.Node.TEXT_NODE:"text"===t.type},this.isElementNode=function(t){return s?t.nodeType===window.Node.ELEMENT_NODE:"tag"===t.type},this.isCommentNode=function(t){return s?t.nodeType===window.Node.COMMENT_NODE:"comment"===t.type},this.wrapInlineElementsIntoBlockElement=function(t){for(var e=this.state,n=e.doc,i=e.containerNode,r=this.$("<div>");t.hasNext();){var o=t.next(),s=this.$(o),a=this._getBlockTypeForElement(s);if(a){t.back();break}r.append(s.clone())}var c=this.defaultConverter(r,this);if(c){if(!c.type)throw new Error("Contract: Html.defaultConverter() must return a node with type.");c.id=c.id||this.nextId(c.type),n.create(c),i.show(c.id)}},this.createDefaultBlockElement=function(t){var e=this.state,n=e.doc,i=e.containerNode,r=this.defaultConverter(t,this);if(r){if(!r.type)throw new Error("Contract: Html.defaultConverter() must return a node with type.",this.$toStr(t));r.id=r.id||this.defaultId(t,r.type),n.create(r),i.show(r.id)}},this.annotatedText=function(t,e){var n=this.state;if(e){if(n.stack.length>0)throw new Error("Contract: it is not allowed to bind a new call annotatedText to a path while the previous has not been completed.",this.$toStr(t));n.stack=[{path:e,offset:0,text:""}]}else if(0===n.stack.length)throw new Error("Contract: HtmlImporter.annotatedText() requires 'path' for non-reentrant call.",this.$toStr(t));var r=new i.ChildNodeIterator(t[0]),o=this._annotatedText(r);return e&&n.stack.pop(),o},this.plainText=function(t){var e=this.state,n=t.text();if(e.stack.length>0){var i=o.last(e.stack);i.offset+=n.length,i.text+=i.text.concat(n)}return n},this.customText=function(t){var e=this.state;if(e.stack.length>0){var n=o.last(e.stack);n.offset+=t.length,n.text+=n.text.concat(t)}return t},this.nextId=function(t){return r.uuid(t)},this.warning=function(t){console.warn("[HtmlImporter] "+t)},this.error=function(t){console.error("[HtmlImporter] "+t)},this.defaultId=function(t,e){for(var n=t.attr("id")||this.nextId(e);this.state.doc.get(n);)n=this.nextId(e);return n},this._annotatedText=function(t){var e=this.state,n=o.last(e.stack);if(!n)throw new Error("Illegal state: context is null.");for(;t.hasNext();){var i=t.next(),r=this.$(i),s="";if(this.isTextNode(i))s=this._prepareText(e,r.text()),s.length&&(n.text=n.text.concat(s),n.offset+=s.length);else{if(this.isCommentNode(i))continue;if(this.isElementNode(i)){var a=this._getInlineTypeForElement(r);if(!a){var c=this._getInlineTypeForElement(r);if(c)throw new Error("Expected inline element. Found block element:",this.$toStr(r));console.warn("Unsupported inline element. We will not create an annotation for it, but process its children to extract annotated text.",this.$toStr(r)),this.annotatedText(r);continue}var l,u=n.offset;if(a["static"].fromHtml){if(e.stack.push({path:n.path,offset:u,text:""}),l=a["static"].fromHtml(r,this),!l)throw new Error("Contract: a Node's fromHtml() method must return a node",this.$toStr(r));a["static"].external&&this.customText("");var h=e.stack.pop();n.offset=h.offset,n.text=n.text.concat(h.text)}else l={},this.annotatedText(r);var f=n.offset;l.type=a["static"].name,l.id=a.id||this.nextId(l.type),l.startOffset=u,l.endOffset=f,l.path=n.path.slice(0),e.inlineNodes.push(l)}else console.warn("Unknown element type. Taking plain text.",this.$toStr(r)),s=this._prepareText(e,r.text()),n.text=n.text.concat(s),n.offset+=s.length}}return n.text},this._getBlockTypeForElement=function(t){if(!t[0].tagName)return null;for(var e=0;e<this.blockTypes.length;e++)if(this.blockTypes[e]["static"].matchElement(t))return this.blockTypes[e]},this._getInlineTypeForElement=function(t){for(var e=0;e<this.inlineTypes.length;e++)if(this.inlineTypes[e]["static"].matchElement(t))return this.inlineTypes[e]},this._getNodeTypeForElement=function(t){for(var e=0;e<this.nodeTypes.length;e++)if(this.nodeTypes[e]["static"].matchElement(t))return this.nodeTypes[e]},this._getDomNodeType=function(t){if(this.isTextNode(t))return"text";if(this.isCommentNode(t))return"comment";if(t.tagName)return t.tagName.toLowerCase();throw new Error("Unknown node type")};var t=/^\s+/g,e=/^\s*/g,n=/\s+$/g,a=/\s+/g,c=" ",l=/[\t\n\r]+/g;this._prepareText=function(i,r){return i.trimWhitespaces?(r=r.replace(l,c),r=i.lastChar===c?r.replace(e,c):r.replace(t,c),r=r.replace(n,c),this.config.REMOVE_INNER_WS&&(r=r.replace(a,c)),i.lastChar=r[r.length-1]||i.lastChar,r):r},this.$toStr=function(t){var e=t.clone();return e.empty(),$("<p>").append(e).html()}},i.prototype=new i.Prototype,i.ChildNodeIterator=function(t){this.nodes=t.childNodes,this.length=this.nodes.length,this.pos=-1},i.ChildNodeIterator.Prototype=function(){this.hasNext=function(){return this.pos<this.length-1},this.next=function(){return this.pos+=1,this.nodes[this.pos]},this.back=function(){return this.pos>=0&&(this.pos-=1),this}},i.ChildNodeIterator.prototype=new i.ChildNodeIterator.Prototype,e.exports=i}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../basics":33}],63:[function(t,e,n){"use strict";var i=t("./document");i.Schema=t("./document_schema"),i.Node=t("./node"),i.Annotation=t("./annotation"),i.Container=t("./container"),i.ContainerAnnotation=t("./container_annotation"),i.TextNode=t("./text_node"),i.Coordinate=t("./coordinate"),i.Range=t("./range"),i.Selection=t("./selection"),i.nullSelection=i.Selection.nullSelection,i.PropertySelection=t("./property_selection"),i.ContainerSelection=t("./container_selection"),i.TableSelection=t("./table_selection"),i.Annotator=t("./annotator"),i.AnnotationUpdates=t("./annotation_updates"),i.HtmlImporter=t("./html_importer"),i.HtmlExporter=t("./html_exporter"),i.ClipboardImporter=t("./clipboard_importer"),i.ClipboardExporter=t("./clipboard_exporter"),i.Include=t("./nodes/include"),i.Paragraph=t("./nodes/paragraph"),i.Heading=t("./nodes/heading"),i.Emphasis=t("./nodes/emphasis"),i.Strong=t("./nodes/strong"),i.Link=t("./nodes/link"),i.Table=t("./nodes/table"),i.TableSection=t("./nodes/table_section"),i.TableRow=t("./nodes/table_row"),i.TableCell=t("./nodes/table_cell"),i.List=t("./nodes/list"),i.ListItem=t("./nodes/list_item"),i.Transformations=t("./transformations"),e.exports=i},{"./annotation":47,"./annotation_updates":49,"./annotator":50,"./clipboard_exporter":51,"./clipboard_importer":52,"./container":53,"./container_annotation":54,"./container_selection":56,"./coordinate":57,"./document":58,"./document_schema":60,"./html_exporter":61,"./html_importer":62,"./node":64,"./nodes/emphasis":65,"./nodes/heading":66,"./nodes/include":67,"./nodes/link":68,"./nodes/list":69,"./nodes/list_item":70,"./nodes/paragraph":71,"./nodes/strong":72,"./nodes/table":73,"./nodes/table_cell":74,"./nodes/table_row":76,"./nodes/table_section":77,"./property_selection":79,"./range":80,"./selection":81,"./table_selection":82,"./text_node":83,"./transformations":90}],64:[function(t,e,n){"use strict";var i=t("../basics"),r=t("../data"),o=r.Node.extend({name:"node",attach:function(t){this.document=t,this.didAttach(t)},detach:function(){var t=this.document;this.document=null,this.didDetach(t)},didAttach:function(){},didDetach:function(){},isAttached:function(){return null!==this.document},getDocument:function(){return this.document},hasParent:function(){return!!this.parent},getParent:function(){return this.document.get(this.parent)},getRoot:function(){for(var t=this;t.hasParent();)t=t.getParent();return t},getComponents:function(){var t=this.constructor["static"].components||[];return 0===t.length&&console.warn("Contract: a node must define its editable properties.",this.constructor["static"].name),t},isExternal:function(){return this.constructor["static"].external},toHtml:function(t,e){return this.constructor["static"].toHtml(this,t,e)}});o.initNodeClass=r.Node.initNodeClass,o["static"].toHtml=function(t,e){var n=$("<div itemscope>").attr("data-id",t.id).attr("data-type",t.type);return i.each(t.properties,function(i,r){var o=$("<div>").attr("itemprop",r);"string"===t.getPropertyType?o[0].appendChild(e.annotatedText([t.id,r])):o.text(i),n.append(o)}),n},o["static"].external=!1,e.exports=o},{"../basics":33,"../data":40}],65:[function(t,e,n){var i=t("../annotation"),r=i.extend({name:"emphasis",splitContainerSelections:!0});r["static"].tagName="em",r["static"].matchElement=function(t){return t.is("em,i")},r["static"].level=Number.MAX_VALUE,e.exports=r},{"../annotation":47}],66:[function(t,e,n){
var i=t("../text_node"),r=i.extend({name:"heading",properties:{level:"number"}});r["static"].blockType=!0,r["static"].tocType=!0,r["static"].matchElement=function(t){return/^h\d$/.exec(t[0].tagName.toLowerCase())},r["static"].fromHtml=function(t,e){var n=e.defaultId(t,"heading"),i={id:n,level:parseInt(""+t[0].tagName[1],10),content:""};return i.content=e.annotatedText(t,[n,"content"]),i},r["static"].toHtml=function(t,e){var n=t.id,i=$("<h"+t.level+">");return i.append(e.annotatedText([n,"content"])),i},e.exports=r},{"../text_node":83}],67:[function(t,e,n){var i=t("../node"),r=i.extend({name:"include",properties:{nodeType:"string",nodeId:"id"},getIncludedNode:function(){return this.getDocument().get(this.nodeId)}});r["static"].components=["nodeId"],r["static"].blockType=!0,r["static"].matchElement=function(t){return t.is("include")},r["static"].fromHtml=function(t,e){var n=e.defaultId(t,"include"),i={id:n,nodeId:t.attr("data-rid"),nodeType:t.attr("data-rtype")};return i},r["static"].toHtml=function(t,e){var n=t.id,i=$("<include>").attr("id",n).attr("data-rtype",t.nodeType).attr("data-rid",t.nodeId);return i},e.exports=r},{"../node":64}],68:[function(t,e,n){var i=t("../annotation"),r=i.extend({name:"link",properties:{url:"string"}});r["static"].tagName="a",r["static"].matchElement=function(t){return t.is("a")},r["static"].fromHtml=function(t,e){var n={url:t.attr("href")};return e.annotatedText(t),n},r["static"].toHtml=function(t,e,n){var r=i["static"].toHtml(t,e,n);return r.attr("href",t.url),r},e.exports=r},{"../annotation":47}],69:[function(t,e,n){"use strict";var i=t("../../basics/helpers"),r=t("../node"),o=r.extend({name:"list",properties:{ordered:"bool",items:["array","id"]},getItems:function(){var t=this.getDocument();return i.map(this.items,function(e){return t.get(e)},this)}});o["static"].components=["items"],o["static"].blockType=!0,o["static"].matchElement=function(t){return t.is("ul,ol")},o["static"].fromHtml=function(t,e){var n=e.defaultId(t,"list"),i={id:n,ordered:!1,items:[]};t.is("ol")&&(i.ordered=!0);var r=1;return t.children().each(function(){var t=$(this);if(t.is("li")){var o=e.convertElement(t,{parent:n,level:r});i.items.push(o.id)}else e.warning("List: unsupported child element. "+e.$toStr(t))}),i},o["static"].toHtml=function(t,e){var n=t.ordered?"ol":"ul",r=t.id,o=("<"+n+">").attr("id",r);return i.each(t.getItems(),function(t){o.append(t.toHtml(e))}),o},Object.defineProperties(o.prototype,{itemNodes:{get:function(){return this.getItems()}}}),e.exports=o},{"../../basics/helpers":32,"../node":64}],70:[function(t,e,n){var i=t("../node"),r=i.extend({name:"list-item",properties:{parent:"id",level:"number",content:"string"}});r["static"].components=["content"],r["static"].matchElement=function(t){return t.is("li")},r["static"].fromHtml=function(t,e){var n=t.data("level")||1,i=e.defaultId(t,"li"),r={id:i,level:n,content:""};return r.content=e.annotatedText(t,[i,"content"]),r},r["static"].toHtml=function(t,e){var n=t.id,i=$("<li>").attr("id",t.id).data("level",t.level).append(e.annotatedText([n,"content"]));return i},e.exports=r},{"../node":64}],71:[function(t,e,n){var i=t("../text_node"),r=i.extend({name:"paragraph"});r["static"].blockType=!0,r["static"].matchElement=function(t){return t.is("p")},r["static"].fromHtml=function(t,e){var n=e.defaultId(t,"p"),i={id:n,content:""};return i.content=e.annotatedText(t,[n,"content"]),i},r["static"].toHtml=function(t,e){var n=t.id,i=$("<p>").attr("id",n);return i.append(e.annotatedText([n,"content"])),i},e.exports=r},{"../text_node":83}],72:[function(t,e,n){var i=t("../annotation"),r=i.extend({name:"strong",splitContainerSelections:!0});r["static"].tagName="strong",r["static"].matchElement=function(t){return t.is("strong,b")},r["static"].level=Number.MAX_VALUE,e.exports=r},{"../annotation":47}],73:[function(t,e,n){var i=t("../../basics/oo"),r=t("../../basics/helpers"),o=t("../node"),s=t("./table_matrix"),a=o.extend({name:"table",matrix:null,properties:{sections:["array","id"]},getSections:function(){var t=this.getDocument();return r.map(this.sections,function(e){return t.get(e)},this)},getSectionAt:function(t){var e=this.getDocument(),n=this.sections[t];return n?e.get(n):null},attach:function(){this["super"].attach.apply(this,arguments)},getMatrix:function(){return this.matrix||(this.matrix=new s(this),this.matrix.update()),this.matrix},getIterator:function(){return new a.CellIterator(this)},getSize:function(t){var e=this.matrix.getSize();return"row"===t?e[0]:"col"===t?e[1]:e}});a["static"].components=["sections"],a["static"].blockType=!0,a["static"].matchElement=function(t){return t.is("table")},a["static"].fromHtml=function(t,e){var n=e.defaultId(t,"table"),i={id:n,sections:[]};if(r.each(["thead","tbody","tfoot"],function(r){var o=t.find(r);if(o.length){var s=e.convertElement(o,{parent:n});i.sections.push(s.id)}}),0===i.sections.length){var o={id:e.nextId("tbody"),parent:n,type:"table-section",sectionType:"body",rows:[]};t.find("tr").each(function(){var t=$(this),i=e.convertElement(t,{parent:n});o.rows.push(i.id)}),e.getDocument().create(o),i.sections.push(o.id)}return i},a["static"].toHtml=function(t,e){var n=t.id,i=$("<table>").attr("id",n);return r.each(t.getSections(),function(t){i.append(t.toHtml(e))}),i},Object.defineProperties(a.prototype,{rowNodes:{get:function(){return this.getRows()}}}),a.CellIterator=function(t){this.table=t,this.__it={sectionIndex:-1,rowIndex:-1,rowNode:null,cellIndex:-1,cellNode:null,sectionNode:null,finished:!1},this.onNewSection=function(){},this.onNewRow=function(){}},a.CellIterator.Prototype=function(){this.next=function(){if(this.__it.finished)throw new Error("TableCellIterator has no more cells left.");return this.nextCell(this.__it),this.__it.finished?null:this.__it.cellNode},this.nextSection=function(t){t.sectionIndex++,t.sectionNode=this.table.getSectionAt(t.sectionIndex),t.sectionNode?(t.rowIndex=0,t.rowNode=t.sectionNode.getRowAt(0),this.onNewSection(t.sectionNode)):t.finished=!0},this.nextRow=function(t){for(t.rowIndex++,t.sectionNode&&(t.rowNode=t.sectionNode.getRowAt(t.rowIndex));!t.rowNode&&!t.finished;)this.nextSection(t);t.rowNode&&(t.cellIndex=0,t.cellNode=t.rowNode.getCellAt(0),this.onNewRow(t.rowNode))},this.nextCell=function(t){for(t.cellNode&&(t.cellIndex++,t.cellNode=t.rowNode.getCellAt(t.cellIndex));!t.cellNode&&!t.finished;)this.nextRow(t)}},i.initClass(a.CellIterator),e.exports=a},{"../../basics/helpers":32,"../../basics/oo":34,"../node":64,"./table_matrix":75}],74:[function(t,e,n){var i=t("../node"),r=i.extend({name:"table-cell",properties:{parent:"id",cellType:"string",colspan:"number",rowspan:"number",content:"string"},getSpan:function(t){return"col"===t?this.colspan||1:"row"===t?this.rowspan||1:void 0}});r["static"].components=["content"],r["static"].matchElement=function(t){return t.is("th, td")},r["static"].fromHtml=function(t,e){var n=e.defaultId(t,"tcell"),i={id:n,content:""};t.is("th")?i.cellType="head":i.cellType="data";var r=t.attr("colspan");r&&(i.colspan=parseInt(r,10));var o=t.attr("rowspan");return o&&(i.rowspan=parseInt(o,10)),i.content=e.annotatedText(t,[n,"content"]),i},r["static"].toHtml=function(t,e){var n=t.id,i="head"===t.cellType?"th":"td",r=$("<"+i+">").attr("id","id").append(e.annotatedText([n,"content"]));return r},Object.defineProperties(r.prototype,{isData:{get:function(){return"data"===this.cellType}}}),e.exports=r},{"../node":64}],75:[function(t,e,n){function i(t){this.tableNode=t,this._matrix=null,this._rowNodes=null}var r=t("../../basics/oo");i.Prototype=function(){this.invalidate=function(){this._matrix=null,this._rowNodes=null},this.update=function(){var t,e,n,r,o,s,a,c,l=[],u=[],h=this.tableNode.getIterator(),f=-1,d=-1;for(h.onNewRow=function(t){f++,d=-1,l[f]=l[f]||[],u.push(t)};null!==(t=h.next());){for(d++;l[f][d];)d++;if(e=new i.Cell(t,f,d),t.rowIdx=f,t.colIdx=d,l[f][d]=e,n=t.getSpan("row"),r=t.getSpan("col"),1!==n||1!==r)for(o=0;o<n;o++)for(s=0;s<r;s++)0===o&&0===s||(a=f+o,c=d+s,l[a]=l[a]||[],l[a][c]=new i.Placeholder(e,a,c))}this._matrix=l,this._rowNodes=u},this.getCell=function(t,e){var n=this.getMatrix();return n[t][e]},this.getColumn=function(t){var e,n,i=this.getMatrix();for(e=[],n=0;n<i.length;n++)e.push(i[n][t]);return e},this.getRow=function(t){var e=this.getMatrix();return e[t]},this.getRowNode=function(t){var e=this.getRowNodes();return e[t]},this.getMatrix=function(){return this._matrix||this.update(),this._matrix},this.getRowNodes=function(){return this._rowNodes||this.update(),this._rowNodes},this.getRectangle=function(t,e){var n,r,o,s,a,c;return(n=this.lookupCell(t))?(r=t===e?n:this.lookupCell(e),o=Math.min(n.row,r.row),s=Math.max(n.row,r.row),a=Math.min(n.col,r.col),c=Math.max(n.col,r.col),new i.Rectangle(o,a,s,c)):null},this.getCellsForRectangle=function(t){var e,n,i,r,o;for(i=[],r={},e=t.start.row;e<=t.end.row;e++)for(n=t.start.col;n<=t.end.col;n++)o=this.getCell(e,n),"placeholder"===o.type&&(o=o.owner),r[o.key]||(i.push(o),r[o.key]=!0);return i},this.getBoundingRectangle=function(t){var e,n,r;if(t=i.Rectangle.copy(t),e=this.getCellsForRectangle(t),!e||0===e.length)return null;for(r=0;r<e.length;r++)n=e[r],t.start.row=Math.min(t.start.row,n.row),t.start.col=Math.min(t.start.col,n.col),t.end.row=Math.max(t.end.row,n.row+n.node.getSpan("row")-1),t.end.col=Math.max(t.end.col,n.col+n.node.getSpan("col")-1);return t},this.getSize=function(){var t=this.getMatrix();return 0===t.length?{rows:0,cols:0}:{rows:t.length,cols:t[0].length}},this.lookupCell=function(t){var e,n,i,r,o=this.getMatrix(),s=this.getRowNodes();if(e=s.indexOf(t.parent),e<0)return null;for(i=null,r=o[e],n=0;n<r.length&&(i=r[n],i.node!==t);n++);return i},this.findClosestCell=function(t){var e,n,i=this.getMatrix();for(n=i[t.row],e=t.col;e>=0;e--)if("cell"===n[e].type)return n[e];for(e=t.col+1;e<n.length;e++)if("cell"===n[e].type)return n[e];return null}},r.initClass(i),i.Cell=function(t,e,n){this.type="cell",this.node=t,this.row=e,this.col=n,this.key=e+"_"+n},i.Cell.sortDescending=function(t,e){return t.row!==e.row?e.row-t.row:e.col-t.col},i.Placeholder=function(t,e,n){i.Cell.call(this,t.node,e,n),this.type="placeholder",this.owner=t},r.inherit(i.Placeholder,i.Cell),i.Rectangle=function(t,e,n,i){this.start={row:t,col:e},this.end={row:n,col:i}},i.Rectangle.copy=function(t){return new i.Rectangle(t.start.row,t.start.col,t.end.row,t.end.col)},e.exports=i},{"../../basics/oo":34}],76:[function(t,e,n){var i=t("../node"),r=t("../../basics/helpers"),o=i.extend({name:"table-row",properties:{parent:"id",cells:["array","id"]},getCells:function(){var t=this.getDocument();return r.map(this.cells,function(e){return t.get(e)},this)},getCellAt:function(t){var e=this.getDocument(),n=this.cells[t];return n?e.get(n):null}});o["static"].components=["cells"],o["static"].matchElement=function(t){return t.is("tr")},o["static"].fromHtml=function(t,e){var n=e.defaultId(t,"tr"),i={id:n,cells:[]};return t.find("th,td").each(function(){var t=$(this),r=e.convertElement(t,{parent:n});i.cells.push(r.id)}),i},o["static"].toHtml=function(t,e){var n=t.id,i=$("<tr>").attr("id",n);return r.each(t.getCells(),function(t){i.append(t.toHtml(e))}),i},Object.defineProperties(o.prototype,{cellNodes:{get:function(){return this.getCells()}}}),e.exports=o},{"../../basics/helpers":32,"../node":64}],77:[function(t,e,n){var i=t("../node"),r=t("../../basics/helpers"),o=i.extend({name:"table-section",properties:{parent:"id",rows:["array","id"],sectionType:"string"},getRows:function(){var t=this.getDocument();return r.map(this.rows,function(e){return t.get(e)},this)},getRowAt:function(t){var e=this.getDocument(),n=this.rows[t];return n?e.get(n):null}});o["static"].components=["rows"],o["static"].matchElement=function(t){return t.is("thead, tbody, tfoot")},o["static"].fromHtml=function(t,e){var n=t[0].tagName.toLowerCase(),i=n.substring(1),r=e.defaultId(t,n),o={id:r,sectionType:i,rows:[]};return t.find("tr").each(function(){var t=$(this),n=e.convertElement(t,{parent:r});o.rows.push(n.id)}),o},o["static"].toHtml=function(t,e){var n=t.id,i=$("<t"+t.sectionType+">").attr("id",n);return r.each(t.getRows(),function(t){i.append(t.toHtml(e))}),i},Object.defineProperties(o.prototype,{cellNodes:{get:function(){return this.getCells()}}}),e.exports=o},{"../../basics/helpers":32,"../node":64}],78:[function(t,e,n){"use strict";var i=t("../basics/helpers"),r=t("../basics/oo"),o=t("../basics/path_adapter"),s=function(t){this.listeners=new o,this._list=[],this.doc=t};s.Prototype=function(){this.onDocumentChanged=function(t,e,n){function r(e,n){t.deleted[e[0]]||a.add(e,n)}function o(t,e,i,o){var s=n.get(t),a=s.getComponent(e),c=s.getComponent(i);if(a&&c)for(var l=a.getIndex(),u=c.getIndex(),h=a,f=l;h&&f<=u;f++,h=h.getNext())r(h.getPath(),o);else r(e,o),r(i,o)}var s=this.listeners,a=t.updated;i.each(t.ops,function(t){if("create"!==t.type&&"delete"!==t.type||!t.val.path&&!t.val.startPath)if("set"!==t.type||"path"!==t.path[1]&&"startPath"!==t.path[1]&&"endPath"!==t.path[1]){if("set"===t.type&&("startOffset"===t.path[1]||"endOffset"===t.path[1])){var e=this.doc.get(t.path[0]);e&&(e.path?r(e.path,t):o(e.container,e.startPath,e.endPath,t))}}else r(t.val,t),r(t.original,t);else t.val.path?r(t.val.path,t):t.val.startPath&&o(t.val.container,t.val.startPath,t.val.endPath,t)},this),t.traverse(function(r){var o=r.concat(["listeners"]),a=s.get(o);i.each(a,function(i){i.method.call(i.listener,t,e,n)})},this)},this.add=function(t,e,n){var i=t.concat(["listeners"]),r=this.listeners.get(i);if(r||(r=[],this.listeners.set(i,r)),!n)throw new Error("Invalid argument: expected function but got "+n);r.push({method:n,listener:e})},this.connect=function(t,e,n){this.add(e,t,n)},this.remove=function(t,e){var n=t.concat(["listeners"]),i=this.listeners.get(n);if(i)for(var r=0;r<i.length;r++)if(i[r].listener===e)return void i.splice(r,1)},this.disconnect=function(t,e){this.remove(e,t)}},r.initClass(s),e.exports=s},{"../basics/helpers":32,"../basics/oo":34,"../basics/path_adapter":35}],79:[function(t,e,n){"use strict";function i(t){var e=t.path,n=t.startOffset,i=t.endOffset||t.startOffset;if(!e||!r.isNumber(n))throw new Error("Invalid arguments: `path` and `startOffset` are mandatory");this.range=new c(new a(e,n),new a(e,i)),this.reverse=t.reverse,this._internal={},Object.freeze(this)}var r=t("../basics/helpers"),o=t("../basics/oo"),s=t("./selection"),a=t("./coordinate"),c=t("./range");i.Prototype=function(){r.extend(this,s.prototype),this.toJSON=function(){return{type:"property",path:this.path,startOffset:this.startOffset,endOffset:this.endOffset,reverse:this.reverse}},this.attach=function(t){return this._internal.doc=t,this},this.isNull=function(){return!1},this.getRanges=function(){return[this.range]},this.getRange=function(){return this.range},this.isCollapsed=function(){return this.range.isCollapsed()},this.isReverse=function(){return this.reverse},this.isPropertySelection=function(){return!0},this.isMultiSeletion=function(){return!1},this.equals=function(t){return s.prototype.equals.call(this,t)&&!t.isTableSelection()&&this.range.equals(t.range)},this.collapse=function(t){var e;return e="left"===t?this.range.start:this.range.end,this.createWithNewRange(e.offset,e.offset)},this.getPath=function(){return this.range.start.path},this.getStartOffset=function(){return this.range.start.offset},this.getEndOffset=function(){return this.range.end.offset},this.toString=function(){return["PropertySelection(",JSON.stringify(this.range.start.path),", ",this.range.start.offset," -> ",this.range.end.offset,this.reverse?", reverse":"",this.range.start.after?", after":"",")"].join("")},this.isInsideOf=function(t,e){return!t.isNull()&&(t.isContainerSelection()?t.contains(this):e?r.isEqual(this.path,t.path)&&this.start.offset>t.start.offset&&this.end.offset<t.end.offset:r.isEqual(this.path,t.path)&&this.start.offset>=t.start.offset&&this.end.offset<=t.end.offset)},this.contains=function(t,e){return!t.isNull()&&(t.isContainerSelection()?t.isInsideOf(this):e?r.isEqual(this.path,t.path)&&this.start.offset<t.start.offset&&this.end.offset>t.end.offset:r.isEqual(this.path,t.path)&&this.start.offset<=t.start.offset&&this.end.offset>=t.end.offset)},this.overlaps=function(t,e){return!t.isNull()&&(t.isContainerSelection()?t.overlaps(this):!!r.isEqual(this.getPath(),t.getPath())&&(e?!(this.startOffset>=t.endOffset||this.endOffset<=t.startOffset):!(this.startOffset>t.endOffset||this.endOffset<t.startOffset)))},this.isRightAlignedWith=function(t){return!t.isNull()&&(t.isContainerSelection()?t.isRightAlignedWith(this):r.isEqual(this.getPath(),t.getPath())&&this.getEndOffset()===t.getEndOffset())},this.isLeftAlignedWith=function(t){return!t.isNull()&&(t.isContainerSelection()?t.isLeftAlignedWith(this):r.isEqual(this.getPath(),t.getPath())&&this.getStartOffset()===t.getStartOffset())},this.expand=function(t){if(t.isNull())return this;if(t.isContainerSelection())return t.expand(this);if(!r.isEqual(this.path,t.path))throw new Error("Can not expand PropertySelection to a different property.");var e=Math.min(this.startOffset,t.startOffset),n=Math.max(this.endOffset,t.endOffset);return this.createWithNewRange(e,n)},this.createWithNewRange=function(t,e){return new i({path:this.path,startOffset:t,endOffset:e})},this.truncate=function(t){if(t.isNull())return this;if(!r.isEqual(this.start.path,t.start.path)||!r.isEqual(this.end.path,t.end.path))throw new Error("Can not expand PropertySelection to a different property.");var e,n;return this.startOffset===t.startOffset?(e=t.endOffset,n=this.endOffset):this.endOffset===t.endOffset&&(e=this.startOffset,n=t.startOffset),this.createWithNewRange(e,n)},this._coordinates=function(){return this}},o.inherit(i,s),Object.defineProperties(i.prototype,{start:{get:function(){return this.range.start},set:function(){throw new Error("immutable.")}},end:{get:function(){return this.range.end},set:function(){throw new Error("immutable.")}},path:{get:function(){return this.range.start.path},set:function(){throw new Error("immutable.")}},startOffset:{get:function(){return this.range.start.offset},set:function(){throw new Error("immutable.")}},endOffset:{get:function(){return this.range.end.offset},set:function(){throw new Error("immutable.")}},collapsed:{get:function(){return this.isCollapsed()},set:function(){throw new Error("immutable.")}}}),e.exports=i},{"../basics/helpers":32,"../basics/oo":34,"./coordinate":57,"./range":80,"./selection":81}],80:[function(t,e,n){"use strict";var i=t("../basics"),r=function(t,e){this.start=t,this.end=e,Object.freeze(this)};r.Prototype=function(){this.isCollapsed=function(){return this.start.equals(this.end)},this.equals=function(t){return this===t||this.start.equals(t.start)&&this.end.equals(t.end)}},i.initClass(r),e.exports=r},{"../basics":33}],81:[function(t,e,n){"use strict";function i(){}var r=t("../basics");i.Prototype=function(){this.getRanges=function(){return[]},this.isNull=function(){return!1},this.isMultiSeletion=function(){return!1},this.isPropertySelection=function(){return!1},this.isContainerSelection=function(){return!1},this.isTableSelection=function(){return!1},this.isCollapsed=function(){return!0},this.isReverse=function(){return!1},this.equals=function(t){return this===t||!!t&&this.isNull()===t.isNull()},this.toString=function(){return"null"}},r.initClass(i);var o=function(){};o.Prototype=function(){this.isNull=function(){return!0}},r.inherit(o,i),i.nullSelection=Object.freeze(new o),e.exports=i},{"../basics":33}],82:[function(t,e,n){"use strict";function i(t){if(this.tableId=t.tableId,t.rectangle?this.rectangle=t.rectangle:this.rectangle=new i.Rectangle(t.startRow,t.startCol,t.endRow,t.endCol),!this.tableId)throw new Error("Invalid arguments. `tableId` is mandatory.");this._internal={},Object.freeze(this)}var r=t("../basics"),o=(t("../basics/helpers"),t("./selection"));i.Prototype=function(){this.isPropertySelection=function(){return!1},this.isTableSelection=function(){return!0},this.isSingleCell=function(){return this.rectangle.isSingleCell()},this.getTableId=function(){return this.tableId},this.getRectangle=function(){return this.rectangle},this.equals=function(t){return o.prototype.equals.call(this,t)&&!t.isTableSelection()&&this.startRow===t.startRow&&this.endRow===t.endRow&&this.startCol===t.startCol&&this.ednCol===t.endCol},this.toString=function(){var t=this.rectangle;return"T[("+t.start.row+","+t.start.col+"), ("+t.end.row+", "+t.end.col+")]"},this.attach=function(t){return this._internal.doc=t,this}},r.inherit(i,o),Object.defineProperties(i.prototype,{startRow:{get:function(){return this.rectangle.start.row}},endRow:{get:function(){return this.rectangle.end.row}},startCol:{get:function(){return this.rectangle.start.col}},endCol:{get:function(){return this.rectangle.end.col}}}),i.Rectangle=function(t,e,n,i){var r=Math.min(t,n),o=Math.max(t,n),s=Math.min(e,i),a=Math.max(e,i);this.start={row:r,col:s},this.end={row:o,col:a},Object.freeze(this.start),Object.freeze(this.end),Object.freeze(this)},i.Rectangle.prototype.isSingleCell=function(){return this.start.row===this.end.row&&this.start.col===this.end.col},e.exports=i},{"../basics":33,"../basics/helpers":32,"./selection":81}],83:[function(t,e,n){"use strict";var i=t("./node"),r=i.extend({name:"text",properties:{content:"string"}});r["static"].components=["content"],e.exports=r},{"./node":64}],84:[function(t,e,n){"use strict";function i(t){s.call(this,t.schema),this.__id__="TX_"+a++,this.document=t,this.ops=[],this.before={},r.each(t.data.indexes,function(t,e){this.data.addIndex(e,t.clone())},this),this.loadSeed(t.toJSON())}var r=t("../basics/helpers"),o=t("../basics/oo"),s=t("./abstract_document"),a=0;i.Prototype=function(){this.isTransaction=function(){return!0},this.reset=function(){this.ops=[],this.before={},this._resetContainers()},this.create=function(t){var e=this.data.create(t);if(e)return this.document.isTransacting&&this.ops.push(e),this.data.get(t.id)},this["delete"]=function(t){var e=this.data["delete"](t);if(e)return this.document.isTransacting&&this.ops.push(e),e},this.set=function(t,e){var n=this.data.set(t,e);if(n)return this._updateContainers(n),this.document.isTransacting&&this.ops.push(n),n},this.update=function(t,e){var n=this.data.update(t,e);if(n)return this._updateContainers(n),this.document.isTransacting&&this.ops.push(n),n},this.save=function(t,e){var n=this.before,i=r.extend({},n,t);this.document._saveTransaction(n,i,e),this.reset()},this.cancel=function(){for(var t=this.ops.length-1;t>=0;t--)this.data.apply(this.ops[t].invert());this.document._cancelTransaction(),this.reset()},this.finish=function(){this.document.isTransacting&&this.cancel()},this.cleanup=this.finish,this.getOperations=function(){return this.ops},this.apply=function(t){r.each(t.ops,function(t){this.data.apply(t),this._updateContainers(t)},this)},this.getIndex=function(t){return this.data.getIndex(t)},this._didCreateNode=function(t){t.document=this},this._didDeleteNode=function(t){t.document=null},this.createSelection=function(){return this.document.createSelection.apply(this,arguments)},this.getSchema=function(){return this.schema}},o.inherit(i,s),e.exports=i},{"../basics/helpers":32,"../basics/oo":34,"./abstract_document":45}],85:[function(t,e,n){"use strict";function i(t,e){if(!e.selection)throw new Error("Argument 'selection' is mandatory.");if(!e.containerId)throw new Error("Argument 'containerId' is mandatory.");if(!e.selection.isCollapsed()){var n=s(t,e);e.selection=n.selection}var i=e.selection.getRange(),o=t.get(i.start.path[0]);return o.isInstanceOf("text")?r(t,e):(console.info("Breaking is not supported for node type %s.",o.type),e)}function r(t,e){var n=e.selection,i=e.containerId;if(!n.isPropertySelection())throw new Error("Expected property selection.");var r,s=n.getRange(),c=s.start.path,l=s.start.offset,u=t.get(c[0]),h=u.content,f=t.get(i),d=f.getPosition(u.id),p=o.uuid(u.type),g=[p,"content"];return 0===l?(r=t.create({id:p,type:u.type,content:""}),f.show(p,d),n=t.createSelection({type:"property",path:c,startOffset:0})):(r=t.create({id:p,type:t.getSchema().getDefaultTextType(),content:h.substring(l)}),l<h.length&&(a.transferAnnotations(t,c,l,[p,"content"],0),t.update(c,{"delete":{start:l,end:h.length}})),f.show(p,d+1),n=t.createSelection({type:"property",path:g,startOffset:0})),{selection:n,node:r}}var o=t("../../basics"),s=t("./delete_selection"),a=t("../annotation_updates");e.exports=i},{"../../basics":33,"../annotation_updates":49,"./delete_selection":89}],86:[function(t,e,n){var i=t("../../basics/helpers"),r=t("../annotation_updates"),o=function(t,e){var n=e.selection;return n.isNull()?e.doc=null:n.isPropertySelection()||i.isEqual(n.start.path,n.end.path)?e.doc=s(t,n):n.isContainerSelection()?e.doc=a(t,n):(console.error("Copy is not yet supported for selection type."),e.doc=null),e},s=function(t,e){var n=t.newInstance();n._setForClipboard(!0);var r=e.start.path,s=e.start.offset,a=e.end.offset,c=t.get(r),l=n.get(o.CLIPBOARD_CONTAINER_ID);l||(l=n.create({type:"container",id:o.CLIPBOARD_CONTAINER_ID,nodes:[]})),n.create({type:t.schema.getDefaultTextType(),id:"text",content:c.substring(s,a)}),l.show("text");var u=t.getIndex("annotations").get(r,s,a);return i.each(u,function(t){var e=i.deepclone(t.toJSON());e.path=["text","content"],e.startOffset=Math.max(s,t.startOffset)-s,e.endOffset=Math.min(a,t.endOffset)-s,n.create(e)}),n},a=function(t,e){var n=t.newInstance();n._setForClipboard(!0);var s,a,c=t.getIndex("annotations"),l=t.get(e.containerId),u=l.getComponent(e.start.path),h=l.getComponent(e.end.path),f=n.create({type:"container",id:o.CLIPBOARD_CONTAINER_ID,nodes:[]}),d={};for(s=u.getIndex();s<=h.getIndex();s++){a=l.getComponentAt(s);var p=a.parentNode.id,g=t.get(p);d[p]||(d[p]=n.create(g.toJSON()),f.show(p));for(var v=c.get(a.path),y=0;y<v.length;y++)n.create(i.deepclone(v[y].toJSON()))}var m,b=u.parentNode;for(s=0;s<b.components.length;s++){if(a=b.components[s],a===u){e.start.offset>0&&(m=t.get(a.path),n.update(a.path,{"delete":{start:0,end:e.start.offset}}),r.deletedText(n,a.path,0,e.start.offset));break}n.set(a.path,"")}var w=h.parentNode;for(s=0;s<w.components.length;s++){if(a=w.components[s],a===h){m=t.get(a.path),e.end.offset<m.length&&(n.update(a.path,{"delete":{start:e.end.offset,end:m.length}}),r.deletedText(n,a.path,e.end.offset,m.length));break}n.set(a.path,"")}return n};o.CLIPBOARD_CONTAINER_ID="clipboard_content",e.exports=o},{"../../basics/helpers":32,"../annotation_updates":49}],87:[function(t,e,n){"use strict";var i=t("../annotation_updates"),r=t("./merge"),o=function(t,e){var n,o,s=e.selection,a=e.direction,c=s.getRange();if(!s.isCollapsed())throw new Error('Selection must be collapsed for transformation "deleteCharacter"');var l=t.get(c.start.path);if(0===c.start.offset&&"left"===a||c.start.offset===l.length&&"right"===a){var u=r(t,{selection:s,containerId:e.containerId,path:c.start.path,direction:a});s=u.selection}else n="left"===a?c.start.offset-1:c.start.offset,o=n+1,t.update(c.start.path,{"delete":{start:n,end:o}}),i.deletedText(t,c.start.path,n,o),s=t.createSelection({type:"property",path:c.start.path,startOffset:n});return{selection:s}};e.exports=o},{"../annotation_updates":49,"./merge":93}],88:[function(t,e,n){"use strict";function i(t,e){if(!e.nodeId)throw new Error("Parameter `nodeId` is mandatory.");var n,i=e.nodeId,o=t.getIndex("annotations").get(i);for(n=0;n<o.length;n++)t["delete"](o[n].id);var s=t.getIndex("container-annotation-anchors").get(i);for(n=0;n<s.length;n++){var a=s[n],c=t.get(a.container);if(t.get(a.id)){var l=c.getComponent(a.path);if(a.isStart)l.hasNext()?(t.set([a.id,"startPath"],l.next.path),t.set([a.id,"startOffset"],0)):t["delete"](a.id);else if(l.hasPrevious()){var u=t.get(l.previous.path).length;t.set([a.id,"endPath"],l.previous.path),t.set([a.id,"endOffset"],u)}else t["delete"](a.id)}}r.each(t.getIndex("type").get("container"),function(t){t.hide(i)}),t["delete"](i)}var r=t("../../basics/helpers");e.exports=i},{"../../basics/helpers":32}],89:[function(t,e,n){"use strict";function i(t,e){var n,i=e.selection;return n=i.isCollapsed()?c(t,e):i.isPropertySelection()?r(t,e):o(t,e)}function r(t,e){var n=e.selection.getRange(),i=n.start.path,r=n.start.offset,o=n.end.offset;return t.update(i,{"delete":{start:r,end:o}}),h.deletedText(t,i,r,o),{selection:t.createSelection({type:"property",path:i,startOffset:r})}}function o(t,e){for(var n,i,r,o=e.selection,c=o.containerId,h=o.getRange(),d=a(t,o),p={selection:null},g=t.get(c),v=g.getPosition(d[0].node.id),y=d.length-1;y>=0;y--)n=d[y],i=n.node,n.isFully?l(t,{nodeId:i.id}):s(t,n);if(d[0].isFully){p.selection=null;for(var m=1;m<d.length;m++)if(n=d[m],!n.isFully){p.selection=t.createSelection({type:"property",path:n.components[0].path,startOffset:0});break}null===p.selection&&(r=t.getSchema().getDefaultTextType(),i={type:r,id:f.uuid(r),content:""},t.create(i),g.show(i.id,v),p.selection=t.createSelection({type:"property",path:[i.id,"content"],startOffset:0}))}else p.selection=t.createSelection({type:"property",path:h.start.path,startOffset:h.start.offset});if(d.length>1){var b=d[0],w=d[d.length-1];if(b.isFully||w.isFully);else{var x=f.last(w.components);p=u(t,{selection:p.selection,containerId:c,path:x.path,direction:"left"})}}return g=t.get(c),0===g.nodes.length&&(r=t.getSchema().getDefaultTextType(),i={type:r,id:f.uuid(r),content:""},t.create(i),g.show(i.id,0),p.selection=t.createSelection({type:"property",path:[i.id,"content"],startOffset:0})),p}function s(t,e){for(var n=e.components,i=n.length,o=0;o<i;o++){var s=n[o],a=0,c=t.get(s.path).length;0===o&&(a=e.startOffset),o===i-1&&(c=e.endOffset),r(t,{selection:t.createSelection({type:"property",path:s.path,startOffset:a,endOffset:c})})}}function a(t,e){for(var n=[],i={},r=e.getRange(),o=t.get(e.containerId),s=o.getComponentsForRange(r),a=0;a<s.length;a++){var c=s[a],l=t.get(c.rootId);if(!l)throw new Error("Illegal state: expecting a component to have a proper root node id set.");var u,h=l.id;i[h]||(u={node:l,isFully:!0,components:[]},i[h]=u,n.push(u)),u=i[h],u.components.push(c)}var f=s[0],d=s[s.length-1],p=n[0],g=n[n.length-1],v=t.get(f.path).length,y=t.get(d.path).length;return(r.start.offset>0||f.hasPrevious()&&f.getPrevious().rootId===f.rootId)&&(p.isFully=!1,p.startOffset=r.start.offset,1===n.length?p.endOffset=r.end.offset:p.endOffset=v),n.length>1&&(r.end.offset<y||d.hasNext()&&d.getNext().rootId===d.rootId)&&(g.isFully=!1,g.startOffset=0,g.endOffset=r.end.offset),n}var c=t("./delete_character"),l=t("./delete_node"),u=t("./merge"),h=t("../annotation_updates"),f=t("../../basics/helpers");e.exports=i},{"../../basics/helpers":32,"../annotation_updates":49,"./delete_character":87,"./delete_node":88,"./merge":93}],90:[function(t,e,n){e.exports={breakNode:t("./break_node"),copySelection:t("./copy_selection"),deleteCharacter:t("./delete_character"),deleteNode:t("./delete_node"),deleteSelection:t("./delete_selection"),insertNode:t("./insert_node"),insertText:t("./insert_text"),merge:t("./merge"),paste:t("./paste"),switchTextType:t("./switch_text_type")}},{"./break_node":85,"./copy_selection":86,"./delete_character":87,"./delete_node":88,"./delete_selection":89,"./insert_node":91,"./insert_text":92,"./merge":93,"./paste":94,"./switch_text_type":95}],91:[function(t,e,n){"use strict";function i(t,e){var n=e.selection,i=e.node;if(!e.containerId)throw new Error("containerId is mandatory");if(!e.selection)throw new Error("selection is mandatory");if(!e.node)throw new Error("node is mandatory");var s,a=e.containerId,c=t.get(a);n.isCollapsed()||(s=r(t,e),n=s.selection),s=o(t,e),n=s.selection,t.get(i.id)||(i=t.create(i));var l=c.getComponent(n.start.path),u=c.getPosition(l.rootId);return c.show(i.id,u),{selection:null}}var r=t("./delete_selection"),o=t("./break_node");e.exports=i},{"./break_node":85,"./delete_selection":89}],92:[function(t,e,n){"use strict";var i=t("./delete_selection"),r=t("../annotation_updates"),o=function(t,e){var n=e.selection,o=e.text;if(!n)throw new Error("Argument `selection` is mandatory for transformation `insertText`.");
if(!o)throw new Error("Argument `text` is mandatory for transformation `insertText`.");if(!n.isPropertySelection()&&!n.isContainerSelection())throw new Error("Selection must be property or container selection.");var s;n.isCollapsed()||(s=i(t,{selection:n,direction:"right"}),n=s.selection);var a=n.getRange();return void 0===t.get(a.start.path)&&t.set(a.start.path,""),t.update(a.start.path,{insert:{offset:a.start.offset,value:o}}),r.insertedText(t,a.start,o.length),{selection:t.createSelection({type:"property",path:a.start.path,startOffset:a.start.offset+o.length})}};e.exports=o},{"../annotation_updates":49,"./delete_selection":89}],93:[function(t,e,n){"use strict";var i=t("../annotation_updates"),r=function(t,e){var n=e.containerId,i=e.path,r=e.direction;if(!n||!i||!r)throw new Error("Insufficient arguments! mandatory fields: `containerId`, `path`, `direction`");var s=t.get(n),a=s.getComponent(i);return"right"===r&&a.next?o(t,n,a,a.next):"left"===r&&a.previous?o(t,n,a.previous,a):void 0},o=function(t,e,n,i){var r=t.get(n.parentNode.id),o=t.get(i.parentNode.id),a=s(r,o);if(a)return a.call(this,t,e,n,i)},s=function(t,e){var n=null;return t.isInstanceOf("text")&&e.isInstanceOf("text")&&(n=a),n||console.info("No merge behavior defined for %s <- %s",t.type,e.type),n},a=function(t,e,n,r){var o,s=n.path,a=t.get(s),c=a.length,l=r.path,u=t.get(l),h=t.get(e);return 0===c?(h.hide(s[0]),t["delete"](s[0]),o=t.createSelection({type:"property",path:l,startOffset:0})):(t.update(s,{insert:{offset:c,value:u}}),i.transferAnnotations(t,l,0,s,c),h.hide(l[0]),t["delete"](l[0]),o=t.createSelection({type:"property",path:s,startOffset:c})),{selection:o}};e.exports=r},{"../annotation_updates":49}],94:[function(t,e,n){var i=t("../../basics/helpers"),r=t("../annotation_updates"),o=t("./delete_selection"),s=t("./insert_text"),a=t("./break_node"),c=t("./copy_selection").CLIPBOARD_CONTAINER_ID,l=function(t,e){if(e.selection.isNull())return console.error("Can not paste, without selection."),e;if(e.text&&!e.doc)return s(t,e);var n=e.doc;if(!e.selection.isCollapsed()){var i=o(t,e);e.selection=i.selection}var r=n.get(c).nodes;if(r.length>0){var a=n.get(r[0]);return 1===r.length&&a.isInstanceOf("text")?u(t,e):h(t,e)}return e},u=function(t,e){var n=e.doc,o=e.selection,s=n.get(c).nodes,a=[s[0],"content"],l=n.get(a),u=n.getIndex("annotations").get(a),h=o.start.path,f=o.start.offset;return t.update(h,{insert:{offset:f,value:l}}),r.insertedText(t,o.start,l.length),o=t.createSelection({type:"property",path:o.start.path,startOffset:o.start.offset+l.length}),i.each(u,function(e){var n=e.toJSON();n.path=h.slice(0),n.startOffset+=f,n.endOffset+=f,t.get(n.id)&&(n.id=i.uuid(n.type)),t.create(n)}),{selection:o}},h=function(t,e){var n,r=e.doc,o=e.containerId,s=e.selection,l=t.get(o),u=l.getComponent(s.start.path),h=u.parentNode;if(u===i.last(h.components)&&t.get(u.path).length===s.start.offset)n=l.getPosition(s.start.path[0])+1;else{var f=a(t,e);s=f.selection,n=l.getPosition(s.start.path[0])}n<0&&console.error("Could not find insertion position in ContainerNode.");for(var d=r.get(c).nodes,p=r.getIndex("annotations"),g=[],v=0;v<d.length;v++){var y=d[v],m=r.get(y).toJSON();t.get(y)&&(m.id=i.uuid(m.type)),t.create(m),l.show(m.id,n++),g.push(m);for(var b=p.get(y),w=0;w<b.length;w++){var x=b[w].toJSON();m.id!==y&&(x.path[0]=m.id),t.get(x.id)&&(x.id=i.uuid(x.type)),t.create(x)}}if(0!==g.length){var _=i.last(g).id,S=i.last(l.getComponentsForNode(_)),C=t.get(S.path).length;return s=t.createSelection({type:"property",path:S.path,startOffset:C}),{selection:s}}};e.exports=l},{"../../basics/helpers":32,"../annotation_updates":49,"./break_node":85,"./copy_selection":86,"./delete_selection":89,"./insert_text":92}],95:[function(t,e,n){"use strict";function i(t,e){var n=e.selection;if(!n.isPropertySelection())return void console.error("Selection must be a PropertySelection.");var i=n.getPath()[0],a=e.data,c=t.get(i),l=n.path;if(!c.isInstanceOf("text"))return void console.warn("Trying to use switchTextType on a non text node. Skipping.");var u=r.extend({id:r.uuid(a.type),type:a.type,content:c.content},a),h=[u.id,"content"];t.create(u);o.transferAnnotations(t,l,0,h,0);var f=t.get(e.containerId),d=f.getPosition(i);return d>=0&&(f.hide(i),f.show(u.id,d)),s(t,{nodeId:c.id}),{selection:t.createSelection({type:"property",path:h,startOffset:n.startOffset,endOffset:n.endOffset})}}var r=t("../../basics/helpers"),o=t("../annotation_updates"),s=t("./delete_node");e.exports=i},{"../../basics/helpers":32,"../annotation_updates":49,"./delete_node":88}],96:[function(t,e,n){"use strict";function i(t,e){t.pos===e.pos?e.pos+=1:t.pos<e.pos?e.pos+=1:t.pos+=1}function r(t,e){return t.pos===e.pos?(e.type=u,void(t.type=u)):void(t.pos<e.pos?e.pos-=1:t.pos-=1)}function o(t,e){if(t.type===h){var n=t;t=e,e=n}t.pos<=e.pos?e.pos+=1:t.pos-=1}var s=t("../basics/helpers"),a=t("../basics/oo"),c=t("./operation"),l=t("./conflict"),u="NOP",h="delete",f="insert",d=function(t){if(c.call(this),!t||null==t.type)throw new Error("Illegal argument: insufficient data.");if(this.type=t.type,this.type!==u){if(this.type!==f&&this.type!==h)throw new Error("Illegal type.");if(this.pos=t.pos,this.val=t.val,!s.isNumber(this.pos)||this.pos<0)throw new Error("Illegal argument: expecting positive number as pos.")}};d.fromJSON=function(t){return new d(t)},d.Prototype=function(){this.apply=function(t){if(this.type===u)return t;if(this.type===f){if(t.length<this.pos)throw new Error("Provided array is too small.");return t.splice(this.pos,0,this.val),t}if(t.length<this.pos)throw new Error("Provided array is too small.");if(!s.isEqual(t[this.pos],this.val))throw Error("Unexpected value at position "+this.pos+". Expected "+this.val+", found "+t[this.pos]);return t.splice(this.pos,1),t},this.clone=function(){var t={type:this.type,pos:this.pos,val:s.deepclone(this.val)};return new d(t)},this.invert=function(){var t=this.toJSON();return this.type===u?t.type=u:this.type===f?t.type=h:t.type=f,new d(t)},this.hasConflict=function(t){return d.hasConflict(this,t)},this.toJSON=function(){var t={type:this.type};return this.type===u?t:(t.pos=this.pos,t.val=s.deepclone(this.val),t)},this.isInsert=function(){return this.type===f},this.isDelete=function(){return this.type===h},this.getOffset=function(){return this.pos},this.getValue=function(){return this.val},this.isNOP=function(){return this.type===u},this.toString=function(){return["(",this.isInsert()?"+":"-",",",this.getOffset(),",'",this.getValue(),"')"].join("")}},a.inherit(d,c);var p=function(t,e){return t.type!==u&&e.type!==u&&(t.type===f&&e.type===f&&t.pos===e.pos)},g=function(t,e,n){if(n=n||{},n["no-conflict"]&&p(t,e))throw new l(t,e);return n.inplace||(t=t.clone(),e=e.clone()),t.type===u||e.type===u||(t.type===f&&e.type===f?i(t,e):t.type===h&&e.type===h?r(t,e):o(t,e)),[t,e]};d.transform=g,d.hasConflict=p,d.Insert=function(t,e){return new d({type:f,pos:t,val:e})},d.Delete=function(t,e){return new d({type:h,pos:t,val:e})},d.NOP=u,d.DELETE=h,d.INSERT=f,e.exports=d},{"../basics/helpers":32,"../basics/oo":34,"./conflict":97,"./operation":100}],97:[function(t,e,n){"use strict";function i(t,e){Error.call(this,"Conflict: "+JSON.stringify(t)+" vs "+JSON.stringify(e)),this.a=t,this.b=e}i.prototype=Error.prototype,e.exports=i},{}],98:[function(t,e,n){"use strict";e.exports={Operation:t("./operation"),TextOperation:t("./text_operation"),ArrayOperation:t("./array_operation"),ObjectOperation:t("./object_operation")}},{"./array_operation":96,"./object_operation":99,"./operation":100,"./text_operation":101}],99:[function(t,e,n){"use strict";var i=t("../basics/helpers"),r=t("../basics/oo"),o=t("../basics"),s=o.PathAdapter,a=t("./operation"),c=t("./text_operation"),l=t("./array_operation"),u=t("./conflict"),h="NOP",f="create",d="delete",p="update",g="set",v=function(t){if(a.call(this),!t)throw new Error("Data of ObjectOperation is missing.");if(!t.type)throw new Error("Invalid data: type is mandatory.");if(this.type=t.type,t.type!==h){if(this.path=t.path,!t.path)throw new Error("Invalid data: path is mandatory.");if(this.type===f||this.type===d){if(!t.val)throw new Error("Invalid data: value is missing.");this.val=t.val}else if(this.type===p){if(!t.diff)throw new Error("Invalid data: diff is mandatory for update operation.");if(this.diff=t.diff,t.diff instanceof c)this.propertyType="string";else{if(!(t.diff instanceof l))throw new Error("Invalid data: diff must be a TextOperation or an ArrayOperation.");this.propertyType="array"}}else{if(this.type!==g)throw new Error("Invalid type: "+t.type);this.val=t.val,this.original=t.original}}};v.fromJSON=function(t){if(t=i.deepclone(t),"update"===t.type)switch(t.propertyType){case"string":t.diff=c.fromJSON(t.diff);break;case"array":t.diff=l.fromJSON(t.diff);break;default:throw new Error("Unsupported update diff:"+JSON.stringify(t.diff))}var e=new v(t);return e},v.Prototype=function(){this.apply=function(t){if(this.type===h)return t;var e;if(e=t instanceof s?t:new s(t),this.type===f)return e.set(this.path,i.deepclone(this.val)),t;if(this.type===d)e["delete"](this.path,"strict");else if(this.type===p){var n,r=this.diff,o=e.get(this.path);n=r instanceof l?r.apply(o):r.apply(o),e.set(this.path,n)}else e.set(this.path,i.deepclone(this.val));return t},this.clone=function(){var t={type:this.type,path:this.path};return this.val&&(t.val=i.deepclone(this.val)),this.diff&&(t.diff=this.diff.clone()),new v(t)},this.isNOP=function(){return this.type===h||(this.type===p?this.diff.isNOP():void 0)},this.isCreate=function(){return this.type===f},this.isDelete=function(){return this.type===d},this.isUpdate=function(){return this.type===p},this.isSet=function(){return this.type===g},this.invert=function(){if(this.type===h)return new v({type:h});var t=new v(this);if(this.type===f)t.type=d;else if(this.type===d)t.type=f;else if(this.type===p){var e;e=this.diff instanceof c?c.fromJSON(this.diff.toJSON()).invert():l.fromJSON(this.diff.toJSON()).invert(),t.diff=e}else t.val=this.original,t.original=this.val;return t},this.hasConflict=function(t){return v.hasConflict(this,t)},this.toJSON=function(){if(this.type===h)return{type:h};var t={type:this.type,path:this.path};return this.type===f||this.type===d?t.val=this.val:this.type===p?(this.diff instanceof l?t.propertyType="array":t.propertyType="string",t.diff=this.diff.toJSON()):(t.val=this.val,t.original=this.original),t},this.getType=function(){return this.type},this.getPath=function(){return this.path},this.getValue=function(){return this.val},this.toString=function(){switch(this.type){case f:return["(+,",JSON.stringify(this.path),JSON.stringify(this.val),")"].join("");case d:return["(-,",JSON.stringify(this.path),JSON.stringify(this.val),")"].join("");case p:return["(>>,",JSON.stringify(this.path),this.propertyType,this.diff.toString(),")"].join("");case g:return["(=,",JSON.stringify(this.path),this.val,this.original,")"].join("")}}},r.inherit(v,a);var y=function(t,e){return t.type!==h&&e.type!==h&&i.isEqual(t.path,e.path)},m=function(t,e){t.type=h,e.type=h},b=function(){throw new Error("Can not transform two concurring creates of the same property")},w=function(){throw new Error("Illegal state: can not create and delete a value at the same time.")},x=function(t,e,n){if(t.type!==d)return x(e,t,!0);var i;i="string"===e.propertyType?c.fromJSON(e.diff):l.fromJSON(e.diff),n?(t.val=i.apply(t.val),e.type=h):(t.type=h,e.type=f,e.val=i.apply(t.val))},_=function(){throw new Error("Can not transform a concurring create and update of the same property")},S=function(t,e){var n,i,r;"string"===e.propertyType?(n=c.fromJSON(t.diff),i=c.fromJSON(e.diff),r=c.transform(n,i,{inplace:!0})):(n=l.fromJSON(t.diff),i=l.fromJSON(e.diff),r=l.transform(n,i,{inplace:!0})),t.diff=r[0],e.diff=r[1]},C=function(){throw new Error("Illegal state: can not create and set a value at the same time.")},E=function(t,e,n){return t.type!==d?E(e,t,!0):void(n?(t.val=e.val,e.type=h):(t.type=h,e.type=f,e.original=void 0))},O=function(){throw new Error("Unresolvable conflict: update + set.")},T=function(t,e){t.type=h,e.original=t.val},N=0,I=1,A=2,P=4,j=8,D={};D[h]=N,D[f]=I,D[d]=A,D[p]=P,D[g]=j;var k=[];k[A|A]=m,k[A|I]=w,k[A|P]=x,k[I|I]=b,k[I|P]=_,k[P|P]=S,k[I|j]=C,k[A|j]=E,k[P|j]=O,k[j|j]=T;var F=function(t,e,n){if(n=n||{},n["no-conflict"]&&y(t,e))throw new u(t,e);if(n.inplace||(t=t.clone(),e=e.clone()),t.isNOP()||e.isNOP())return[t,e];var r=i.isEqual(t.path,e.path);return r&&k[D[t.type]|D[e.type]](t,e),[t,e]};v.transform=F,v.hasConflict=y,v.Create=function(t,e){var n;return n=i.isString(t)?[t]:t,new v({type:f,path:n,val:e})},v.Delete=function(t,e){var n;return n=i.isString(t)?[t]:t,new v({type:d,path:n,val:e})},v.Update=function(t,e){var n;if(e instanceof c)n="string";else{if(!(e instanceof l))throw new Error("Unsupported type for operational changes");n="array"}return new v({type:p,path:t,diff:e})},v.Set=function(t,e,n){return new v({type:g,path:t,val:i.deepclone(n),original:i.deepclone(e)})},v.NOP=h,v.CREATE=f,v.DELETE=d,v.UPDATE=p,v.SET=g,e.exports=v},{"../basics":33,"../basics/helpers":32,"../basics/oo":34,"./array_operation":96,"./conflict":97,"./operation":100,"./text_operation":101}],100:[function(t,e,n){"use strict";function i(){}var r=t("../basics");i.Prototype=function(){this.isOperation=!0},r.initClass(i),e.exports=i},{"../basics":33}],101:[function(t,e,n){"use strict";function i(t){if(u.call(this),!t||void 0===t.type||void 0===t.pos||void 0===t.str)throw new Error("Illegal argument: insufficient data.");if(this.type=t.type,this.pos=t.pos,this.str=t.str,!this.isInsert()&&!this.isDelete())throw new Error("Illegal type.");if(!c.isString(this.str))throw new Error("Illegal argument: expecting string.");if(!c.isNumber(this.pos)||this.pos<0)throw new Error("Illegal argument: expecting positive number as pos.")}function r(t,e){t.pos===e.pos?e.pos+=t.str.length:t.pos<e.pos?e.pos+=t.str.length:t.pos+=e.str.length}function o(t,e,n){if(t.pos>e.pos)return o(e,t,!n);if(t.pos===e.pos&&t.str.length>e.str.length)return o(e,t,!n);if(e.pos<t.pos+t.str.length){var i=e.pos-t.pos,r=t.str.length-i,s=i+e.str.length;t.str=t.str.slice(0,i)+t.str.slice(s),e.str=e.str.slice(r),e.pos-=i}else e.pos-=t.str.length}function s(t,e){if(t.type===d)return s(e,t);if(t.pos<=e.pos)e.pos+=t.str.length;else if(t.pos>=e.pos+e.str.length)t.pos-=e.str.length;else{var n=t.pos-e.pos;e.str=e.str.slice(0,n)+t.str+e.str.slice(n),t.str=""}}var a,c=t("../basics/helpers"),l=t("../basics/oo"),u=t("./operation"),h=t("./conflict"),f="+",d="-";i.fromJSON=function(t){return new i(t)},i.Prototype=function(){this.apply=function(t){if(this.isEmpty())return t;if(this.type===f){if(t.length<this.pos)throw new Error("Provided string is too short.");return t.splice?t.splice(this.pos,0,this.str):t.slice(0,this.pos).concat(this.str).concat(t.slice(this.pos))}if(t.length<this.pos+this.str.length)throw new Error("Provided string is too short.");return t.splice?t.splice(this.pos,this.str.length):t.slice(0,this.pos).concat(t.slice(this.pos+this.str.length))},this.clone=function(){return new i(this)},this.isNOP=function(){return"NOP"===this.type||0===this.str.length},this.isInsert=function(){return this.type===f},this.isDelete=function(){return this.type===d},this.getLength=function(){return this.str.length},this.invert=function(){var t={type:this.isInsert()?"-":"+",pos:this.pos,str:this.str};return new i(t)},this.hasConflict=function(t){return a(this,t)},this.isEmpty=function(){return 0===this.str.length},this.toJSON=function(){return{type:this.type,pos:this.pos,str:this.str}},this.toString=function(){return["(",this.isInsert()?"+":"-",",",this.pos,",'",this.str,"')"].join("")}},l.inherit(i,u),a=function(t,e){if(t.type===f&&e.type===f)return t.pos===e.pos;if(t.type===d&&e.type===d)return!(t.pos>=e.pos+e.str.length||e.pos>=t.pos+t.str.length);var n,i;return t.type===d?(n=t,i=e):(n=e,i=t),i.pos>=n.pos&&i.pos<n.pos+n.str.length};var p=function(t,e,n){if(n=n||{},n["no-conflict"]&&a(t,e))throw new h(t,e);return n.inplace||(t=t.clone(),e=e.clone()),t.type===f&&e.type===f?r(t,e):t.type===d&&e.type===d?o(t,e,!0):s(t,e),[t,e]};i.transform=function(){return p.apply(null,arguments)},i.Insert=function(t,e){return new i({type:f,pos:t,str:e})},i.Delete=function(t,e){return new i({type:d,pos:t,str:e})},i.INSERT=f,i.DELETE=d,e.exports=i},{"../basics/helpers":32,"../basics/oo":34,"./conflict":97,"./operation":100}],102:[function(t,e,n){function i(t){s.call(this,t)}var r=t("../basics/helpers"),o=t("../basics/oo"),s=t("./tool");i.Prototype=function(){this.disabledModes=[],this.splitContainerSelections=!1,this.getAnnotationType=function(){if(this.constructor["static"].name)return this.constructor["static"].name;throw new Error("Contract: AnnotationTool.static.name should be associated to a document annotation type.")},this.afterCreate=function(){},this.afterFusion=function(){},this.afterRemove=function(){},this.afterTruncate=function(){},this.afterExpand=function(){},this.canCreate=function(t,e){return 0===t.length&&!e.isCollapsed()},this.canFusion=function(t,e){return t.length>=2&&!e.isCollapsed()},this.canRemove=function(t,e){if(1!==t.length)return!1;var n=t[0].getSelection();return e.isInsideOf(n)},this.canExpand=function(t,e){if(1!==t.length)return!1;var n=t[0].getSelection();return e.overlaps(n)&&!e.isInsideOf(n)},this.canTruncate=function(t,e){if(1!==t.length)return!1;var n=t[0].getSelection();return(e.isLeftAlignedWith(n)||e.isRightAlignedWith(n))&&!e.equals(n)&&!e.isCollapsed()},this.update=function(t,e){if(this.surface=t,this.needsEnabledSurface&&!t.isEnabled()||e.isNull())return this.setDisabled();var n,i=this.getDocument(),o=this.getAnnotationType(),s=this.isContainerAnno();if(s)n=i.getContainerAnnotationsForSelection(e,this.getContainer(),{type:o});else{if(!e.isPropertySelection()&&!this.splitContainerSelections)return this.setDisabled();n=i.getAnnotationsForSelection(e,{type:o})}var a={surface:t,disabled:!1,active:!1,mode:null,sel:e,annos:n};return this.canCreate(n,e)?a.mode="create":this.canFusion(n,e)?a.mode="fusion":this.canTruncate(n,e)?(a.active=!0,a.mode="truncate"):this.canRemove(n,e)?(a.active=!0,a.mode="remove"):this.canExpand(n,e)&&(a.mode="expand"),!a.mode||r.includes(this.disabledModes,a.mode)?this.setDisabled():void this.setToolState(a)},this.performAction=function(){var t=this.getToolState();if(t.sel&&t.mode&&!t.sel.isNull())switch(t.mode){case"create":return this.handleCreate(t);case"fusion":return this.handleFusion(t);case"remove":return this.handleRemove(t);case"truncate":return this.handleTruncate(t);case"expand":return this.handleExpand(t)}},this.handleCreate=function(t){var e,n=t.sel;n.isNull()||(this.surface.transaction({selection:n},function(t,i){return e=this.createAnnotationForSelection(t,n),i},this),this.afterCreate(e))},this.getAnnotationData=function(){return{}},this.isContainerAnno=function(){var t=this.getDocument(),e=t.getSchema();return e.isInstanceOf(this.getAnnotationType(),"container_annotation")},this._createPropertyAnnotations=function(t,e){var n,i=this.getAnnotationType();e.isPropertySelection()?n=[]:e.isContainerSelection()&&(n=e.splitIntoPropertySelections());for(var o=0;o<n.length;o++){var s={id:r.uuid(i),type:i};r.extend(s,this.getAnnotationData()),s.path=n[o].getPath(),s.startOffset=n[o].getStartOffset(),s.endOffset=n[o].getEndOffset(),t.create(s)}},this.createAnnotationForSelection=function(t,e){if(this.splitContainerSelections&&e.isContainerSelection())return this._createPropertyAnnotations(t,e);var n=this.getAnnotationType(),i={id:r.uuid(n),type:n};if(r.extend(i,this.getAnnotationData()),this.isContainerAnno()){i.startPath=e.start.path,i.endPath=e.end.path;var o=this.surface.getEditor().getContainerId();if(!o)throw"Container could not be determined";i.container=o}else{if(!e.isPropertySelection())throw new Error("Illegal state: can not apply ContainerSelection");i.path=e.getPath()}return i.startOffset=e.getStartOffset(),i.endOffset=e.getEndOffset(),t.create(i)},this.handleFusion=function(t){var e=t.sel;this.surface.transaction({selection:e},function(n,i){return r.each(t.annos,function(t){e=e.expand(t.getSelection())}),r.each(t.annos,function(t){n["delete"](t.id)}),this.createAnnotationForSelection(n,e),this.afterFusion(),i.selection=e,i},this)},this.handleRemove=function(t){var e=t.sel;this.surface.transaction({selection:e},function(e,n){var i=t.annos[0].id;return e["delete"](i),this.afterRemove(),n},this)},this.handleTruncate=function(t){var e=t.sel;this.surface.transaction({selection:e},function(n,i){var r=t.annos[0],o=r.getSelection(),s=o.truncate(e);return r.updateRange(n,s),this.afterTruncate(),i},this)},this.handleExpand=function(t){var e=t.sel;this.surface.transaction({selection:e},function(n,i){var r=t.annos[0],o=r.getSelection(),s=o.expand(e);return r.updateRange(n,s),this.afterExpand(),i},this)}},o.inherit(i,s),e.exports=i},{"../basics/helpers":32,"../basics/oo":34,"./tool":115}],103:[function(t,e,n){"use strict";var i=t("./node_view"),r=i.extend({name:"annotation",tagName:"span",getClassNames:function(){var t=this.node.getClassNames();return this.props.classNames&&(t+=" "+this.props.classNames.join(" ")),t.replace(/_/g,"-")}});e.exports=r},{"./node_view":108}],104:[function(t,e,n){"use strict";var i=t("../basics/helpers"),r=t("../basics/oo"),o=function(t,e,n){this.surfaceManager=t,this.htmlImporter=e,this.htmlExporter=n,this._contentDoc=null,this._contentText="",this._onKeyDown=i.bind(this.onKeyDown,this),this._onCopy=i.bind(this.onCopy,this),this._onCut=i.bind(this.onCut,this),this.isIe=window.navigator.userAgent.toLowerCase().indexOf("msie")!=-1||window.navigator.userAgent.toLowerCase().indexOf("trident")!=-1,this.isFF=window.navigator.userAgent.toLowerCase().indexOf("firefox")>-1,this.isIe?(this._beforePasteShim=i.bind(this.beforePasteShim,this),this._pasteShim=i.bind(this.pasteShim,this)):this._onPaste=i.bind(this.onPaste,this)};o.Prototype=function(){this.getSurface=function(){return this.surfaceManager.getFocusedSurface()},this.attach=function(t){this.el=window.document.createElement("div"),this.$el=$(this.el),this.$el.prop("contentEditable","true").addClass("clipboard"),t.appendChild(this.el),t.addEventListener("keydown",this._onKeyDown,!1),t.addEventListener("copy",this._onCopy,!1),t.addEventListener("cut",this._onCut,!1),this.isIe?(t.addEventListener("beforepaste",this._beforePasteShim,!1),t.addEventListener("paste",this._pasteShim,!1)):t.addEventListener("paste",this._onPaste,!1)},this.detach=function(t){this.$el.remove(),t.removeEventListener("keydown",this._onKeyDown,!1),t.removeEventListener("copy",this._onCopy,!1),t.removeEventListener("cut",this._onCut,!1),this.isIe?(t.removeEventListener("beforepaste",this._beforePasteShim,!1),t.removeEventListener("paste",this._pasteShim,!1)):t.removeEventListener("paste",this._onPaste,!1)},this.onCopy=function(t){if(console.log("Clipboard.onCopy",arguments),this._copySelection(),t.clipboardData&&this._contentDoc){var e=this.htmlExporter.convert(this._contentDoc);console.log("Stored HTML in clipboard",e),this._contentDoc.__id__=i.uuid();var n=this._contentDoc.toJSON();n.__id__=this._contentDoc.__id__,t.clipboardData.setData("application/substance",JSON.stringify(n)),t.clipboardData.setData("text/plain",$(e).text()),t.clipboardData.setData("text/html",e),t.preventDefault()}},this.onCut=function(t){t.preventDefault(),console.log("Clipboard.onCut",arguments),this.onCopy(t);var e=this.getSurface();if(e){var n=e.getEditor();e.transaction(function(t,e){return n["delete"](t,e)})}},this.pasteSubstanceData=function(t){var e=this.getSurface();if(e){var n=e.getEditor(),i=e.getDocument(),r=i.newInstance();r._setForClipboard(!0),r.loadSeed(JSON.parse(t));var o="",s=r.get("clipboard_content");if(s.nodes.length>0){var a=s.getFirstComponent(),c=s.getLastComponent(),l=r.get(c.path).length,u=i.createSelection({type:"container",containerId:"clipboard_content",startPath:a.path,startOffset:0,endPath:c.path,endOffset:l});o=r.getTextForSelection(u)}e.transaction(function(t,e){return e.text=o,e.doc=r,n.paste(t,e)})}},this.pasteHtml=function(t){var e=this.getSurface();if(e){var n=e.getEditor(),i=e.getLogger(),r=e.getDocument();try{var o=r.newInstance();o._setForClipboard(!0),o.get("clipboard_content")||o.create({id:"clipboard_content",type:"container",nodes:[]}),this.htmlImporter.convert($(t),o),e.transaction(function(e,i){return i.text=t.body.textContent,i.doc=o,n.paste(e,i)})}catch(s){console.error(s),i.error(s)}}},this.onPaste=function(t){var e=t.clipboardData,n=this.getSurface();if(n){for(var r=n.getEditor(),o=(n.getLogger(),{}),s=0;s<e.types.length;s++)o[e.types[s]]=!0;if(this.isFF&&!o["application/substance"]&&!o["text/html"])return this.beforePasteShim(),n.rerenderSelection(),void this.pasteShim();if(t.preventDefault(),t.stopPropagation(),console.log("Available types",o),o["application/substance"])return this.pasteSubstanceData(e.getData("application/substance"));if(o["text/html"]){var a=e.getData("text/html"),c=(new window.DOMParser).parseFromString(a,"text/html");if(this.htmlImporter.checkQuality($(c)))return this.pasteHtml(c)}var l=e.getData("text/plain");if(n.getEditor().isContainerEditor()){var u=n.getDocument(),h=u.getSchema().getDefaultTextType();n.transaction(function(t,e){var n=l.split(/\s*\n\s*\n/),o=u.newInstance();o._setForClipboard(!0);for(var s=o.create({type:"container",id:"clipboard_content",nodes:[]}),a=0;a<n.length;a++){var c=o.create({id:i.uuid(h),type:h,content:n[a]});s.show(c.id)}return e.doc=o,r.paste(t,e)})}else n.transaction(function(t,e){return e.text=l.split("").join(""),r.insertText(t,e)})}},this.beforePasteShim=function(){var t=this.getSurface();if(t){console.log("Paste before..."),this.$el.focus();var e=document.createRange();e.selectNodeContents(this.el);var n=window.getSelection();n.removeAllRanges(),n.addRange(e)}},this.pasteShim=function(){this.$el.empty();var t=this,e=this.getSurface();if(e){var n=e.getSelection();setTimeout(function(){e.selection=n;var i=t.$el.html();i=["<html><head></head><body>",i,"</body></html>"].join(""),t.$el.empty();var r=(new window.DOMParser).parseFromString(i,"text/html");return t.pasteHtml(r)},0)}},this.onKeyDown=function(t){88===t.keyCode&&(t.metaKey||t.ctrlKey)||(86===t.keyCode&&(t.metaKey||t.ctrlKey)?this.handlePaste():67===t.keyCode&&(t.metaKey||t.ctrlKey))},this.handleCut=function(){console.log("Cutting into Clipboard...");var t=window.getSelection(),e=t.getRangeAt(0),n=e.cloneContents();this.el.innerHTML="",this.el.appendChild(n),this._copySelection();var i=this.getSurface();if(i){try{console.log("...selection before deletion",i.getSelection().toString()),i.getEditor()["delete"]()}catch(r){return console.error(r),void this.logger.error(r)}var o=window.document.createRange();o.selectNodeContents(this.el),t.removeAllRanges(),t.addRange(o),window.setTimeout(function(){i.rerenderDomSelection()},10)}},this.handlePaste=function(){},this.handleCopy=function(){},this._copySelection=function(){var t=window.getSelection();this._contentText="",this._contentDoc=null;var e=this.getSurface(),n=e.getSelection(),i=e.getEditor(),r=e.getDocument();if(t.rangeCount>0&&!n.isCollapsed()){var o=t.getRangeAt(0);this._contentText=o.toString(),this._contentDoc=i.copy(r,n),console.log("Clipboard._copySelection(): created a copy",this._contentDoc)}else this._contentDoc=null,this._contentText=""}},r.initClass(o),e.exports=o},{"../basics/helpers":32,"../basics/oo":34}],105:[function(t,e,n){"use strict";function i(t){if(!r.isString(t))throw new Error("Illegal argument: Expecting container id.");a.call(this),this.containerId=t}var r=t("../basics/helpers"),o=t("../basics/oo"),s=t("../document"),a=t("./form_editor"),c=(s.AnnotationUpdates,s.Transformations);i.Prototype=function(){this.isContainerEditor=function(){return!0},this.getContainerId=function(){return this.containerId},this["delete"]=function(t,e){return e.containerId=this.containerId,c.deleteSelection(t,e)},this["break"]=function(t,e){if(e.containerId=this.containerId,e.selection.isPropertySelection()||e.selection.isContainerSelection())return c.breakNode(t,e)},this.insertNode=function(t,e){if(e.containerId=this.containerId,e.selection.isPropertySelection()||e.selection.isContainerSelection())return c.insertNode(t,e)},this.switchType=function(t,e){if(e.containerId=this.containerId,e.selection.isPropertySelection())return c.switchTextType(t,e)},this.selectAll=function(t){var e=t.get(this.containerId),n=e.getFirstComponent(),i=e.getLastComponent(),r=t.get(i.path);return t.createSelection({type:"container",containerId:this.containerId,startPath:n.path,startOffset:0,endPath:i.path,endOffset:r.length})},this.paste=function(t,e){if(e.containerId=this.containerId,e.selection.isPropertySelection()||e.selection.isContainerSelection())return c.paste(t,e)}},o.inherit(i,a),e.exports=i},{"../basics/helpers":32,"../basics/oo":34,"../document":63,"./form_editor":106}],106:[function(t,e,n){"use strict";function i(){}var r=t("../basics"),o=t("../document"),s=(o.Selection,o.AnnotationUpdates,o.Transformations);i.Prototype=function(){this.isContainerEditor=function(){return!1},this.selectAll=function(t,e){var n=e;if(!n.isNull()&&n.isPropertySelection()){var i=n.start.path,r=t.get(i);return t.createSelection({type:"property",path:i,startOffset:0,endOffset:r.length})}},this.insertText=function(t,e){if(e.selection.isPropertySelection()||e.selection.isContainerSelection())return s.insertText(t,e)},this["delete"]=function(t,e){return s.deleteSelection(t,e)},this["break"]=function(t,e){return this.softBreak(t,e)},this.softBreak=function(t,e){return e.text="\n",this.insertText(t,e)},this.copy=function(t,e){var n=s.copySelection(t,{selection:e});return n.doc},this.paste=function(t,e){if(e.text)return this.insertText(t,e)}},r.initClass(i),e.exports=i},{"../basics":33,"../document":63}],107:[function(t,e,n){var i=t("./surface");i.SurfaceManager=t("./surface_manager"),i.SurfaceSelection=t("./surface_selection"),i.FormEditor=t("./form_editor"),i.ContainerEditor=t("./container_editor"),i.Clipboard=t("./clipboard"),i.NodeView=t("./node_view"),i.AnnotationView=t("./annotation_view"),i.TextProperty=t("./text_property"),i.Tool=t("./tool"),i.AnnotationTool=t("./annotation_tool"),i.SwitchTypeTool=t("./switch_type_tool"),i.ToolRegistry=t("./tool_registry"),i.Panel=t("./panel"),i.Tools=t("./tools"),e.exports=i},{"./annotation_tool":102,"./annotation_view":103,"./clipboard":104,"./container_editor":105,"./form_editor":106,"./node_view":108,"./panel":109,"./surface":110,"./surface_manager":111,"./surface_selection":112,"./switch_type_tool":113,"./text_property":114,"./tool":115,"./tool_registry":116,"./tools":120}],108:[function(t,e,n){"use strict";function i(t){this.props=t,this.doc=t.doc,this.node=t.node}var r=t("../basics");i.Prototype=function(){this.tagName="div",this.createElement=function(){var t=document.createElement(this.getTagName()),e=this.getClassNames();return $(t).addClass(e),t.dataset.id=this.node.id,t},this.getTagName=function(){return this.node.constructor["static"].tagName||this.tagName},this.getClassNames=function(){return[]},this.render=function(){var t=this.createElement(),e=this.props.children;if(e)for(var n=0;n<e.length;n++){var o=e[n];if(r.isString(o))t.appendChild(document.createTextNode(o));else if(o instanceof i){var s=o.render();t.appendChild(s)}else o instanceof window.Node&&t.appendChild(o)}return t}},r.initClass(i),e.exports=i},{"../basics":33}],109:[function(t,e,n){"use strict";function i(){}var r=t("../basics");i.Prototype=function(){this.getPanelOffsetForElement=function(t){function e(t){var i=t.parentNode;!$(t).hasClass("panel-content-inner")&&i&&("absolute"!==$(t).css("position")&&"relative"!==$(t).css("position")||(n+=$(t).position().top),e(i))}var n=$(t).position().top;this.getScrollableContainer();return e(t.parentNode),n},this.scrollToNode=function(t){var e=this.getScrollableContainer(),n=$(e).find("*[data-id="+t+"]")[0];n?$(e).scrollTop(this.getPanelOffsetForElement(n)):console.warn(t,"not found in scrollable container")}},r.initClass(i),e.exports=i;
},{"../basics":33}],110:[function(t,e,n){"use strict";function i(t,e,n,o){if(s.EventEmitter.call(this),!e)throw new Error("Illegal argument: document is required. was "+e);o=o||{},this.__id__=u++,this.name=o.name||this.__id__,this.doc=e,this.surfaceManager=t,this.selection=c.nullSelection,this.element=null,this.$element=null,this.editor=n,this.surfaceSelection=null,this.logger=o.logger||window.console,this.$=$,this.$window=this.$(window),this.$document=this.$(window.document),this.dragging=!1,this._onMouseUp=r.bind(this.onMouseUp,this),this._onMouseDown=r.bind(this.onMouseDown,this),this._onMouseMove=r.bind(this.onMouseMove,this),this._onKeyDown=r.bind(this.onKeyDown,this),this._onTextInput=r.bind(this.onTextInput,this),this._onTextInputShim=r.bind(this.onTextInputShim,this),this._onCompositionStart=r.bind(this.onCompositionStart,this),this._onDomMutations=r.bind(this.onDomMutations,this),this.domObserver=new window.MutationObserver(this._onDomMutations),this.domObserverConfig={subtree:!0,characterData:!0},this.skipNextObservation=!1,this.enabled=!0,this.frozen=!1,this.$caret=$("<span>").addClass("surface-caret"),this.isIE=i.detectIE(),this.isFF=window.navigator.userAgent.toLowerCase().indexOf("firefox")>-1,this.undoEnabled=!0,null!=o.undoEnabled&&(this.undoEnabled=o.undoEnabled),null!=o.contentEditable?this.enableContentEditable=o.contentEditable:this.enableContentEditable=!0,this.surfaceManager.registerSurface(this)}var r=t("../basics/helpers"),o=t("../basics/oo"),s=t("../basics"),a=t("./surface_selection"),c=t("../document"),l=c.Selection,u=0;i.Prototype=function(){this.getName=function(){return this.name},this.getElement=function(){return this.element},this.getContainerName=function(){if(this.editor.isContainerEditor())return this.editor.getContainerId()},this.getContainer=function(){if(this.editor.isContainerEditor())return this.doc.get(this.editor.getContainerId())},this.getEditor=function(){return this.editor},this.getDocument=function(){return this.doc},this.dispose=function(){this.setSelection(null),this.detach(),this.surfaceManager.unregisterSurface(this)},this.attach=function(t){if(!t)throw new Error("Illegal argument: Surface element is required. was "+t);var e=this.getDocument();this.element=t,this.$element=$(t),this.surfaceSelection=new a(t,e,this.getContainer()),this.$element.addClass("surface"),this.attachKeyboard(),this.$element.on("mousedown",this._onMouseDown),this.$element.on("dragstart",this.onDragStart),this.domObserver.observe(t,this.domObserverConfig),this.attached=!0},this.attachKeyboard=function(){this.$element.on("keydown",this._onKeyDown),this.element.addEventListener&&this.element.addEventListener("compositionstart",this._onCompositionStart,!1),window.TextEvent&&!this.isIE?this.element.addEventListener("textInput",this._onTextInput,!1):this.$element.on("keypress",this._onTextInputShim)},this.detach=function(){var t=this.getDocument();this.domObserver.disconnect(),t.disconnect(this),this.$element.off("mousedown",this._onMouseDown),this.$element.off("dragstart",this.onDragStart),this.detachKeyboard(),this.$element.removeClass("surface"),this.element=null,this.$element=null,this.surfaceSelection=null,this.attached=!1},this.detachKeyboard=function(){this.$element.off("keydown",this._onKeyDown),this.element.addEventListener&&this.element.removeEventListener("compositionstart",this._onCompositionStart,!1),window.TextEvent&&!this.isIE?this.element.removeEventListener("textInput",this._onTextInput,!1):this.$element.off("keypress",this._onTextInputShim)},this.isAttached=function(){return this.attached},this.enable=function(){this.enableContentEditable&&this.$element.prop("contentEditable","true"),this.enabled=!0},this.isEnabled=function(){return this.enabled},this.disable=function(){this.enableContentEditable&&this.$element.removeAttr("contentEditable"),this.enabled=!1},this.freeze=function(){console.log("Freezing surface..."),this.enableContentEditable&&this.$element.removeAttr("contentEditable"),this.$element.addClass("frozen"),this.domObserver.disconnect(),this.frozen=!0},this.unfreeze=function(){this.frozen&&(console.log("Unfreezing surface..."),this.enableContentEditable&&this.$element.prop("contentEditable","true"),this.$element.removeClass("frozen"),this.domObserver.observe(this.element,this.domObserverConfig),this.frozen=!1)},this.onKeyDown=function(t){if(!this.frozen&&229!==t.which){switch(t.keyCode){case i.Keys.LEFT:case i.Keys.RIGHT:return this.handleLeftOrRightArrowKey(t);case i.Keys.UP:case i.Keys.DOWN:return this.handleUpOrDownArrowKey(t);case i.Keys.ENTER:return this.handleEnterKey(t);case i.Keys.SPACE:return this.handleSpaceKey(t);case i.Keys.BACKSPACE:case i.Keys.DELETE:return this.handleDeleteKey(t)}var e=!1;if((t.ctrlKey||t.metaKey)&&65===t.keyCode){var n=this.editor.selectAll(this.getDocument(),this.getSelection());this.setSelection(n),this.surfaceSelection.setSelection(n),this.emit("selection:changed",n,this),e=!0}else this.undoEnabled&&90===t.keyCode&&(t.metaKey||t.ctrlKey)&&(t.shiftKey?this.redo():this.undo(),e=!0);e&&(t.preventDefault(),t.stopPropagation())}},this.undo=function(){console.log("UNDO!");var t=this.getDocument();t.done.length>0&&t.undo()},this.redo=function(){var t=this.getDocument();t.undone.length>0&&t.redo()},this.transaction=function(t,e){var n={surfaceId:this.getName(),selection:this.getSelection()};if(!r.isFunction(arguments[0])&&arguments.length>=2){var i=arguments[0];n=r.extend(n,i),t=arguments[1],e=arguments[2]}var o;this.getDocument().transaction(n,function(i){var r=t.call(e,i,{selection:n.selection});return o=r||{},o.selection||(o.selection=n.selection),o.surfaceId=n.surfaceId,o}),this.setSelection(o.selection)},this.onTextInput=function(t){this.frozen||t.data&&(t.preventDefault(),t.stopPropagation(),this.skipNextObservation=!0,this.transaction(function(e,n){return this.editor.insertText(e,{selection:n.selection,text:t.data})},this),this.rerenderDomSelection())},this.onCompositionStart=function(){this.skipNextObservation=!0},this.onTextInputShim=function(t){if(!this.frozen&&!(0===t.which||0===t.charCode||t.keyCode===i.Keys.TAB||t.keyCode===i.Keys.ESCAPE||t.metaKey||!!t.ctrlKey^!!t.altKey)){var e=String.fromCharCode(t.which);return this.skipNextObservation=!0,t.shiftKey||(e=e.toLowerCase()),e.length>0?(this.transaction(function(t,n){return this.editor.insertText(t,{selection:n.selection,text:e})},this),this.rerenderDomSelection(),t.preventDefault(),void t.stopPropagation()):(t.preventDefault(),void t.stopPropagation())}},this.handleLeftOrRightArrowKey=function(t){var e=this;window.setTimeout(function(){var n={direction:t.keyCode===i.Keys.LEFT?"left":"right"};e._updateModelSelection(n)})},this.handleUpOrDownArrowKey=function(t){var e=this;window.setTimeout(function(){var n={direction:t.keyCode===i.Keys.UP?"left":"right"};e._updateModelSelection(n)})},this.handleSpaceKey=function(t){t.preventDefault(),t.stopPropagation(),this.transaction(function(t,e){return this.editor.insertText(t,{selection:e.selection,text:" "})},this),this.rerenderDomSelection()},this.handleEnterKey=function(t){t.preventDefault(),t.shiftKey?this.transaction(function(t,e){return this.editor.softBreak(t,e)},this):this.transaction(function(t,e){return this.editor["break"](t,e)},this),this.rerenderDomSelection()},this.handleDeleteKey=function(t){t.preventDefault();var e=t.keyCode===i.Keys.BACKSPACE?"left":"right";this.transaction(function(t,n){return this.editor["delete"](t,{selection:n.selection,direction:e})},this),this.rerenderDomSelection()},this.onMouseDown=function(t){this.frozen&&this.unfreeze(),1===t.which&&(this.dragging=!0,this.$document.one("mouseup",this._onMouseUp))},this.onMouseUp=function(){this.dragging=!1,this.setFocused(!0);var t=this;setTimeout(function(){if(t.surfaceSelection){var e=t.surfaceSelection.getSelection();t.setSelection(e)}})},this.setFocused=function(t){this.isFocused=t,this.isFocused&&this.surfaceManager.didFocus(this)},this.onMouseMove=function(){this.dragging},this.onDomMutations=function(){return this.skipNextObservation?void(this.skipNextObservation=!1):void console.info("We want to enable a DOM MutationObserver which catches all changes made by native interfaces (such as spell corrections, etc). Lookout for this message and try to set Surface.skipNextObservation=true when you know that you will mutate the DOM.")},this.onDragStart=function(t){t.preventDefault(),t.stopPropagation()},this.getSelection=function(){return this.selection},this.setSelection=function(t){t?!r.isObject(t)||t instanceof l||(t=this.getDocument().createSelection(t)):t=l.nullSelection,this._setModelSelection(t)&&this.rerenderDomSelection()},this.rerenderDomSelection=function(){if(this.surfaceSelection){var t=this.surfaceSelection,e=this.getSelection();setTimeout(function(){t.setSelection(e)})}},this.getDomNodeForId=function(t){return this.element.querySelector("*[data-id="+t+"]")},this._updateModelSelection=function(t){this._setModelSelection(this.surfaceSelection.getSelection(t))},this._setModelSelection=function(t){return t=t||s.Document.nullSelection,this.selection=t,this.emit("selection:changed",t,this),!0},this.getLogger=function(){return this.logger},this.placeCaretElement=function(){var t=this.getSelection();if(t.isNull())throw new Error("Selection is null.");var e=this.$caret;e.empty().remove();var n=this.surfaceSelection._findDomPosition(t.start.path,t.start.offset);if(n.node.nodeType===window.Node.TEXT_NODE){var i=n.node;if(i.length===n.offset)e.insertAfter(i);else{var r=window.getSelection(),o=window.document.createRange(),s=i.textContent,a=window.document.createDocumentFragment(),c=window.document.createTextNode(s.substring(0,n.offset));a.appendChild(c),a.appendChild(e[0]),a.appendChild(document.createTextNode(s.substring(n.offset))),$(i).replaceWith(a),o.setStart(c,n.offset),r.removeAllRanges(),r.addRange(o)}}else n.node.appendChild(e[0]);return e},this.removeCaretElement=function(){this.$caret.remove()},this.updateCaretElement=function(){this.$caret.remove(),this.placeCaretElement()},this.getAnnotationsForProperty=function(t){var e=this.getDocument(),n=e.getIndex("annotations").get(t),i=this.getContainerName();if(i){var r=e.getIndex("container-annotation-anchors").get(t,i);n=n.concat(r);var o=e.containerAnnotationIndex.getFragments(t,i);n=n.concat(o)}return n}},o.inherit(i,s.EventEmitter),i.Keys={UNDEFINED:0,BACKSPACE:8,DELETE:46,LEFT:37,RIGHT:39,UP:38,DOWN:40,ENTER:13,END:35,HOME:36,TAB:9,PAGEUP:33,PAGEDOWN:34,ESCAPE:27,SHIFT:16,SPACE:32},i.detectIE=function(){var t=window.navigator.userAgent,e=t.indexOf("MSIE ");if(e>0)return parseInt(t.substring(e+5,t.indexOf(".",e)),10);var n=t.indexOf("Trident/");if(n>0){var i=t.indexOf("rv:");return parseInt(t.substring(i+3,t.indexOf(".",i)),10)}var r=t.indexOf("Edge/");return r>0&&parseInt(t.substring(r+5,t.indexOf(".",r)),10)},e.exports=i},{"../basics":33,"../basics/helpers":32,"../basics/oo":34,"../document":63,"./surface_selection":112}],111:[function(t,e,n){"use strict";var i=t("../basics/oo"),r=(t("../basics/helpers"),t("./surface")),o=function(t){this.doc=t,this.surfaces={},this.focusedSurface=null,this.stack=[],t.connect(this,{"document:changed":this.onDocumentChange},{priority:-1})};o.Prototype=function(){this.dispose=function(){this.doc.disconnect(this),this.surfaces={}},this.createSurface=function(t,e){return new r(this,t,e)},this.registerSurface=function(t){this.surfaces[t.getName()]=t},this.unregisterSurface=function(t){delete this.surfaces[t.getName()],t&&this.focusedSurface===t&&(this.focusedSurface=null)},this.hasSurfaces=function(){return Object.keys(this.surfaces).length>0},this.didFocus=function(t){this.focusedSurface&&t!==this.focusedSurface&&this.focusedSurface.setFocused(!1),this.focusedSurface=t},this.getFocusedSurface=function(){return this.focusedSurface},this.onDocumentChange=function(t,e){if(e.replay){var n=t.after.selection,i=t.after.surfaceId;if(i){var r=this.surfaces[i];r?(this.focusedSurface!==r&&this.didFocus(r),r.setSelection(n)):console.warn("No surface with name",i)}}},this.pushState=function(){var t={surface:this.focusedSurface,selection:null};this.focusedSurface&&(t.selection=this.focusedSurface.getSelection()),this.focusedSurface=null,this.stack.push(t)},this.popState=function(){var t=this.stack.pop();t&&t.surface&&(t.surface.setFocused(!0),t.surface.setSelection(t.selection))}},i.initClass(o),e.exports=o},{"../basics/helpers":32,"../basics/oo":34,"./surface":110}],112:[function(t,e,n){function i(t,e,n){this.element=t,this.doc=e,this.container=n,this.state=new i.State}var r=t("../basics/oo"),o=t("../document"),s=t("../basics/helpers"),a=o.Range,c=o.Coordinate;i.Prototype=function(){function t(t,e){var n=t.compareDocumentPosition(e);return n&window.document.DOCUMENT_POSITION_FOLLOWING?-1:n&window.document.DOCUMENT_POSITION_PRECEDING?1:0}this._pullState=function(e,n,r,o,s,a){if(a=a||{},!r||!e)return void(this.state=null);var c,l;s?(c=this.getModelCoordinate(e,n,a),l=c):(c=this.getModelCoordinate(e,n,a),l=this.getModelCoordinate(r,o,a));var u=!1;if(!s&&r&&e){var h=t(l.el,c.el);u=h<0||0===h&&l.offset<c.offset}if(u){var f=l;l=c,c=f}this.state=new i.State(s,u,c,l)},this.getModelCoordinate=function(t,e,n){for(var r=t,o=null;r;){if(r.dataset&&r.dataset.path){o=r;break}if($(r).is(".content-node")&&0===e){var s=$(r).find("[data-path]");if(s.length)return new i.Coordinate(s[0],0)}r=r.parentNode}if(!o)return this.searchForCoordinate(t,e,n);var a=this._computeCharPosition(o,t,e);return new i.Coordinate(o,a)},this._computeCharPosition=function(t,e,n){function i(t){if(e===t)return o+=n,!0;if(t.nodeType===window.Node.TEXT_NODE)o+=t.textContent.length;else if(t.nodeType===window.Node.ELEMENT_NODE){if($(t).data("external"))return o+=1,!1;for(var r=t.firstChild;r;r=r.nextSibling)if(i(r))return!0}return!1}function r(t){var e=t.nodeType;if(e===window.Node.TEXT_NODE)return t.textContent.length;if(e===window.Node.ELEMENT_NODE){if($(t).data("external"))return 1;for(var n=0,i=t.firstChild;i;i=i.nextSibling)n+=r(i);return n}return 0}var o=0,s=!1;if(e===t){for(var a=t.firstChild,c=0;c<n&&a;c++)o+=r(a),a=a.nextSibling;s=!0}else s=i(t);return s?o:(console.error("Could not find char position."),0)},this.searchForCoordinate=function(e,n,r){var o,s,a,c,l,u=this.element.querySelectorAll("*[data-path]");for(s=0,a=u.length-1,c=t(u[s],e),l=t(u[a],e);;){var h=a-s+1;if(l<0){o=a;break}if(c>0){o=s;break}if(h<=2){o=a;break}var f=s+Math.floor(h/2),d=t(u[f],e);d<0?(s=f,c=d):(a=f,l=d)}var p;return"left"===r.direction?(o=Math.max(0,o-1),p=u[o].textContent.length):p=l<0?u[o].textContent.length:0,new i.Coordinate(u[o],p)},this._getSelection=function(t,e,n,i,r){if(this._pullState(t,e,n,i,r),!this.state)return o.nullSelection;var l,u,h,f,d,p,g,v,y=this.doc,m=this.state.start,b=this.state.end,w=new a(new c(m.path,m.offset),new c(b.path,b.offset));return s.isEqual(m.path,b.path)?y.createSelection({type:"property",path:m.path,startOffset:m.offset,endOffset:b.offset,reverse:this.state.reverse}):(l=y.get(m.path[0]),u=y.get(b.path[0]),h=l.getRoot(),f=u.getRoot(),"table"===h.type&&h.id===f.id?(h.getMatrix(),d=l.rowIdx,p=l.colIdx,g=u.rowIdx,v=u.colIdx,y.createSelection({type:"table",tableId:h.id,startRow:d,startCol:p,endRow:g,endCol:v})):y.createSelection({type:"container",containerId:this.container.id,startPath:w.start.path,startOffset:w.start.offset,endPath:w.end.path,endOffset:w.end.offset,reverse:this.state.reverse}))},this.getSelection=function(){var t=window.getSelection(),e=this._getSelection(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset,t.collapsed);return e};var e=function(t,n){if(t.nodeType===document.TEXT_NODE){var i=t.textContent.length;return i<n?{node:null,offset:n-i}:{node:t,offset:n,boundary:i===n}}if(t.nodeType===document.ELEMENT_NODE){if($(t).data("external"))return{node:null,offset:n-1};if(!t.firstChild&&0===n)return{node:t,offset:0};for(var r=t.firstChild;r;r=r.nextSibling){var o=e(r,n);if(o.node)return o;n=o.offset}}return{node:null,offset:n}};this._getDomPosition=function(t,n){var i='*[data-path="'+t.join(".")+'"]',r=this.element.querySelector(i);if(!r)return console.warn("Could not find DOM element for path",t),null;var o=e(r,n);return o.node?o:null},this.setSelection=function(t){var e=window.getSelection();if(t.isNull()||t.isTableSelection())return this.clear();var n=t.getRange(),r=this._getDomPosition(n.start.path,n.start.offset);if(!r)return this.clear();var o;return(o=n.isCollapsed()?r:this._getDomPosition(n.end.path,n.end.offset))?(e.removeAllRanges(),n=window.document.createRange(),t.isReverse()?(n.setStart(o.node,o.offset),e.addRange(n),e.extend(r.node,r.offset)):(n.setStart(r.node,r.offset),n.setEnd(o.node,o.offset),e.addRange(n)),void(this.state=new i.State(t.isCollapsed(),t.isReverse(),n.start,n.end))):this.clear()},this.clear=function(){var t=window.getSelection();t.removeAllRanges(),this.state=null}},r.initClass(i),i.State=function(t,e,n,i){this.collapsed=t,this.reverse=e,this.start=n,this.end=i,Object.freeze(this)},i.Coordinate=function(t,e){this.el=t,this.offset=e,this.path=t.dataset.path.split(".")},e.exports=i},{"../basics/helpers":32,"../basics/oo":34,"../document":63}],113:[function(t,e,n){function i(){o.call(this)}var r=t("../basics"),o=t("./tool");i.Prototype=function(){this.getNodeType=function(){if(this.constructor["static"].name)return this.constructor["static"].name;throw new Error("Contract: SwitchTypeTool.static.name should be associated to a document annotation type.")},this.getData=function(){return{}},this.matchNode=function(t){return t.type===this.getNodeType()},this.update=function(t,e){if(this.surface=t,!t.isEnabled()||e.isNull()||e.isContainerSelection()||!t.getEditor().isContainerEditor())return this.setDisabled();var n=t.getEditor().getContainer(),i=n.getNodeForComponentPath(e.start.path);return this.matchNode(i)?this.setToolState({enabled:!0,selected:!0}):i.isInstanceOf("text")?this.setToolState({enabled:!0,selected:!0,sel:e,node:i,mode:"switch"}):void 0},this.performAction=function(){var t=this.getToolState();"switch"===t.mode&&this.surface.getEditor().switchType(t.sel,this.getNodeType(),this.getData())}},r.inherit(i,o),e.exports=i},{"../basics":33,"./tool":115}],114:[function(t,e,n){function i(){}var r=t("../basics"),o=t("../document"),s=t("./node_view"),a=t("./annotation_view"),c=o.Annotator;i.Prototype=function(){this.getSurface=function(){throw new Error("This is abstract")},this.getDocument=function(){var t=this.getSurface();return t?t.getDocument():null},this.getPath=function(){throw new Error("This is abstract")},this.getElement=function(){throw new Error("This is abstract")},this.getAnnotations=function(){var t=this.getDocument(),e=this.getPath();return t.getIndex("annotations").get(e)},this.attach=function(){var t=this.getDocument(),e=this.getPath();t.getEventProxy("path").add(e,this,this.propertyDidChange)},this.detach=function(){var t=this.getDocument(),e=this.getPath();t.getEventProxy("path").remove(e,this)},this.renderContent=function(){var t=this.getDocument(),e=this.getElement();if(e){var n=new i.ContentView({doc:t,children:this.renderChildren()}),r=n.render();r.appendChild(document.createElement("br")),e.innerHTML="",e.appendChild(r)}},this.renderChildren=function(){var t=this.getDocument(),e=this.getPath(),n=t.get(e)||"",i=this.getAnnotations(),r=new c;r.onText=function(t,e){t.children.push(e)},r.onEnter=function(e){var n=e.node,i=a,r=[];return{ViewClass:i,props:{doc:t,node:n,classNames:r},children:[]}},r.onExit=function(t,e,n){var i=e.props;i.children=e.children;var r=new e.ViewClass(i);n.children.push(r)};var o={children:[]};return r.start(o,n,i),o.children},this.propertyDidChange=function(t,e){if(e.source===this.getElement()&&(console.log("Skipping update..."),e.surface&&e.typing)){if(!this._debouncedRerender){var n=200,i=this;this._debouncedRerender=r.debounce(function(){var t=this.getDocument();t&&(i.renderContent(),e.surface.rerenderDomSelection())},n)}return void this._debouncedRerender()}this.renderContent(),e.source===this.getElement()&&e.surface&&setTimeout(function(){e.surface.rerenderDomSelection()})}},r.initClass(i),i.ContentView=s.extend({createElement:function(){return document.createDocumentFragment()}}),e.exports=i},{"../basics":33,"../document":63,"./annotation_view":103,"./node_view":108}],115:[function(t,e,n){function i(t){r.EventEmitter.call(this),this.context=t,this.state={disabled:!0,active:!1}}var r=t("../basics");i.Prototype=function(){this.needsEnabledSurface=!0,this.getName=function(){return this.constructor["static"].name},this.getSurface=function(){return this.surface},this.getDocument=function(){var t=this.getSurface();if(t)return t.getDocument()},this.getContainer=function(){var t=this.getSurface();if(t)return t.getContainer()},this.setToolState=function(t){var e=this.state;this.state=t,this.emit("toolstate:changed",t,this,e)},this.getToolState=function(){return this.state},this.isEnabled=function(){return!this.state.disabled},this.isDisabled=function(){return this.state.disabled},this.setEnabled=function(){this.setToolState({disabled:!1,active:!1})},this.setDisabled=function(){this.setToolState({disabled:!0,active:!1})},this.disableTool=function(){console.error("DEPRECATED: use tool.setDisabled()"),this.setDisabled()},this.setSelected=function(){this.setToolState({disabled:!1,active:!0})},this.update=function(t,e){if(this.surface=t,this.needsEnabledSurface&&!t.isEnabled())return this.setDisabled()},this.updateToolState=function(t,e){return this.update(e,t)}},r.inherit(i,r.EventEmitter),e.exports=i},{"../basics":33}],116:[function(t,e,n){"use strict";var i=t("../basics"),r=(i._,function(){i.Registry.call(this)});r.Prototype=function(){this.dispose=function(){this.each(function(t){t.dispose&&t.dispose()}),this.clear()}},i.inherit(r,i.Registry),e.exports=r},{"../basics":33}],117:[function(t,e,n){"use strict";var i=t("../tool"),r=i.extend({name:"delete_columns",update:function(t,e){return this.surface=t,t.isEnabled()&&!e.isNull()&&e.isTableSelection()?void this.setToolState({surface:t,sel:e,disabled:!1}):this.setDisabled()},performAction:function(t){this.surface.transaction(function(e,n){return console.log("TODO: delete columns",t),n})}});e.exports=r},{"../tool":115}],118:[function(t,e,n){"use strict";var i=t("../tool"),r=i.extend({name:"delete_rows",update:function(t,e){return this.surface=t,t.isEnabled()&&!e.isNull()&&e.isTableSelection()?void this.setToolState({surface:t,sel:e,disabled:!1}):this.setDisabled()},performAction:function(t){this.surface.transaction(function(e,n){return console.log("TODO: delete rows",t),n})}});e.exports=r},{"../tool":115}],119:[function(t,e,n){"use strict";var i=t("../annotation_tool"),r=i.extend({name:"emphasis"});e.exports=r},{"../annotation_tool":102}],120:[function(t,e,n){e.exports={Undo:t("./undo_tool"),Redo:t("./redo_tool"),Emphasis:t("./emphasis_tool"),Strong:t("./strong_tool"),Link:t("./link_tool"),SwitchTextType:t("./switch_text_type_tool"),InsertRows:t("./insert_rows"),DeleteRows:t("./delete_rows"),InsertColumns:t("./insert_columns"),DeleteColumns:t("./delete_columns")}},{"./delete_columns":117,"./delete_rows":118,"./emphasis_tool":119,"./insert_columns":121,"./insert_rows":122,"./link_tool":123,"./redo_tool":124,"./strong_tool":125,"./switch_text_type_tool":126,"./undo_tool":127}],121:[function(t,e,n){"use strict";var i=t("../tool"),r=i.extend({name:"insert_columns",update:function(t,e){return this.surface=t,t.isEnabled()&&!e.isNull()&&e.isTableSelection()?void this.setToolState({surface:t,sel:e,disabled:!1}):this.setDisabled()},performAction:function(t){this.surface.transaction(function(e,n){return console.log("TODO: insert columns",t),n})}});e.exports=r},{"../tool":115}],122:[function(t,e,n){"use strict";var i=t("../tool"),r=i.extend({name:"insert_rows",update:function(t,e){return this.surface=t,t.isEnabled()&&!e.isNull()&&e.isTableSelection()?void this.setToolState({surface:t,sel:e,disabled:!1}):this.setDisabled()},performAction:function(t){this.surface.transaction(function(e,n){return console.log("TODO: insert rows",t),n})}});e.exports=r},{"../tool":115}],123:[function(t,e,n){"use strict";var i=t("../annotation_tool"),r=i.extend({name:"link",getAnnotationData:function(){return{url:"http://"}},update:function(t,e){if(this.surface=t,!t.isEnabled()||e.isNull()||e.isContainerSelection())return this.setDisabled();var n=this.getDocument(),i=n.getAnnotationsForSelection(e,{type:"link"}),r=(this.getToolState(),{surface:t,disabled:!1,active:!1,mode:null,sel:e,annos:i});if(this.canCreate(i,e))r.mode="create";else if(this.canTruncate(i,e))r.mode="truncate",r.active=!0;else if(this.canExpand(i,e))r.mode="expand";else{if(1!==i.length)return this.setDisabled();r.mode="edit",r.active=!0,r.showPopup=!0}this.setToolState(r)},performAction:function(){var t=this.getToolState();"edit"===t.mode?this.emit("edit",this):i.prototype.performAction.call(this)}});e.exports=r},{"../annotation_tool":102}],124:[function(t,e,n){var i=t("../tool"),r=i.extend({name:"redo",update:function(t){this.surface=t;var e=t.getDocument();t.isEnabled()&&0!==e.undone.length?this.setEnabled():this.setDisabled()},performAction:function(){var t=this.getDocument();this.isEnabled()&&t.undone.length>0&&t.redo()}});e.exports=r},{"../tool":115}],125:[function(t,e,n){"use strict";var i=t("../annotation_tool"),r=i.extend({name:"strong"});e.exports=r},{"../annotation_tool":102}],126:[function(t,e,n){"use strict";var i=t("../tool"),r=["paragraph","heading"],o={paragraph:{label:"Paragraph",data:{type:"paragraph"}},heading1:{label:"Heading 1",data:{type:"heading",level:1}},heading2:{label:"Heading 2",data:{type:"heading",level:2}},heading3:{label:"Heading 3",data:{type:"heading",level:3}}},s=i.extend({name:"text",update:function(t,e){if(this.surface=t,!t.isEnabled()||e.isNull())return this.setDisabled();if(e.isTableSelection())return this.setToolState({disabled:!0,currentContext:"table"});if(e.isContainerSelection())return this.setToolState({disabled:!0,currentContext:"container"});var n=this.getDocument(),i=e.getPath(),r=n.get(i[0]),o=this.getTextType(r),s=r.getRoot(),a=this.getContext(s,i),c={surface:t,sel:e,disabled:!o,currentTextType:o,currentContext:a};this.setToolState(c)},getAvailableTextTypes:function(){return o},isTextType:function(t){return r.indexOf(t)>=0},getTextType:function(t){if(this.isTextType(t.type)){var e=t.type;return"heading"===e&&(e+=t.level),e}},switchTextType:function(t){var e=this.getToolState();if(!this.isDisabled()){var n=o[t],i=e.surface,r=i.getEditor();i.transaction(function(t,e){return e.data=n.data,r.switchType(t,e)})}},getContext:function(t,e){return t.id===e[0]?e[1]:t.type}});e.exports=s},{"../tool":115}],127:[function(t,e,n){var i=t("../tool"),r=i.extend({name:"undo",update:function(t){this.surface=t;var e=t.getDocument();t.isEnabled()&&0!==e.done.length?this.setEnabled():this.setDisabled()},performAction:function(){var t=this.getDocument();this.isEnabled()&&t.done.length>0&&t.undo()}});e.exports=r},{"../tool":115}],128:[function(t,e,n){"use strict";var i=React.createElement,r=t("substance/helpers"),o=React.createClass({displayName:"TreeNode",render:function(){var t=this.props.node,e=this.props.treeComp,n=e.props.tree,s=n.getChildren(t.id),a=[];this.props.node._expanded&&(a=s.map(function(t){return i(o,{treeComp:e,key:t.id,node:t,handleSelection:this.props.handleSelection,handleExpansion:this.props.handleExpansion,counts:this.props.counts})}.bind(this)),r.each(this.props.children,function(t){a(i(o,{node:t}))}));var c=t._expanded?"fa-caret-down":"fa-caret-right",l=t._selected?"fa-check-square-o":"fa-square-o",u=0===s.length,h=i("span"),f=["tree-node"];if(this.props.counts){var d=this.getCount(t.id);0===d&&f.push("disabled"),h=i("span",{}," ("+d+")")}return t._selected&&f.push("selected"),t._expanded&&f.push("expanded"),i("div",{className:f.join(" ")},i("a",{"data-id":t.id,className:"expand-toggle"+(u?" hidden":""),onClick:this.props.handleExpansion,href:"#",dangerouslySetInnerHTML:{__html:'<i class="fa '+c+'"></i>'}}),i("a",{href:"#","data-id":t.id,className:"select-toggle",onClick:this.props.handleSelection,dangerouslySetInnerHTML:{__html:'<i class="fa '+l+'"></i>'}}),i("a",{href:"#",className:"name","data-id":t.id,onClick:this.props.handleSelection},t.workname||t.name,h),i("div",{className:"children"},a))},getCount:function(t){if(this.props.counts){var e=this.props.counts[t];return e?e.count:0}return 0}}),s=React.createClass({displayName:"Tree",componentWillMount:function(){this._prepare(this.props.selectedNodes)},componentWillReceiveProps:function(t){this._prepare(t.selectedNodes)},_prepare:function(t){function e(t){t&&(t._expanded=!0,e(n.get(t.parent)))}var n=this.props.tree;n.walkTree(function(t){delete t._selected,delete t._expanded});var i={};r.each(t,function(t){i[t]=!0}),n.walkTree(function(t){t._selected=i[t.id],t._selected&&e(n.get(t.parent))}),this.state={tree:n,selectedNodes:i}},getInitialState:function(){return{selectedNodes:null,tree:null}},handleExpansion:function(t){t.preventDefault();var e=t.currentTarget.dataset.id,n=this.state.tree,i=n.get(e),r=this.state.selectedNodes;i._expanded?i._expanded=!1:i._expanded=!0,this.setState({selectedNodes:r,tree:n})},handleSelection:function(t){t.preventDefault();var e=t.currentTarget.dataset.id,n=this.state.tree,i=n.get(e),r=this.state.selectedNodes;r[e]?(i._selected=!1,delete r[e]):(i._selected=!0,r[e]=!0),this.setState({selectedNodes:r,tree:n}),this.props.onSelectionChanged(r)},render:function(){var t=this.state.tree,e=t.getChildren("root"),n=e.map(function(t){return i(o,{treeComp:this,key:t.id,node:t,handleSelection:this.handleSelection,handleExpansion:this.handleExpansion,counts:this.props.counts})}.bind(this));return i("div",{className:"tree-component"},n)}});e.exports=s},{"substance/helpers":27}],129:[function(t,e,n){},{}],130:[function(t,e,n){function i(t){for(var e=-1,n=t?t.length:0,i=-1,r=[];++e<n;){var o=t[e];o&&(r[++i]=o)}return r}e.exports=i},{}],131:[function(t,e,n){function i(t,e,n){var i=-1,o=t?t.length:0;for(e=r(e,n,3);++i<o;)if(e(t[i],i,t))return i;return-1}var r=t("../internal/baseCallback");e.exports=i},{"../internal/baseCallback":156}],132:[function(t,e,n){function i(t){return t?t[0]:void 0}e.exports=i},{}],133:[function(t,e,n){function i(){for(var t=[],e=-1,n=arguments.length,i=[],l=r,u=!0;++e<n;){var h=arguments[e];(c(h)||a(h))&&(t.push(h),i.push(u&&h.length>=120?s(e&&h):null))}n=t.length;var f=t[0],d=-1,p=f?f.length:0,g=[],v=i[0];t:for(;++d<p;)if(h=f[d],(v?o(v,h):l(g,h))<0){for(e=n;--e;){var y=i[e];if((y?o(y,h):l(t[e],h))<0)continue t}v&&v.push(h),g.push(h)}return g}var r=t("../internal/baseIndexOf"),o=t("../internal/cacheIndexOf"),s=t("../internal/createCache"),a=t("../lang/isArguments"),c=t("../lang/isArray");e.exports=i},{"../internal/baseIndexOf":170,"../internal/cacheIndexOf":187,"../internal/createCache":195,"../lang/isArguments":226,"../lang/isArray":227}],134:[function(t,e,n){function i(t){var e=t?t.length:0;return e?t[e-1]:void 0}e.exports=i},{}],135:[function(t,e,n){function i(){return o(r(arguments,!1,!0))}var r=t("../internal/baseFlatten"),o=t("../internal/baseUniq");e.exports=i},{"../internal/baseFlatten":166,"../internal/baseUniq":183}],136:[function(t,e,n){function i(t,e,n,i){var c=t?t.length:0;return c?(null!=e&&"boolean"!=typeof e&&(i=n,n=s(t,e,i)?null:e,e=!1),n=null==n?n:r(n,i,3),e?a(t,n):o(t,n)):[]}var r=t("../internal/baseCallback"),o=t("../internal/baseUniq"),s=t("../internal/isIterateeCall"),a=t("../internal/sortedUniq");e.exports=i},{"../internal/baseCallback":156,"../internal/baseUniq":183,"../internal/isIterateeCall":210,"../internal/sortedUniq":222}],137:[function(t,e,n){function i(t){return r(t,o(arguments,1))}var r=t("../internal/baseDifference"),o=t("../internal/baseSlice");e.exports=i},{"../internal/baseDifference":162,"../internal/baseSlice":180}],138:[function(t,e,n){function i(t,e,n){var i=a(t)?r:s;return e=o(e,n,3),i(t,e)}var r=t("../internal/arrayFilter"),o=t("../internal/baseCallback"),s=t("../internal/baseFilter"),a=t("../lang/isArray");e.exports=i},{"../internal/arrayFilter":153,
"../internal/baseCallback":156,"../internal/baseFilter":164,"../lang/isArray":227}],139:[function(t,e,n){function i(t,e,n){if(c(t)){var i=a(t,e,n);return i>-1?t[i]:void 0}return e=r(e,n,3),s(t,e,o)}var r=t("../internal/baseCallback"),o=t("../internal/baseEach"),s=t("../internal/baseFind"),a=t("../array/findIndex"),c=t("../lang/isArray");e.exports=i},{"../array/findIndex":131,"../internal/baseCallback":156,"../internal/baseEach":163,"../internal/baseFind":165,"../lang/isArray":227}],140:[function(t,e,n){function i(t,e,n){return"function"==typeof e&&"undefined"==typeof n&&a(t)?r(t,e):o(t,s(e,n,3))}var r=t("../internal/arrayEach"),o=t("../internal/baseEach"),s=t("../internal/bindCallback"),a=t("../lang/isArray");e.exports=i},{"../internal/arrayEach":152,"../internal/baseEach":163,"../internal/bindCallback":185,"../lang/isArray":227}],141:[function(t,e,n){function i(t,e,n){var i=t?t.length:0;return s(i)||(t=c(t),i=t.length),!!i&&(n="number"==typeof n?n<0?l(i+n,0):n||0:0,"string"==typeof t||!o(t)&&a(t)?n<i&&t.indexOf(e,n)>-1:r(t,e,n)>-1)}var r=t("../internal/baseIndexOf"),o=t("../lang/isArray"),s=t("../internal/isLength"),a=t("../lang/isString"),c=t("../object/values"),l=Math.max;e.exports=i},{"../internal/baseIndexOf":170,"../internal/isLength":211,"../lang/isArray":227,"../lang/isString":235,"../object/values":242}],142:[function(t,e,n){var i=t("../internal/createAggregator"),r=i(function(t,e,n){t[n]=e});e.exports=r},{"../internal/createAggregator":192}],143:[function(t,e,n){function i(t,e,n){var i=a(t)?r:s;return e=o(e,n,3),i(t,e)}var r=t("../internal/arrayMap"),o=t("../internal/baseCallback"),s=t("../internal/baseMap"),a=t("../lang/isArray");e.exports=i},{"../internal/arrayMap":154,"../internal/baseCallback":156,"../internal/baseMap":175,"../lang/isArray":227}],144:[function(t,e,n){function i(t,e){return o(t,r(e))}var r=t("../internal/baseProperty"),o=t("./map");e.exports=i},{"../internal/baseProperty":178,"./map":143}],145:[function(t,e,n){function i(t,e,n){var i=-1,u=t?t.length:0,h=l(u)?Array(u):[];return n&&c(t,e,n)&&(e=null),e=r(e,n,3),o(t,function(t,n,r){h[++i]={criteria:e(t,n,r),index:i,value:t}}),s(h,a)}var r=t("../internal/baseCallback"),o=t("../internal/baseEach"),s=t("../internal/baseSortBy"),a=t("../internal/compareAscending"),c=t("../internal/isIterateeCall"),l=t("../internal/isLength");e.exports=i},{"../internal/baseCallback":156,"../internal/baseEach":163,"../internal/baseSortBy":181,"../internal/compareAscending":189,"../internal/isIterateeCall":210,"../internal/isLength":211}],146:[function(t,e,n){var i=t("../lang/isNative"),r=i(r=Date.now)&&r,o=r||function(){return(new Date).getTime()};e.exports=o},{"../lang/isNative":232}],147:[function(t,e,n){function i(t,e){var n=a;if(arguments.length>2){var l=r(arguments,2),u=s(l,i.placeholder);n|=c}return o(t,n,e,l,u)}var r=t("../internal/baseSlice"),o=t("../internal/createWrapper"),s=t("../internal/replaceHolders"),a=1,c=32;i.placeholder={},e.exports=i},{"../internal/baseSlice":180,"../internal/createWrapper":199,"../internal/replaceHolders":219}],148:[function(t,e,n){function i(t,e,n){function i(){v&&clearTimeout(v),f&&clearTimeout(f),f=v=y=void 0}function c(){var n=e-(o()-p);if(n<=0||n>e){f&&clearTimeout(f);var i=y;f=v=y=void 0,i&&(m=o(),d=t.apply(g,h),v||f||(h=g=null))}else v=setTimeout(c,n)}function l(){v&&clearTimeout(v),f=v=y=void 0,(w||b!==e)&&(m=o(),d=t.apply(g,h),v||f||(h=g=null))}function u(){if(h=arguments,p=o(),g=this,y=w&&(v||!x),b===!1)var n=x&&!v;else{f||x||(m=p);var i=b-(p-m),r=i<=0||i>b;r?(f&&(f=clearTimeout(f)),m=p,d=t.apply(g,h)):f||(f=setTimeout(l,i))}return r&&v?v=clearTimeout(v):v||e===b||(v=setTimeout(c,e)),n&&(r=!0,d=t.apply(g,h)),!r||v||f||(h=g=null),d}var h,f,d,p,g,v,y,m=0,b=!1,w=!0;if("function"!=typeof t)throw new TypeError(s);if(e=e<0?0:+e||0,n===!0){var x=!0;w=!1}else r(n)&&(x=n.leading,b="maxWait"in n&&a(+n.maxWait||0,e),w="trailing"in n?n.trailing:w);return u.cancel=i,u}var r=t("../lang/isObject"),o=t("../date/now"),s="Expected a function",a=Math.max;e.exports=i},{"../date/now":146,"../lang/isObject":234}],149:[function(t,e,n){function i(t,e){return r(t,e,arguments,2)}var r=t("../internal/baseDelay");e.exports=i},{"../internal/baseDelay":161}],150:[function(t,e,n){(function(n){function i(t){var e=t?t.length:0;for(this.data={hash:a(null),set:new s};e--;)this.push(t[e])}var r=t("./cachePush"),o=t("../lang/isNative"),s=o(s=n.Set)&&s,a=o(a=Object.create)&&a;i.prototype.push=r,e.exports=i}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isNative":232,"./cachePush":188}],151:[function(t,e,n){function i(t,e){var n=-1,i=t.length;for(e||(e=Array(i));++n<i;)e[n]=t[n];return e}e.exports=i},{}],152:[function(t,e,n){function i(t,e){for(var n=-1,i=t.length;++n<i&&e(t[n],n,t)!==!1;);return t}e.exports=i},{}],153:[function(t,e,n){function i(t,e){for(var n=-1,i=t.length,r=-1,o=[];++n<i;){var s=t[n];e(s,n,t)&&(o[++r]=s)}return o}e.exports=i},{}],154:[function(t,e,n){function i(t,e){for(var n=-1,i=t.length,r=Array(i);++n<i;)r[n]=e(t[n],n,t);return r}e.exports=i},{}],155:[function(t,e,n){function i(t,e,n){var i=o(e);if(!n)return r(e,t,i);for(var s=-1,a=i.length;++s<a;){var c=i[s],l=t[c],u=n(l,e[c],c,t,e);(u===u?u===l:l!==l)&&("undefined"!=typeof l||c in t)||(t[c]=u)}return t}var r=t("./baseCopy"),o=t("../object/keys");e.exports=i},{"../object/keys":239,"./baseCopy":159}],156:[function(t,e,n){function i(t,e,n){var i=typeof t;return"function"==i?"undefined"!=typeof e&&l(t)?a(t,e,n):t:null==t?c:"object"==i?r(t):"undefined"==typeof e?s(t+""):o(t+"",e)}var r=t("./baseMatches"),o=t("./baseMatchesProperty"),s=t("./baseProperty"),a=t("./bindCallback"),c=t("../utility/identity"),l=t("./isBindable");e.exports=i},{"../utility/identity":246,"./baseMatches":176,"./baseMatchesProperty":177,"./baseProperty":178,"./bindCallback":185,"./isBindable":208}],157:[function(t,e,n){function i(t,e,n,g,v,y,m){var w;if(n&&(w=v?n(t,g,v):n(t)),"undefined"!=typeof w)return w;if(!f(t))return t;var x=h(t);if(x){if(w=c(t),!e)return r(t,w)}else{var S=L.call(t),C=S==b;if(S!=_&&S!=p&&(!C||v))return M[S]?l(t,S,e):v?t:{};if(w=u(C?{}:t),!e)return s(t,w,d(t))}y||(y=[]),m||(m=[]);for(var E=y.length;E--;)if(y[E]==t)return m[E];return y.push(t),m.push(w),(x?o:a)(t,function(r,o){w[o]=i(r,e,n,o,t,y,m)}),w}var r=t("./arrayCopy"),o=t("./arrayEach"),s=t("./baseCopy"),a=t("./baseForOwn"),c=t("./initCloneArray"),l=t("./initCloneByTag"),u=t("./initCloneObject"),h=t("../lang/isArray"),f=t("../lang/isObject"),d=t("../object/keys"),p="[object Arguments]",g="[object Array]",v="[object Boolean]",y="[object Date]",m="[object Error]",b="[object Function]",w="[object Map]",x="[object Number]",_="[object Object]",S="[object RegExp]",C="[object Set]",E="[object String]",O="[object WeakMap]",T="[object ArrayBuffer]",N="[object Float32Array]",I="[object Float64Array]",A="[object Int8Array]",P="[object Int16Array]",j="[object Int32Array]",D="[object Uint8Array]",k="[object Uint8ClampedArray]",F="[object Uint16Array]",R="[object Uint32Array]",M={};M[p]=M[g]=M[T]=M[v]=M[y]=M[N]=M[I]=M[A]=M[P]=M[j]=M[x]=M[_]=M[S]=M[E]=M[D]=M[k]=M[F]=M[R]=!0,M[m]=M[b]=M[w]=M[C]=M[O]=!1;var $=Object.prototype,L=$.toString;e.exports=i},{"../lang/isArray":227,"../lang/isObject":234,"../object/keys":239,"./arrayCopy":151,"./arrayEach":152,"./baseCopy":159,"./baseForOwn":169,"./initCloneArray":205,"./initCloneByTag":206,"./initCloneObject":207}],158:[function(t,e,n){function i(t,e){if(t!==e){var n=t===t,i=e===e;if(t>e||!n||"undefined"==typeof t&&i)return 1;if(t<e||!i||"undefined"==typeof e&&n)return-1}return 0}e.exports=i},{}],159:[function(t,e,n){function i(t,e,n){n||(n=e,e={});for(var i=-1,r=n.length;++i<r;){var o=n[i];e[o]=t[o]}return e}e.exports=i},{}],160:[function(t,e,n){(function(n){var i=t("../lang/isObject"),r=function(){function t(){}return function(e){if(i(e)){t.prototype=e;var r=new t;t.prototype=null}return r||n.Object()}}();e.exports=r}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isObject":234}],161:[function(t,e,n){function i(t,e,n,i){if("function"!=typeof t)throw new TypeError(o);return setTimeout(function(){t.apply(void 0,r(n,i))},e)}var r=t("./baseSlice"),o="Expected a function";e.exports=i},{"./baseSlice":180}],162:[function(t,e,n){function i(t,e){var n=t?t.length:0,i=[];if(!n)return i;var a=-1,c=r,l=!0,u=l&&e.length>=200?s(e):null,h=e.length;u&&(c=o,l=!1,e=u);t:for(;++a<n;){var f=t[a];if(l&&f===f){for(var d=h;d--;)if(e[d]===f)continue t;i.push(f)}else c(e,f)<0&&i.push(f)}return i}var r=t("./baseIndexOf"),o=t("./cacheIndexOf"),s=t("./createCache");e.exports=i},{"./baseIndexOf":170,"./cacheIndexOf":187,"./createCache":195}],163:[function(t,e,n){function i(t,e){var n=t?t.length:0;if(!o(n))return r(t,e);for(var i=-1,a=s(t);++i<n&&e(a[i],i,a)!==!1;);return t}var r=t("./baseForOwn"),o=t("./isLength"),s=t("./toObject");e.exports=i},{"./baseForOwn":169,"./isLength":211,"./toObject":223}],164:[function(t,e,n){function i(t,e){var n=[];return r(t,function(t,i,r){e(t,i,r)&&n.push(t)}),n}var r=t("./baseEach");e.exports=i},{"./baseEach":163}],165:[function(t,e,n){function i(t,e,n,i){var r;return n(t,function(t,n,o){if(e(t,n,o))return r=i?n:t,!1}),r}e.exports=i},{}],166:[function(t,e,n){function i(t,e,n,c){for(var l=(c||0)-1,u=t.length,h=-1,f=[];++l<u;){var d=t[l];if(a(d)&&s(d.length)&&(o(d)||r(d))){e&&(d=i(d,e,n));var p=-1,g=d.length;for(f.length+=g;++p<g;)f[++h]=d[p]}else n||(f[++h]=d)}return f}var r=t("../lang/isArguments"),o=t("../lang/isArray"),s=t("./isLength"),a=t("./isObjectLike");e.exports=i},{"../lang/isArguments":226,"../lang/isArray":227,"./isLength":211,"./isObjectLike":212}],167:[function(t,e,n){function i(t,e,n){for(var i=-1,o=r(t),s=n(t),a=s.length;++i<a;){var c=s[i];if(e(o[c],c,o)===!1)break}return t}var r=t("./toObject");e.exports=i},{"./toObject":223}],168:[function(t,e,n){function i(t,e){return r(t,e,o)}var r=t("./baseFor"),o=t("../object/keysIn");e.exports=i},{"../object/keysIn":240,"./baseFor":167}],169:[function(t,e,n){function i(t,e){return r(t,e,o)}var r=t("./baseFor"),o=t("../object/keys");e.exports=i},{"../object/keys":239,"./baseFor":167}],170:[function(t,e,n){function i(t,e,n){if(e!==e)return r(t,n);for(var i=(n||0)-1,o=t.length;++i<o;)if(t[i]===e)return i;return-1}var r=t("./indexOfNaN");e.exports=i},{"./indexOfNaN":204}],171:[function(t,e,n){function i(t,e,n,o,s,a){if(t===e)return 0!==t||1/t==1/e;var c=typeof t,l=typeof e;return"function"!=c&&"object"!=c&&"function"!=l&&"object"!=l||null==t||null==e?t!==t&&e!==e:r(t,e,i,n,o,s,a)}var r=t("./baseIsEqualDeep");e.exports=i},{"./baseIsEqualDeep":172}],172:[function(t,e,n){function i(t,e,n,i,f,g,v){var y=a(t),m=a(e),b=u,w=u;y||(b=p.call(t),b==l?b=h:b!=h&&(y=c(t))),m||(w=p.call(e),w==l?w=h:w!=h&&(m=c(e)));var x=b==h,_=w==h,S=b==w;if(S&&!y&&!x)return o(t,e,b);var C=x&&d.call(t,"__wrapped__"),E=_&&d.call(e,"__wrapped__");if(C||E)return n(C?t.value():t,E?e.value():e,i,f,g,v);if(!S)return!1;g||(g=[]),v||(v=[]);for(var O=g.length;O--;)if(g[O]==t)return v[O]==e;g.push(t),v.push(e);var T=(y?r:s)(t,e,n,i,f,g,v);return g.pop(),v.pop(),T}var r=t("./equalArrays"),o=t("./equalByTag"),s=t("./equalObjects"),a=t("../lang/isArray"),c=t("../lang/isTypedArray"),l="[object Arguments]",u="[object Array]",h="[object Object]",f=Object.prototype,d=f.hasOwnProperty,p=f.toString;e.exports=i},{"../lang/isArray":227,"../lang/isTypedArray":236,"./equalArrays":200,"./equalByTag":201,"./equalObjects":202}],173:[function(t,e,n){function i(t){return"function"==typeof t||!1}e.exports=i},{}],174:[function(t,e,n){function i(t,e,n,i,o){var a=e.length;if(null==t)return!a;for(var c=-1,l=!o;++c<a;)if(l&&i[c]?n[c]!==t[e[c]]:!s.call(t,e[c]))return!1;for(c=-1;++c<a;){var u=e[c];if(l&&i[c])var h=s.call(t,u);else{var f=t[u],d=n[c];h=o?o(f,d,u):void 0,"undefined"==typeof h&&(h=r(d,f,o,!0))}if(!h)return!1}return!0}var r=t("./baseIsEqual"),o=Object.prototype,s=o.hasOwnProperty;e.exports=i},{"./baseIsEqual":171}],175:[function(t,e,n){function i(t,e){var n=[];return r(t,function(t,i,r){n.push(e(t,i,r))}),n}var r=t("./baseEach");e.exports=i},{"./baseEach":163}],176:[function(t,e,n){function i(t){var e=s(t),n=e.length;if(1==n){var i=e[0],a=t[i];if(o(a))return function(t){return null!=t&&t[i]===a&&c.call(t,i)}}for(var l=Array(n),u=Array(n);n--;)a=t[e[n]],l[n]=a,u[n]=o(a);return function(t){return r(t,e,l,u)}}var r=t("./baseIsMatch"),o=t("./isStrictComparable"),s=t("../object/keys"),a=Object.prototype,c=a.hasOwnProperty;e.exports=i},{"../object/keys":239,"./baseIsMatch":174,"./isStrictComparable":213}],177:[function(t,e,n){function i(t,e){return o(e)?function(n){return null!=n&&n[t]===e}:function(n){return null!=n&&r(e,n[t],null,!0)}}var r=t("./baseIsEqual"),o=t("./isStrictComparable");e.exports=i},{"./baseIsEqual":171,"./isStrictComparable":213}],178:[function(t,e,n){function i(t){return function(e){return null==e?void 0:e[t]}}e.exports=i},{}],179:[function(t,e,n){var i=t("../utility/identity"),r=t("./metaMap"),o=r?function(t,e){return r.set(t,e),t}:i;e.exports=o},{"../utility/identity":246,"./metaMap":215}],180:[function(t,e,n){function i(t,e,n){var i=-1,r=t.length;e=null==e?0:+e||0,e<0&&(e=-e>r?0:r+e),n="undefined"==typeof n||n>r?r:+n||0,n<0&&(n+=r),r=e>n?0:n-e>>>0,e>>>=0;for(var o=Array(r);++i<r;)o[i]=t[i+e];return o}e.exports=i},{}],181:[function(t,e,n){function i(t,e){var n=t.length;for(t.sort(e);n--;)t[n]=t[n].value;return t}e.exports=i},{}],182:[function(t,e,n){function i(t){return"string"==typeof t?t:null==t?"":t+""}e.exports=i},{}],183:[function(t,e,n){function i(t,e){var n=-1,i=r,a=t.length,c=!0,l=c&&a>=200,u=l?s():null,h=[];u?(i=o,c=!1):(l=!1,u=e?[]:h);t:for(;++n<a;){var f=t[n],d=e?e(f,n,t):f;if(c&&f===f){for(var p=u.length;p--;)if(u[p]===d)continue t;e&&u.push(d),h.push(f)}else i(u,d)<0&&((e||l)&&u.push(d),h.push(f))}return h}var r=t("./baseIndexOf"),o=t("./cacheIndexOf"),s=t("./createCache");e.exports=i},{"./baseIndexOf":170,"./cacheIndexOf":187,"./createCache":195}],184:[function(t,e,n){function i(t,e){for(var n=-1,i=e.length,r=Array(i);++n<i;)r[n]=t[e[n]];return r}e.exports=i},{}],185:[function(t,e,n){function i(t,e,n){if("function"!=typeof t)return r;if("undefined"==typeof e)return t;switch(n){case 1:return function(n){return t.call(e,n)};case 3:return function(n,i,r){return t.call(e,n,i,r)};case 4:return function(n,i,r,o){return t.call(e,n,i,r,o)};case 5:return function(n,i,r,o,s){return t.call(e,n,i,r,o,s)}}return function(){return t.apply(e,arguments)}}var r=t("../utility/identity");e.exports=i},{"../utility/identity":246}],186:[function(t,e,n){(function(n){function i(t){return a.call(t,0)}var r=t("../utility/constant"),o=t("../lang/isNative"),s=o(s=n.ArrayBuffer)&&s,a=o(a=s&&new s(0).slice)&&a,c=Math.floor,l=o(l=n.Uint8Array)&&l,u=function(){try{var t=o(t=n.Float64Array)&&t,e=new t(new s(10),0,1)&&t}catch(i){}return e}(),h=u?u.BYTES_PER_ELEMENT:0;a||(i=s&&l?function(t){var e=t.byteLength,n=u?c(e/h):0,i=n*h,r=new s(e);if(n){var o=new u(r,0,n);o.set(new u(t,0,n))}return e!=i&&(o=new l(r,i),o.set(new l(t,i))),r}:r(null)),e.exports=i}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isNative":232,"../utility/constant":245}],187:[function(t,e,n){function i(t,e){var n=t.data,i="string"==typeof e||r(e)?n.set.has(e):n.hash[e];return i?0:-1}var r=t("../lang/isObject");e.exports=i},{"../lang/isObject":234}],188:[function(t,e,n){function i(t){var e=this.data;"string"==typeof t||r(t)?e.set.add(t):e.hash[t]=!0}var r=t("../lang/isObject");e.exports=i},{"../lang/isObject":234}],189:[function(t,e,n){function i(t,e){return r(t.criteria,e.criteria)||t.index-e.index}var r=t("./baseCompareAscending");e.exports=i},{"./baseCompareAscending":158}],190:[function(t,e,n){function i(t,e,n){for(var i=n.length,o=-1,s=r(t.length-i,0),a=-1,c=e.length,l=Array(s+c);++a<c;)l[a]=e[a];for(;++o<i;)l[n[o]]=t[o];for(;s--;)l[a++]=t[o++];return l}var r=Math.max;e.exports=i},{}],191:[function(t,e,n){function i(t,e,n){for(var i=-1,o=n.length,s=-1,a=r(t.length-o,0),c=-1,l=e.length,u=Array(a+l);++s<a;)u[s]=t[s];for(var h=s;++c<l;)u[h+c]=e[c];for(;++i<o;)u[h+n[i]]=t[s++];return u}var r=Math.max;e.exports=i},{}],192:[function(t,e,n){function i(t,e){return function(n,i,a){var c=e?e():{};if(i=r(i,a,3),s(n))for(var l=-1,u=n.length;++l<u;){var h=n[l];t(c,h,i(h,l,n),n)}else o(n,function(e,n,r){t(c,e,i(e,n,r),r)});return c}}var r=t("./baseCallback"),o=t("./baseEach"),s=t("../lang/isArray");e.exports=i},{"../lang/isArray":227,"./baseCallback":156,"./baseEach":163}],193:[function(t,e,n){function i(t){return function(){var e=arguments.length,n=arguments[0];if(e<2||null==n)return n;if(e>3&&o(arguments[1],arguments[2],arguments[3])&&(e=2),e>3&&"function"==typeof arguments[e-2])var i=r(arguments[--e-1],arguments[e--],5);else e>2&&"function"==typeof arguments[e-1]&&(i=arguments[--e]);for(var s=0;++s<e;){var a=arguments[s];a&&t(n,a,i)}return n}}var r=t("./bindCallback"),o=t("./isIterateeCall");e.exports=i},{"./bindCallback":185,"./isIterateeCall":210}],194:[function(t,e,n){function i(t,e){function n(){return(this instanceof n?i:t).apply(e,arguments)}var i=r(t);return n}var r=t("./createCtorWrapper");e.exports=i},{"./createCtorWrapper":196}],195:[function(t,e,n){(function(n){var i=t("./SetCache"),r=t("../utility/constant"),o=t("../lang/isNative"),s=o(s=n.Set)&&s,a=o(a=Object.create)&&a,c=a&&s?function(t){return new i(t)}:r(null);e.exports=c}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isNative":232,"../utility/constant":245,"./SetCache":150}],196:[function(t,e,n){function i(t){return function(){var e=r(t.prototype),n=t.apply(e,arguments);return o(n)?n:e}}var r=t("./baseCreate"),o=t("../lang/isObject");e.exports=i},{"../lang/isObject":234,"./baseCreate":160}],197:[function(t,e,n){function i(t,e,n,b,w,x,_,S,C,E){function O(){for(var f=arguments.length,d=f,p=Array(f);d--;)p[d]=arguments[d];if(b&&(p=o(p,b,w)),x&&(p=s(p,x,_)),A||j){var y=O.placeholder,F=l(p,y);if(f-=F.length,f<E){var R=S?r(S):null,M=m(E-f,0),$=A?F:null,L=A?null:F,q=A?p:null,B=A?null:p;e|=A?g:v,e&=~(A?v:g),P||(e&=~(u|h));var H=i(t,e,n,q,$,B,L,R,C,M);return H.placeholder=y,H}}var U=N?n:this;return I&&(t=U[k]),S&&(p=c(p,S)),T&&C<p.length&&(p.length=C),(this instanceof O?D||a(t):t).apply(U,p)}var T=e&y,N=e&u,I=e&h,A=e&d,P=e&f,j=e&p,D=!I&&a(t),k=t;return O}var r=t("./arrayCopy"),o=t("./composeArgs"),s=t("./composeArgsRight"),a=t("./createCtorWrapper"),c=t("./reorder"),l=t("./replaceHolders"),u=1,h=2,f=4,d=8,p=16,g=32,v=64,y=256,m=Math.max;e.exports=i},{"./arrayCopy":151,"./composeArgs":190,"./composeArgsRight":191,"./createCtorWrapper":196,"./reorder":218,"./replaceHolders":219}],198:[function(t,e,n){function i(t,e,n,i){function s(){for(var e=-1,r=arguments.length,o=-1,l=i.length,u=Array(r+l);++o<l;)u[o]=i[o];for(;r--;)u[o++]=arguments[++e];return(this instanceof s?c:t).apply(a?n:this,u)}var a=e&o,c=r(t);return s}var r=t("./createCtorWrapper"),o=1;e.exports=i},{"./createCtorWrapper":196}],199:[function(t,e,n){function i(t,e,n,i,y,m,b,w){var x=e&f;if(!x&&"function"!=typeof t)throw new TypeError(g);var _=i?i.length:0;if(_||(e&=~(d|p),i=y=null),_-=y?y.length:0,e&p){var S=i,C=y;i=y=null}var E=!x&&c(t),O=[t,e,n,i,y,S,C,m,b,w];if(E&&E!==!0&&(l(O,E),e=O[1],w=O[9]),O[9]=null==w?x?0:t.length:v(w-_,0)||0,e==h)var T=o(O[0],O[2]);else T=e!=d&&e!=(h|d)||O[4].length?s.apply(void 0,O):a.apply(void 0,O);var N=E?r:u;return N(T,O)}var r=t("./baseSetData"),o=t("./createBindWrapper"),s=t("./createHybridWrapper"),a=t("./createPartialWrapper"),c=t("./getData"),l=t("./mergeData"),u=t("./setData"),h=1,f=2,d=32,p=64,g="Expected a function",v=Math.max;e.exports=i},{"./baseSetData":179,"./createBindWrapper":194,"./createHybridWrapper":197,"./createPartialWrapper":198,"./getData":203,"./mergeData":214,"./setData":220}],200:[function(t,e,n){function i(t,e,n,i,r,o,s){var a=-1,c=t.length,l=e.length,u=!0;if(c!=l&&!(r&&l>c))return!1;for(;u&&++a<c;){var h=t[a],f=e[a];if(u=void 0,i&&(u=r?i(f,h,a):i(h,f,a)),"undefined"==typeof u)if(r)for(var d=l;d--&&(f=e[d],!(u=h&&h===f||n(h,f,i,r,o,s))););else u=h&&h===f||n(h,f,i,r,o,s)}return!!u}e.exports=i},{}],201:[function(t,e,n){function i(t,e,n){switch(n){case r:case o:return+t==+e;case s:return t.name==e.name&&t.message==e.message;case a:return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case c:case l:return t==e+""}return!1}var r="[object Boolean]",o="[object Date]",s="[object Error]",a="[object Number]",c="[object RegExp]",l="[object String]";e.exports=i},{}],202:[function(t,e,n){function i(t,e,n,i,o,a,c){var l=r(t),u=l.length,h=r(e),f=h.length;if(u!=f&&!o)return!1;for(var d,p=-1;++p<u;){var g=l[p],v=s.call(e,g);if(v){var y=t[g],m=e[g];v=void 0,i&&(v=o?i(m,y,g):i(y,m,g)),"undefined"==typeof v&&(v=y&&y===m||n(y,m,i,o,a,c))}if(!v)return!1;d||(d="constructor"==g)}if(!d){var b=t.constructor,w=e.constructor;if(b!=w&&"constructor"in t&&"constructor"in e&&!("function"==typeof b&&b instanceof b&&"function"==typeof w&&w instanceof w))return!1}return!0}var r=t("../object/keys"),o=Object.prototype,s=o.hasOwnProperty;e.exports=i},{"../object/keys":239}],203:[function(t,e,n){var i=t("./metaMap"),r=t("../utility/noop"),o=i?function(t){return i.get(t)}:r;e.exports=o},{"../utility/noop":247,"./metaMap":215}],204:[function(t,e,n){function i(t,e,n){for(var i=t.length,r=n?e||i:(e||0)-1;n?r--:++r<i;){var o=t[r];if(o!==o)return r}return-1}e.exports=i},{}],205:[function(t,e,n){function i(t){var e=t.length,n=new t.constructor(e);return e&&"string"==typeof t[0]&&o.call(t,"index")&&(n.index=t.index,n.input=t.input),n}var r=Object.prototype,o=r.hasOwnProperty;e.exports=i},{}],206:[function(t,e,n){function i(t,e,n){var i=t.constructor;switch(e){case u:return r(t);case o:case s:return new i((+t));case h:case f:case d:case p:case g:case v:case y:case m:case b:var x=t.buffer;return new i(n?r(x):x,t.byteOffset,t.length);case a:case l:return new i(t);case c:var _=new i(t.source,w.exec(t));_.lastIndex=t.lastIndex}return _}var r=t("./bufferClone"),o="[object Boolean]",s="[object Date]",a="[object Number]",c="[object RegExp]",l="[object String]",u="[object ArrayBuffer]",h="[object Float32Array]",f="[object Float64Array]",d="[object Int8Array]",p="[object Int16Array]",g="[object Int32Array]",v="[object Uint8Array]",y="[object Uint8ClampedArray]",m="[object Uint16Array]",b="[object Uint32Array]",w=/\w*$/;e.exports=i},{"./bufferClone":186}],207:[function(t,e,n){function i(t){var e=t.constructor;return"function"==typeof e&&e instanceof e||(e=Object),new e}e.exports=i},{}],208:[function(t,e,n){function i(t){var e=!(s.funcNames?t.name:s.funcDecomp);if(!e){var n=l.call(t);s.funcNames||(e=!a.test(n)),e||(e=c.test(n)||o(t),r(t,e))}return e}var r=t("./baseSetData"),o=t("../lang/isNative"),s=t("../support"),a=/^\s*function[ \n\r\t]+\w/,c=/\bthis\b/,l=Function.prototype.toString;e.exports=i},{"../lang/isNative":232,"../support":244,"./baseSetData":179}],209:[function(t,e,n){function i(t,e){return t=+t,e=null==e?r:e,t>-1&&t%1==0&&t<e}var r=Math.pow(2,53)-1;e.exports=i},{}],210:[function(t,e,n){function i(t,e,n){if(!s(n))return!1;var i=typeof e;if("number"==i)var a=n.length,c=o(a)&&r(e,a);else c="string"==i&&e in n;if(c){var l=n[e];return t===t?t===l:l!==l}return!1}var r=t("./isIndex"),o=t("./isLength"),s=t("../lang/isObject");e.exports=i},{"../lang/isObject":234,"./isIndex":209,"./isLength":211}],211:[function(t,e,n){function i(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=r}var r=Math.pow(2,53)-1;e.exports=i},{}],212:[function(t,e,n){function i(t){return t&&"object"==typeof t||!1}e.exports=i},{}],213:[function(t,e,n){function i(t){return t===t&&(0===t?1/t>0:!r(t))}var r=t("../lang/isObject");e.exports=i},{"../lang/isObject":234}],214:[function(t,e,n){function i(t,e){var n=t[1],i=e[1],v=n|i,y=d|f,m=c|l,b=y|m|u|h,w=n&d&&!(i&d),x=n&f&&!(i&f),_=(x?t:e)[7],S=(w?t:e)[8],C=!(n>=f&&i>m||n>m&&i>=f),E=v>=y&&v<=b&&(n<f||(x||w)&&_.length<=S);if(!C&&!E)return t;i&c&&(t[2]=e[2],v|=n&c?0:u);var O=e[3];if(O){var T=t[3];t[3]=T?o(T,O,e[4]):r(O),t[4]=T?a(t[3],p):r(e[4])}return O=e[5],O&&(T=t[5],t[5]=T?s(T,O,e[6]):r(O),t[6]=T?a(t[5],p):r(e[6])),O=e[7],O&&(t[7]=r(O)),i&d&&(t[8]=null==t[8]?e[8]:g(t[8],e[8])),null==t[9]&&(t[9]=e[9]),t[0]=e[0],t[1]=v,t}var r=t("./arrayCopy"),o=t("./composeArgs"),s=t("./composeArgsRight"),a=t("./replaceHolders"),c=1,l=2,u=4,h=16,f=128,d=256,p="__lodash_placeholder__",g=Math.min;e.exports=i},{"./arrayCopy":151,"./composeArgs":190,"./composeArgsRight":191,"./replaceHolders":219}],215:[function(t,e,n){(function(n){var i=t("../lang/isNative"),r=i(r=n.WeakMap)&&r,o=r&&new r;e.exports=o}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isNative":232}],216:[function(t,e,n){function i(t,e){t=r(t);for(var n=-1,i=e.length,o={};++n<i;){var s=e[n];s in t&&(o[s]=t[s])}return o}var r=t("./toObject");e.exports=i},{"./toObject":223}],217:[function(t,e,n){function i(t,e){var n={};return r(t,function(t,i,r){e(t,i,r)&&(n[i]=t)}),n}var r=t("./baseForIn");e.exports=i},{"./baseForIn":168}],218:[function(t,e,n){function i(t,e){for(var n=t.length,i=s(e.length,n),a=r(t);i--;){var c=e[i];t[i]=o(c,n)?a[c]:void 0}return t}var r=t("./arrayCopy"),o=t("./isIndex"),s=Math.min;e.exports=i},{"./arrayCopy":151,"./isIndex":209}],219:[function(t,e,n){function i(t,e){for(var n=-1,i=t.length,o=-1,s=[];++n<i;)t[n]===e&&(t[n]=r,s[++o]=n);return s}var r="__lodash_placeholder__";e.exports=i},{}],220:[function(t,e,n){var i=t("./baseSetData"),r=t("../date/now"),o=150,s=16,a=function(){var t=0,e=0;return function(n,a){var c=r(),l=s-(c-e);if(e=c,l>0){if(++t>=o)return n}else t=0;return i(n,a)}}();e.exports=a},{"../date/now":146,"./baseSetData":179}],221:[function(t,e,n){function i(t){for(var e=c(t),n=e.length,i=n&&t.length,u=i&&a(i)&&(o(t)||l.nonEnumArgs&&r(t)),f=-1,d=[];++f<n;){var p=e[f];(u&&s(p,i)||h.call(t,p))&&d.push(p)}return d}var r=t("../lang/isArguments"),o=t("../lang/isArray"),s=t("./isIndex"),a=t("./isLength"),c=t("../object/keysIn"),l=t("../support"),u=Object.prototype,h=u.hasOwnProperty;e.exports=i},{"../lang/isArguments":226,"../lang/isArray":227,"../object/keysIn":240,"../support":244,"./isIndex":209,"./isLength":211}],222:[function(t,e,n){function i(t,e){for(var n,i=-1,r=t.length,o=-1,s=[];++i<r;){var a=t[i],c=e?e(a,i,t):a;i&&n===c||(n=c,s[++o]=a)}return s}e.exports=i},{}],223:[function(t,e,n){function i(t){return r(t)?t:Object(t)}var r=t("../lang/isObject");e.exports=i},{"../lang/isObject":234}],224:[function(t,e,n){function i(t,e,n,i){return e&&"boolean"!=typeof e&&s(t,e,n)?e=!1:"function"==typeof e&&(i=n,n=e,e=!1),n="function"==typeof n&&o(n,i,1),r(t,e,n)}var r=t("../internal/baseClone"),o=t("../internal/bindCallback"),s=t("../internal/isIterateeCall");e.exports=i},{"../internal/baseClone":157,"../internal/bindCallback":185,"../internal/isIterateeCall":210}],225:[function(t,e,n){function i(t,e,n){return e="function"==typeof e&&o(e,n,1),r(t,!0,e)}var r=t("../internal/baseClone"),o=t("../internal/bindCallback");e.exports=i},{"../internal/baseClone":157,"../internal/bindCallback":185}],226:[function(t,e,n){function i(t){var e=o(t)?t.length:void 0;return r(e)&&c.call(t)==s||!1}var r=t("../internal/isLength"),o=t("../internal/isObjectLike"),s="[object Arguments]",a=Object.prototype,c=a.toString;e.exports=i},{"../internal/isLength":211,"../internal/isObjectLike":212}],227:[function(t,e,n){var i=t("../internal/isLength"),r=t("./isNative"),o=t("../internal/isObjectLike"),s="[object Array]",a=Object.prototype,c=a.toString,l=r(l=Array.isArray)&&l,u=l||function(t){return o(t)&&i(t.length)&&c.call(t)==s||!1};e.exports=u},{"../internal/isLength":211,"../internal/isObjectLike":212,"./isNative":232}],228:[function(t,e,n){function i(t){return t===!0||t===!1||r(t)&&a.call(t)==o||!1}var r=t("../internal/isObjectLike"),o="[object Boolean]",s=Object.prototype,a=s.toString;e.exports=i},{"../internal/isObjectLike":212}],229:[function(t,e,n){function i(t){if(null==t)return!0;var e=t.length;return a(e)&&(o(t)||l(t)||r(t)||c(t)&&s(t.splice))?!e:!u(t).length}var r=t("./isArguments"),o=t("./isArray"),s=t("./isFunction"),a=t("../internal/isLength"),c=t("../internal/isObjectLike"),l=t("./isString"),u=t("../object/keys");e.exports=i},{"../internal/isLength":211,"../internal/isObjectLike":212,"../object/keys":239,"./isArguments":226,"./isArray":227,"./isFunction":231,"./isString":235}],230:[function(t,e,n){function i(t,e,n,i){if(n="function"==typeof n&&o(n,i,3),!n&&s(t)&&s(e))return t===e;var a=n?n(t,e):void 0;return"undefined"==typeof a?r(t,e,n):!!a}var r=t("../internal/baseIsEqual"),o=t("../internal/bindCallback"),s=t("../internal/isStrictComparable");e.exports=i},{"../internal/baseIsEqual":171,"../internal/bindCallback":185,"../internal/isStrictComparable":213}],231:[function(t,e,n){(function(n){var i=t("../internal/baseIsFunction"),r=t("./isNative"),o="[object Function]",s=Object.prototype,a=s.toString,c=r(c=n.Uint8Array)&&c,l=i(/x/)||c&&!i(c)?function(t){return a.call(t)==o}:i;e.exports=l}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../internal/baseIsFunction":173,"./isNative":232}],232:[function(t,e,n){function i(t){return null!=t&&(u.call(t)==s?h.test(l.call(t)):o(t)&&a.test(t)||!1)}var r=t("../string/escapeRegExp"),o=t("../internal/isObjectLike"),s="[object Function]",a=/^\[object .+?Constructor\]$/,c=Object.prototype,l=Function.prototype.toString,u=c.toString,h=RegExp("^"+r(u).replace(/toString|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=i},{"../internal/isObjectLike":212,"../string/escapeRegExp":243}],233:[function(t,e,n){function i(t){return"number"==typeof t||r(t)&&a.call(t)==o||!1}var r=t("../internal/isObjectLike"),o="[object Number]",s=Object.prototype,a=s.toString;e.exports=i},{"../internal/isObjectLike":212}],234:[function(t,e,n){function i(t){var e=typeof t;return"function"==e||t&&"object"==e||!1}e.exports=i},{}],235:[function(t,e,n){function i(t){return"string"==typeof t||r(t)&&a.call(t)==o||!1}var r=t("../internal/isObjectLike"),o="[object String]",s=Object.prototype,a=s.toString;e.exports=i},{"../internal/isObjectLike":212}],236:[function(t,e,n){function i(t){return o(t)&&r(t.length)&&I[P.call(t)]||!1}var r=t("../internal/isLength"),o=t("../internal/isObjectLike"),s="[object Arguments]",a="[object Array]",c="[object Boolean]",l="[object Date]",u="[object Error]",h="[object Function]",f="[object Map]",d="[object Number]",p="[object Object]",g="[object RegExp]",v="[object Set]",y="[object String]",m="[object WeakMap]",b="[object ArrayBuffer]",w="[object Float32Array]",x="[object Float64Array]",_="[object Int8Array]",S="[object Int16Array]",C="[object Int32Array]",E="[object Uint8Array]",O="[object Uint8ClampedArray]",T="[object Uint16Array]",N="[object Uint32Array]",I={};I[w]=I[x]=I[_]=I[S]=I[C]=I[E]=I[O]=I[T]=I[N]=!0,I[s]=I[a]=I[b]=I[c]=I[l]=I[u]=I[h]=I[f]=I[d]=I[p]=I[g]=I[v]=I[y]=I[m]=!1;var A=Object.prototype,P=A.toString;e.exports=i},{"../internal/isLength":211,"../internal/isObjectLike":212}],237:[function(t,e,n){var i=t("../internal/baseAssign"),r=t("../internal/createAssigner"),o=r(i);e.exports=o},{"../internal/baseAssign":155,"../internal/createAssigner":193}],238:[function(t,e,n){e.exports=t("./assign")},{"./assign":237}],239:[function(t,e,n){var i=t("../internal/isLength"),r=t("../lang/isNative"),o=t("../lang/isObject"),s=t("../internal/shimKeys"),a=r(a=Object.keys)&&a,c=a?function(t){if(t)var e=t.constructor,n=t.length;return"function"==typeof e&&e.prototype===t||"function"!=typeof t&&n&&i(n)?s(t):o(t)?a(t):[]}:s;e.exports=c},{"../internal/isLength":211,"../internal/shimKeys":221,"../lang/isNative":232,"../lang/isObject":234}],240:[function(t,e,n){function i(t){if(null==t)return[];c(t)||(t=Object(t));var e=t.length;e=e&&a(e)&&(o(t)||l.nonEnumArgs&&r(t))&&e||0;for(var n=t.constructor,i=-1,u="function"==typeof n&&n.prototype===t,f=Array(e),d=e>0;++i<e;)f[i]=i+"";
for(var p in t)d&&s(p,e)||"constructor"==p&&(u||!h.call(t,p))||f.push(p);return f}var r=t("../lang/isArguments"),o=t("../lang/isArray"),s=t("../internal/isIndex"),a=t("../internal/isLength"),c=t("../lang/isObject"),l=t("../support"),u=Object.prototype,h=u.hasOwnProperty;e.exports=i},{"../internal/isIndex":209,"../internal/isLength":211,"../lang/isArguments":226,"../lang/isArray":227,"../lang/isObject":234,"../support":244}],241:[function(t,e,n){function i(t,e,n){if(null==t)return{};if("function"!=typeof e){var i=r(s(arguments,!1,!1,1),String);return l(t,o(c(t),i))}return e=a(e,n,3),u(t,function(t,n,i){return!e(t,n,i)})}var r=t("../internal/arrayMap"),o=t("../internal/baseDifference"),s=t("../internal/baseFlatten"),a=t("../internal/bindCallback"),c=t("./keysIn"),l=t("../internal/pickByArray"),u=t("../internal/pickByCallback");e.exports=i},{"../internal/arrayMap":154,"../internal/baseDifference":162,"../internal/baseFlatten":166,"../internal/bindCallback":185,"../internal/pickByArray":216,"../internal/pickByCallback":217,"./keysIn":240}],242:[function(t,e,n){function i(t){return r(t,o(t))}var r=t("../internal/baseValues"),o=t("./keys");e.exports=i},{"../internal/baseValues":184,"./keys":239}],243:[function(t,e,n){function i(t){return t=r(t),t&&s.test(t)?t.replace(o,"\\$&"):t}var r=t("../internal/baseToString"),o=/[.*+?^${}()|[\]\/\\]/g,s=RegExp(o.source);e.exports=i},{"../internal/baseToString":182}],244:[function(t,e,n){(function(n){var i=t("./lang/isNative"),r=/\bthis\b/,o=Object.prototype,s=(s=n.window)&&s.document,a=o.propertyIsEnumerable,c={};!function(t){c.funcDecomp=!i(n.WinRTError)&&r.test(function(){return this}),c.funcNames="string"==typeof Function.name;try{c.dom=11===s.createDocumentFragment().nodeType}catch(e){c.dom=!1}try{c.nonEnumArgs=!a.call(arguments,1)}catch(e){c.nonEnumArgs=!0}}(0,0),e.exports=c}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./lang/isNative":232}],245:[function(t,e,n){function i(t){return function(){return t}}e.exports=i},{}],246:[function(t,e,n){function i(t){return t}e.exports=i},{}],247:[function(t,e,n){function i(){}e.exports=i},{}],248:[function(t,e,n){e.exports=t("./lib/polyglot")},{"./lib/polyglot":249}],249:[function(t,e,n){!function(t,i){"function"==typeof define&&define.amd?define([],function(){return i(t)}):"object"==typeof n?e.exports=i(t):t.Polyglot=i(t)}(this,function(t){"use strict";function e(t){t=t||{},this.phrases={},this.extend(t.phrases||{}),this.currentLocale=t.locale||"en",this.allowMissing=!!t.allowMissing,this.warn=t.warn||c}function n(t){var e,n,i,r={};for(e in t)if(t.hasOwnProperty(e)){n=t[e];for(i in n)r[n[i]]=e}return r}function i(t){return u.call(t,p,"")}function r(t,e,n){var r,o,a;return null!=n&&t?(o=t.split(h),a=o[s(e,n)]||o[0],r=i(a)):r=t,r}function o(t){var e=n(d);return e[t]||e.en}function s(t,e){return f[o(t)](e)}function a(t,e){for(var n in e)if("_"!==n&&e.hasOwnProperty(n)){var i=e[n];"string"==typeof i&&(i=u.call(e[n],g,v)),t=u.call(t,new RegExp("%\\{"+n+"\\}","g"),i)}return t}function c(e){t.console&&t.console.warn&&t.console.warn("WARNING: "+e)}function l(t){var e={};for(var n in t)e[n]=t[n];return e}var u=String.prototype.replace;e.VERSION="0.4.5",e.prototype.locale=function(t){return t&&(this.currentLocale=t),this.currentLocale},e.prototype.extend=function(t,e){var n;for(var i in t)t.hasOwnProperty(i)&&(n=t[i],e&&(i=e+"."+i),"object"==typeof n?this.extend(n,i):this.phrases[i]=n)},e.prototype.unset=function(t,e){var n;if("string"==typeof t)delete this.phrases[t];else for(var i in t)t.hasOwnProperty(i)&&(n=t[i],e&&(i=e+"."+i),"object"==typeof n?this.unset(n,i):delete this.phrases[i])},e.prototype.clear=function(){this.phrases={}},e.prototype.replace=function(t){this.clear(),this.extend(t)},e.prototype.t=function(t,e){var n,i;return e=null==e?{}:e,"number"==typeof e&&(e={smart_count:e}),"string"==typeof this.phrases[t]?n=this.phrases[t]:"string"==typeof e._?n=e._:this.allowMissing?n=t:(this.warn('Missing translation for key: "'+t+'"'),i=t),"string"==typeof n&&(e=l(e),i=r(n,this.currentLocale,e.smart_count),i=a(i,e)),i},e.prototype.has=function(t){return t in this.phrases};var h="||||",f={chinese:function(t){return 0},german:function(t){return 1!==t?1:0},french:function(t){return t>1?1:0},russian:function(t){return t%10===1&&t%100!==11?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2},czech:function(t){return 1===t?0:t>=2&&t<=4?1:2},polish:function(t){return 1===t?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2},icelandic:function(t){return t%10!==1||t%100===11?1:0}},d={chinese:["fa","id","ja","ko","lo","ms","th","tr","zh"],german:["da","de","en","es","fi","el","he","hu","it","nl","no","pt","sv"],french:["fr","tl","pt-br"],russian:["hr","ru"],czech:["cs"],polish:["pl"],icelandic:["is"]},p=/^\s+|\s+$/g,g=/\$/g,v="$$$$";return e})},{}],250:[function(t,e,n){"use strict";var i=t("./src/application");i.View=t("./src/view"),i.Controller=t("./src/controller"),"undefined"!=typeof window&&(i.Router=t("./src/router"),i.DefaultRouter=t("./src/default_router"),i.ElementRenderer=t("./src/renderers/element_renderer"),i.$$=i.ElementRenderer.$$),e.exports=i},{"./src/application":251,"./src/controller":252,"./src/default_router":253,"./src/renderers/element_renderer":254,"./src/router":255,"./src/view":256}],251:[function(t,e,n){"use strict";var i=t("./view"),r=t("substance-util"),o=t("underscore"),s=function(t){i.call(this),this.config=t||{},this.__controller__=null};s.Prototype=function(){this.setRouter=function(t){this.router=t},this.start=function(t){var e=window.$;t=t||{},t.el?(this.el=t.el,this.$el=e(this.el)):(this.$el=e("body"),this.el=this.$el[0]),this.initialize&&this.initialize(),this.render&&this.render(),this.router&&this.router.start()};var t={updateRoute:!0,replace:!1};this.switchState=function(e,n,i){e=JSON.parse(JSON.stringify(e));var s=this;n=o.extend({},t,n||{});var a=this.getState();this.controller.__switchState__(e,n,function(t){if(t)return void(i?i(t):(console.error(t.message),r.printStackTrace(t)));if(n.updateRoute&&s.updateRoute(n),s.afterTransition)try{s.afterTransition(e,a)}catch(o){return void(i?i(o):(console.error(o.message),r.printStackTrace(o)))}i&&i(null)})},this.stateFromFragment=function(t){function e(t){for(var e=[],n=0;n<t.length;n++)e.push({id:t[n]});return e}var n,i,r,o=t.split(";"),s=[];for(i=0;i<o.length;i++){r=o[i].split("=");var a=r[0],c=r[1];if(a&&void 0!==c)if("state"===a){var l=c.split(".");n=e(l)}else r=a.split("."),s.push({state:r[0],key:r[1],value:c})}for(i=0;i<s.length;i++){var u=s[i],h=n[u.state],f=u.value;f=window.decodeURIComponent(f);var c=JSON.parse(f);h[u.key]=c}return n},this.getState=function(){if(!this.controller.state)return null;for(var t=[],e=this.controller;e;)t.push(e.state),e=e.childController;return t},this.updateRoute=function(t){if(!this.router&&!this.config.headless)throw new Error("Application.updateRoute(): application has no router.");t=t||{};for(var e=this.getState(),n=[],i=[],r=0;r<e.length;r++){var o=e[r];if(o){var s=o.id||"default";n.push(s);for(var a in o)if("id"!==a&&"__id__"!==a&&"options"!==a){var c=JSON.stringify(o[a]),l=window.encodeURIComponent(c);i.push(r+"."+a+"="+l)}}}var u="state="+n.join(".")+";"+i.join(";");this.router.navigate(u,{trigger:!1,replace:t.replace})},this.stateChanged=function(t,e,n){n.updateRoute&&this.updateRoute(n)},this.sendError=function(t){throw t}},s.Prototype.prototype=i.prototype,s.prototype=new s.Prototype,Object.defineProperty(s.prototype,"controller",{set:function(t){t.setChangeListener(this),this.__controller__=t},get:function(){return this.__controller__}}),e.exports=s},{"./view":256,"substance-util":259,underscore:268}],252:[function(t,e,n){"use strict";var i=t("substance-util"),r=t("underscore"),o=function(){this.changeListener=null,this.state={id:"uninitialized"},this.__childController__=null,this.__parentController__=null};o.Prototype=function(){this.intitialize=function(){},this.dispose=function(){this.__childController__&&this.__childController__.dispose(),this.__childController__=null,this.state={id:"uninitialized"}},this.transition=function(t,e){e(null)},this.switchState=function(t,e,n){t=JSON.parse(JSON.stringify(t)),!n&&r.isFunction(e)&&(n=e);var o=this;1===arguments.length&&r.isFunction(e)&&(n=e,e={}),e=e||{updateRoute:!0,replace:!1},n=n||function(n){if(n)throw console.error("Error during switch state",t,e),i.printStackTrace(n),new Error(n)};var s=this.state;this.__switchState__(t,e,function(t){return t?n(t):(o.changeListener&&o.changeListener.stateChanged(this,s,e),void n(null))})},this.__switchState__=function(t,e,n){var i=this;n=n||function(t){if(t)throw new Error(t)},r.isArray(t)||(t=[t]);var o=t.shift();o.options=e||{};var s,a=function(){if(!s){var t=i.state;i.state=o,i.afterTransition(t),i.state.options={}}n(null)},c=function(){try{i.transition(o,function(e,o){if(e)return n(e);if(r.isBoolean(o)?s=o:o&&(s=o.skip),i.childController)if(t.length>0)i.childController.__switchState__(t,o,function(t){return t?n(t):void a()});else{if(!i.childController.DEFAULT_STATE)throw new Error("Unsufficient state data provided! Child controller needs a transition!");i.childController.__switchState__(i.childController.DEFAULT_STATE,o,function(t){return t?n(t):void a()})}else a()})}catch(e){n(e)}};this.state?c():this.initialize(o,function(t){return t?n(t):(i.state={id:"initialized"},void c())})},this.afterTransition=function(){},this.setChildController=function(t,e){e=e||{},this.__childController__&&this.__childController__.state&&!e.nowarn&&console.error("The child controller has not been disposed. Call 'disposeChildController()' first."),t&&(this.changeListener?t.changeListener=this.changeListener:console.error("This controller does not have a changeListener attached, so the child controller will not trigger corresponding application state changes."),t.__parentController__=this,this.__childController__=t)},this.disposeChildController=function(){this.__childController__&&(this.__childController__.dispose(),this.__childController__=null)},this.setChangeListener=function(t){this.changeListener=t},this.sendError=function(t){this.__parentController__&&this.__parentController__.sendError(t)}},o.Prototype.prototype=i.Events,o.prototype=new o.Prototype,o.State=function(t){if(r.isString(t))this.__id__=t;else{var e=arguments[0];this.__id__=e.id,r.each(e,function(t,e){"id"!==e&&(this[e]=t)},this)}},Object.defineProperty(o.State.prototype,"id",{set:function(){throw new Error("Property 'id' is immutable")},get:function(){return this.__id__}}),Object.defineProperty(o.prototype,"childController",{set:function(t){this.setChildController(t)},get:function(){return this.__childController__}}),e.exports=o},{"substance-util":259,underscore:268}],253:[function(t,e,n){"use strict";var i=t("underscore"),r=t("./router"),o=function(t){r.call(this),this.app=t,i.each(o.routes,function(t){this[t.command]?this.route(t.route,t.name,i.bind(this[t.command],this)):console.error("Unknown route handler: ",t.command)},this),this.route(/^state=.*$/,"state",i.bind(this.openState,this))};o.Prototype=function(){this.start=function(){r.history.start()};var t={updateRoute:!1,replace:!1};this.openState=function(){var e=r.history.getFragment(),n=this.app.stateFromFragment(e);console.log("state change triggerd by router",JSON.stringify(n)),this.app.switchState(n,t)},this.navigate=function(t,e){r.history.navigate(t,e)}},o.Prototype.prototype=r.prototype,o.prototype=new o.Prototype,e.exports=o},{"./router":255,underscore:268}],254:[function(t,e,n){"use strict";var i=t("substance-util"),r=t("substance-regexp"),o=function(t){return this.attributes=t,this.tagName=t.tag,this.children=t.children||[],this.text=t.text||"",this.html=t.html,delete t.children,delete t.text,delete t.html,delete t.tag,this.render()};o.Prototype=function(){this.render=function(){var t=window.document.createElement(this.tagName);this.html?t.innerHTML=this.html:t.textContent=this.text;for(var e in this.attributes){var n=this.attributes[e];t.setAttribute(e,n)}for(var i=0;i<this.children.length;i++){var r=this.children[i];t.appendChild(r)}return this.el=t,t}};var s=function(t,e){e=e||{};var n=/^([a-zA-Z0-9]*)/.exec(t);e.tag=n&&n[1]?n[1]:"div";var i=/#([a-zA-Z0-9_]*)/.exec(t);i&&i[1]&&(e.id=i[1]);var s=new r(/\.([a-zA-Z0-9_-]*)/g);return e["class"]||(e["class"]=s.match(t).map(function(t){return t.match[1]}).join(" ")),new o(e)};o.$$=s,o.Prototype.prototype=i.Events,o.prototype=new o.Prototype,e.exports=o},{"substance-regexp":257,"substance-util":259}],255:[function(t,e,n){"use strict";var i,r=t("substance-util"),o=t("underscore");"undefined"!=typeof window?i=window.$:(console.error("FIXME: require router.js only when you are in a window context."),i=null);var s=function(t){t=t||{},t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},a=/\((.*?)\)/g,c=/(\(\?)?:\w+/g,l=/\*\w+/g,u=/[\-{}\[\]+?.,\\\^$|#\s]/g;o.extend(s.prototype,r.Events,{initialize:function(){},route:function(t,e,n){o.isRegExp(t)||(t=this._routeToRegExp(t)),o.isFunction(e)&&(n=e,e=""),n||(n=this[e]);var i=this;return s.history.route(t,function(r){var o=i._extractParameters(t,r);n&&n.apply(i,o),i.trigger.apply(i,["route:"+e].concat(o)),i.trigger("route",e,o),s.history.trigger("route",i,e,o)}),this},navigate:function(t,e){return s.history.navigate(t,e),this},_bindRoutes:function(){if(this.routes){this.routes=o.result(this,"routes");for(var t,e=o.keys(this.routes);null!==(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(u,"\\$&").replace(a,"(?:$1)?").replace(c,function(t,e){return e?t:"([^/]+)"}).replace(l,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,e){var n=t.exec(e).slice(1);return o.map(n,function(t){return t?decodeURIComponent(t):null})}});var h=s.History=function(){this.handlers=[],o.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},f=/^[#\/]|\s+$/g,d=/^\/+|\/+$/g,p=/msie [\w.]+/,g=/\/$/;h.started=!1,o.extend(h.prototype,r.Events,{interval:50,getHash:function(t){var e=(t||window).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(null===t||void 0===t)if(this._hasPushState||!this._wantsHashChange||e){t=this.location.pathname;var n=this.root.replace(g,"");t.indexOf(n)||(t=t.substr(n.length))}else t=this.getHash();return t.replace(f,"")},start:function(t){if(h.started)throw new Error("Router.history has already been started");h.started=!0,this.options=o.extend({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var e=this.getFragment(),n=window.document.documentMode,r=p.exec(window.navigator.userAgent.toLowerCase())&&(!n||n<=7);this.root=("/"+this.root+"/").replace(d,"/"),r&&this._wantsHashChange&&(this.iframe=i('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e)),this._hasPushState?i(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!r?i(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=e;var s=this.location,a=s.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!a?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&a&&s.hash&&(this.fragment=this.getHash().replace(f,""),this.history.replaceState({},window.document.title,this.root+this.fragment+s.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){i(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),h.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t!==this.fragment&&(this.iframe&&this.navigate(t),void(this.loadUrl()||this.loadUrl(this.getHash())))},loadUrl:function(t){var e=this.fragment=this.getFragment(t),n=o.any(this.handlers,function(t){if(t.route.test(e))return t.callback(e),!0});return n},navigate:function(t,e){if(!h.started)return!1;if(e&&e!==!0||(e={trigger:e}),t=this.getFragment(t||""),this.fragment!==t){this.fragment=t;var n=this.root+t;if(this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},window.document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}e.trigger&&this.loadUrl(t)}},_updateHash:function(t,e,n){if(n){var i=t.href.replace(/(javascript:|#).*$/,"");t.replace(i+"#"+e)}else t.hash="#"+e}}),s.history=new h,e.exports=s},{"substance-util":259,underscore:268}],256:[function(t,e,n){"use strict";var i=t("substance-util"),r=function(){this.$el=window.$("<div/>"),this.el=this.$el[0],this.dispatchDOMEvents()};r.Prototype=function(){this.dispose=function(){this.stopListening()},this.$=function(t){return this.$el.find(t)},this.dispatchDOMEvents=function(){function t(t){var e=/(\w+)\((.*)\)/.exec(t);if(!e)throw new Error("Invalid click handler '"+t+"'");return{method:e[1],args:e[2].split(",")}}var e=this;this.$el.delegate("[sbs-click]","click",function(n){var i=t(window.$(n.currentTarget).attr("sbs-click")),r=e[i.method];if(r)return r.apply(e,i.args),!1})},this.updateTitle=function(t){window.document.title=t,window.history.replaceState({},window.document.title,window.location.href)}},r.Prototype.prototype=i.Events,r.prototype=new r.Prototype,e.exports=r},{"substance-util":259}],257:[function(t,e,n){"use strict";e.exports=t("./src/regexp")},{"./src/regexp":258}],258:[function(t,e,n){"use strict";var i=function(t){this.index=t.index,this.match=[];for(var e=0;e<t.length;e++)this.match.push(t[e])};i.Prototype=function(){this.captures=function(){return this.match.slice(1)},this.toString=function(){return this.match[0]}},i.prototype=new i.Prototype;var r=function(t){this.exp=t};r.Prototype=function(){this.match=function(t){if(void 0===t)throw new Error("No string given");if(this.exp.global){var e,n=[];for(this.exp.compile(this.exp);null!==(e=this.exp.exec(t));)n.push(new i(e));return n}return this.exp.exec(t)}},r.prototype=new r.Prototype,r.Match=i,e.exports=r},{}],259:[function(t,e,n){"use strict";var i=t("./src/util");i.async=t("./src/async"),i.errors=t("./src/errors"),i.html=t("./src/html"),i.dom=t("./src/dom"),i.RegExp=t("./src/regexp"),i.Fragmenter=t("./src/fragmenter"),e.exports=i},{"./src/async":261,"./src/dom":262,"./src/errors":263,"./src/fragmenter":264,"./src/html":265,"./src/regexp":266,"./src/util":267}],260:[function(t,e,n){(function(){var t=this,i=t._,r={},o=Array.prototype,s=Object.prototype,a=Function.prototype,c=o.push,l=o.slice,u=o.concat,h=s.toString,f=s.hasOwnProperty,d=o.forEach,p=o.map,g=o.reduce,v=o.reduceRight,y=o.filter,m=o.every,b=o.some,w=o.indexOf,x=o.lastIndexOf,_=Array.isArray,S=Object.keys,C=a.bind,E=function(t){return t instanceof E?t:this instanceof E?void(this._wrapped=t):new E(t)};"undefined"!=typeof n?("undefined"!=typeof e&&e.exports&&(n=e.exports=E),n._=E):t._=E,E.VERSION="1.5.2";var O=E.each=E.forEach=function(t,e,n){if(null!=t)if(d&&t.forEach===d)t.forEach(e,n);else if(t.length===+t.length){for(var i=0,o=t.length;i<o;i++)if(e.call(n,t[i],i,t)===r)return}else for(var s=E.keys(t),i=0,o=s.length;i<o;i++)if(e.call(n,t[s[i]],s[i],t)===r)return};E.map=E.collect=function(t,e,n){var i=[];return null==t?i:p&&t.map===p?t.map(e,n):(O(t,function(t,r,o){i.push(e.call(n,t,r,o))}),i)};var T="Reduce of empty array with no initial value";E.reduce=E.foldl=E.inject=function(t,e,n,i){var r=arguments.length>2;if(null==t&&(t=[]),g&&t.reduce===g)return i&&(e=E.bind(e,i)),r?t.reduce(e,n):t.reduce(e);if(O(t,function(t,o,s){r?n=e.call(i,n,t,o,s):(n=t,r=!0)}),!r)throw new TypeError(T);return n},E.reduceRight=E.foldr=function(t,e,n,i){var r=arguments.length>2;if(null==t&&(t=[]),v&&t.reduceRight===v)return i&&(e=E.bind(e,i)),r?t.reduceRight(e,n):t.reduceRight(e);var o=t.length;if(o!==+o){var s=E.keys(t);o=s.length}if(O(t,function(a,c,l){c=s?s[--o]:--o,r?n=e.call(i,n,t[c],c,l):(n=t[c],r=!0)}),!r)throw new TypeError(T);return n},E.find=E.detect=function(t,e,n){var i;return N(t,function(t,r,o){if(e.call(n,t,r,o))return i=t,!0}),i},E.filter=E.select=function(t,e,n){var i=[];return null==t?i:y&&t.filter===y?t.filter(e,n):(O(t,function(t,r,o){e.call(n,t,r,o)&&i.push(t)}),i)},E.reject=function(t,e,n){return E.filter(t,function(t,i,r){return!e.call(n,t,i,r)},n)},E.every=E.all=function(t,e,n){e||(e=E.identity);var i=!0;return null==t?i:m&&t.every===m?t.every(e,n):(O(t,function(t,o,s){if(!(i=i&&e.call(n,t,o,s)))return r}),!!i)};var N=E.some=E.any=function(t,e,n){e||(e=E.identity);var i=!1;return null==t?i:b&&t.some===b?t.some(e,n):(O(t,function(t,o,s){if(i||(i=e.call(n,t,o,s)))return r}),!!i)};E.contains=E.include=function(t,e){return null!=t&&(w&&t.indexOf===w?t.indexOf(e)!=-1:N(t,function(t){return t===e}))},E.invoke=function(t,e){var n=l.call(arguments,2),i=E.isFunction(e);return E.map(t,function(t){return(i?e:t[e]).apply(t,n)})},E.pluck=function(t,e){return E.map(t,function(t){return t[e]})},E.where=function(t,e,n){return E.isEmpty(e)?n?void 0:[]:E[n?"find":"filter"](t,function(t){for(var n in e)if(e[n]!==t[n])return!1;return!0})},E.findWhere=function(t,e){return E.where(t,e,!0)},E.max=function(t,e,n){if(!e&&E.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.max.apply(Math,t);if(!e&&E.isEmpty(t))return-(1/0);var i={computed:-(1/0),value:-(1/0)};return O(t,function(t,r,o){var s=e?e.call(n,t,r,o):t;s>i.computed&&(i={value:t,computed:s})}),i.value},E.min=function(t,e,n){if(!e&&E.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.min.apply(Math,t);if(!e&&E.isEmpty(t))return 1/0;var i={computed:1/0,value:1/0};return O(t,function(t,r,o){var s=e?e.call(n,t,r,o):t;s<i.computed&&(i={value:t,computed:s})}),i.value},E.shuffle=function(t){var e,n=0,i=[];return O(t,function(t){e=E.random(n++),i[n-1]=i[e],i[e]=t}),i},E.sample=function(t,e,n){return arguments.length<2||n?t[E.random(t.length-1)]:E.shuffle(t).slice(0,Math.max(0,e))};var I=function(t){return E.isFunction(t)?t:function(e){return e[t]}};E.sortBy=function(t,e,n){var i=I(e);return E.pluck(E.map(t,function(t,e,r){return{value:t,index:e,criteria:i.call(n,t,e,r)}}).sort(function(t,e){var n=t.criteria,i=e.criteria;if(n!==i){if(n>i||void 0===n)return 1;if(n<i||void 0===i)return-1}return t.index-e.index}),"value")};var A=function(t){return function(e,n,i){var r={},o=null==n?E.identity:I(n);return O(e,function(n,s){var a=o.call(i,n,s,e);t(r,a,n)}),r}};E.groupBy=A(function(t,e,n){(E.has(t,e)?t[e]:t[e]=[]).push(n)}),E.indexBy=A(function(t,e,n){t[e]=n}),E.countBy=A(function(t,e){E.has(t,e)?t[e]++:t[e]=1}),E.sortedIndex=function(t,e,n,i){n=null==n?E.identity:I(n);for(var r=n.call(i,e),o=0,s=t.length;o<s;){var a=o+s>>>1;n.call(i,t[a])<r?o=a+1:s=a}return o},E.toArray=function(t){return t?E.isArray(t)?l.call(t):t.length===+t.length?E.map(t,E.identity):E.values(t):[]},E.size=function(t){return null==t?0:t.length===+t.length?t.length:E.keys(t).length},E.first=E.head=E.take=function(t,e,n){if(null!=t)return null==e||n?t[0]:l.call(t,0,e)},E.initial=function(t,e,n){return l.call(t,0,t.length-(null==e||n?1:e))},E.last=function(t,e,n){if(null!=t)return null==e||n?t[t.length-1]:l.call(t,Math.max(t.length-e,0))},E.rest=E.tail=E.drop=function(t,e,n){return l.call(t,null==e||n?1:e)},E.compact=function(t){return E.filter(t,E.identity)};var P=function(t,e,n){return e&&E.every(t,E.isArray)?u.apply(n,t):(O(t,function(t){E.isArray(t)||E.isArguments(t)?e?c.apply(n,t):P(t,e,n):n.push(t)}),n)};E.flatten=function(t,e){return P(t,e,[])},E.without=function(t){return E.difference(t,l.call(arguments,1))},E.uniq=E.unique=function(t,e,n,i){E.isFunction(e)&&(i=n,n=e,e=!1);var r=n?E.map(t,n,i):t,o=[],s=[];return O(r,function(n,i){(e?i&&s[s.length-1]===n:E.contains(s,n))||(s.push(n),o.push(t[i]))}),o},E.union=function(){return E.uniq(E.flatten(arguments,!0))},E.intersection=function(t){var e=l.call(arguments,1);return E.filter(E.uniq(t),function(t){return E.every(e,function(e){return E.indexOf(e,t)>=0})})},E.difference=function(t){var e=u.apply(o,l.call(arguments,1));return E.filter(t,function(t){return!E.contains(e,t)})},E.zip=function(){for(var t=E.max(E.pluck(arguments,"length").concat(0)),e=new Array(t),n=0;n<t;n++)e[n]=E.pluck(arguments,""+n);return e},E.object=function(t,e){if(null==t)return{};for(var n={},i=0,r=t.length;i<r;i++)e?n[t[i]]=e[i]:n[t[i][0]]=t[i][1];return n},E.indexOf=function(t,e,n){if(null==t)return-1;var i=0,r=t.length;if(n){if("number"!=typeof n)return i=E.sortedIndex(t,e),t[i]===e?i:-1;i=n<0?Math.max(0,r+n):n}if(w&&t.indexOf===w)return t.indexOf(e,n);for(;i<r;i++)if(t[i]===e)return i;return-1},E.lastIndexOf=function(t,e,n){if(null==t)return-1;var i=null!=n;if(x&&t.lastIndexOf===x)return i?t.lastIndexOf(e,n):t.lastIndexOf(e);for(var r=i?n:t.length;r--;)if(t[r]===e)return r;return-1},E.range=function(t,e,n){arguments.length<=1&&(e=t||0,t=0),n=arguments[2]||1;for(var i=Math.max(Math.ceil((e-t)/n),0),r=0,o=new Array(i);r<i;)o[r++]=t,t+=n;return o};var j=function(){};E.bind=function(t,e){var n,i;if(C&&t.bind===C)return C.apply(t,l.call(arguments,1));if(!E.isFunction(t))throw new TypeError;return n=l.call(arguments,2),i=function(){if(!(this instanceof i))return t.apply(e,n.concat(l.call(arguments)));j.prototype=t.prototype;var r=new j;j.prototype=null;var o=t.apply(r,n.concat(l.call(arguments)));return Object(o)===o?o:r}},E.partial=function(t){var e=l.call(arguments,1);return function(){return t.apply(this,e.concat(l.call(arguments)))}},E.bindAll=function(t){var e=l.call(arguments,1);if(0===e.length)throw new Error("bindAll must be passed function names");return O(e,function(e){t[e]=E.bind(t[e],t)}),t},E.memoize=function(t,e){var n={};return e||(e=E.identity),function(){var i=e.apply(this,arguments);return E.has(n,i)?n[i]:n[i]=t.apply(this,arguments)}},E.delay=function(t,e){var n=l.call(arguments,2);return setTimeout(function(){return t.apply(null,n)},e)},E.defer=function(t){return E.delay.apply(E,[t,1].concat(l.call(arguments,1)))},E.throttle=function(t,e,n){var i,r,o,s=null,a=0;n||(n={});var c=function(){a=n.leading===!1?0:new Date,s=null,o=t.apply(i,r)};return function(){var l=new Date;a||n.leading!==!1||(a=l);var u=e-(l-a);return i=this,r=arguments,u<=0?(clearTimeout(s),s=null,a=l,o=t.apply(i,r)):s||n.trailing===!1||(s=setTimeout(c,u)),o}},E.debounce=function(t,e,n){var i,r,o,s,a;return function(){o=this,r=arguments,s=new Date;var c=function(){var l=new Date-s;l<e?i=setTimeout(c,e-l):(i=null,n||(a=t.apply(o,r)))},l=n&&!i;return i||(i=setTimeout(c,e)),l&&(a=t.apply(o,r)),a}},E.once=function(t){var e,n=!1;return function(){return n?e:(n=!0,e=t.apply(this,arguments),t=null,e)}},E.wrap=function(t,e){return function(){var n=[t];return c.apply(n,arguments),e.apply(this,n)}},E.compose=function(){var t=arguments;return function(){for(var e=arguments,n=t.length-1;n>=0;n--)e=[t[n].apply(this,e)];return e[0]}},E.after=function(t,e){return function(){if(--t<1)return e.apply(this,arguments)}},E.keys=S||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var n in t)E.has(t,n)&&e.push(n);return e},E.values=function(t){for(var e=E.keys(t),n=e.length,i=new Array(n),r=0;r<n;r++)i[r]=t[e[r]];return i},E.pairs=function(t){for(var e=E.keys(t),n=e.length,i=new Array(n),r=0;r<n;r++)i[r]=[e[r],t[e[r]]];return i},E.invert=function(t){for(var e={},n=E.keys(t),i=0,r=n.length;i<r;i++)e[t[n[i]]]=n[i];return e},E.functions=E.methods=function(t){var e=[];for(var n in t)E.isFunction(t[n])&&e.push(n);return e.sort()},E.extend=function(t){return O(l.call(arguments,1),function(e){if(e)for(var n in e)t[n]=e[n]}),t},E.pick=function(t){var e={},n=u.apply(o,l.call(arguments,1));return O(n,function(n){n in t&&(e[n]=t[n])}),e},E.omit=function(t){var e={},n=u.apply(o,l.call(arguments,1));for(var i in t)E.contains(n,i)||(e[i]=t[i]);return e},E.defaults=function(t){return O(l.call(arguments,1),function(e){if(e)for(var n in e)void 0===t[n]&&(t[n]=e[n])}),t},E.clone=function(t){return E.isObject(t)?E.isArray(t)?t.slice():E.extend({},t):t},E.tap=function(t,e){return e(t),t};var D=function(t,e,n,i){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return t===e;t instanceof E&&(t=t._wrapped),e instanceof E&&(e=e._wrapped);var r=h.call(t);if(r!=h.call(e))return!1;switch(r){case"[object String]":return t==String(e);case"[object Number]":return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object RegExp]":return t.source==e.source&&t.global==e.global&&t.multiline==e.multiline&&t.ignoreCase==e.ignoreCase}if("object"!=typeof t||"object"!=typeof e)return!1;for(var o=n.length;o--;)if(n[o]==t)return i[o]==e;var s=t.constructor,a=e.constructor;if(s!==a&&!(E.isFunction(s)&&s instanceof s&&E.isFunction(a)&&a instanceof a))return!1;n.push(t),i.push(e);var c=0,l=!0;if("[object Array]"==r){if(c=t.length,l=c==e.length)for(;c--&&(l=D(t[c],e[c],n,i)););}else{for(var u in t)if(E.has(t,u)&&(c++,!(l=E.has(e,u)&&D(t[u],e[u],n,i))))break;if(l){for(u in e)if(E.has(e,u)&&!c--)break;l=!c}}return n.pop(),i.pop(),l};E.isEqual=function(t,e){return D(t,e,[],[])},E.isEmpty=function(t){if(null==t)return!0;if(E.isArray(t)||E.isString(t))return 0===t.length;for(var e in t)if(E.has(t,e))return!1;return!0},E.isElement=function(t){return!(!t||1!==t.nodeType)},E.isArray=_||function(t){return"[object Array]"==h.call(t)},E.isObject=function(t){return t===Object(t)},O(["Arguments","Function","String","Number","Date","RegExp"],function(t){E["is"+t]=function(e){return h.call(e)=="[object "+t+"]"}}),E.isArguments(arguments)||(E.isArguments=function(t){return!(!t||!E.has(t,"callee"))}),"function"!=typeof/./&&(E.isFunction=function(t){return"function"==typeof t}),E.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},E.isNaN=function(t){return E.isNumber(t)&&t!=+t},E.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==h.call(t)},E.isNull=function(t){return null===t},E.isUndefined=function(t){return void 0===t},E.has=function(t,e){return f.call(t,e)},E.noConflict=function(){return t._=i,this},E.identity=function(t){return t},E.times=function(t,e,n){for(var i=Array(Math.max(0,t)),r=0;r<t;r++)i[r]=e.call(n,r);return i},E.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))};var k={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};k.unescape=E.invert(k.escape);var F={escape:new RegExp("["+E.keys(k.escape).join("")+"]","g"),unescape:new RegExp("("+E.keys(k.unescape).join("|")+")","g")};E.each(["escape","unescape"],function(t){E[t]=function(e){return null==e?"":(""+e).replace(F[t],function(e){return k[t][e]})}}),E.result=function(t,e){if(null!=t){var n=t[e];return E.isFunction(n)?n.call(t):n}},E.mixin=function(t){O(E.functions(t),function(e){var n=E[e]=t[e];E.prototype[e]=function(){var t=[this._wrapped];return c.apply(t,arguments),q.call(this,n.apply(E,t))}})};var R=0;E.uniqueId=function(t){var e=++R+"";return t?t+e:e},E.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var M=/(.)^/,$={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028","\u2029":"u2029"},L=/\\|'|\r|\n|\t|\u2028|\u2029/g;E.template=function(t,e,n){var i;n=E.defaults({},n,E.templateSettings);var r=new RegExp([(n.escape||M).source,(n.interpolate||M).source,(n.evaluate||M).source].join("|")+"|$","g"),o=0,s="__p+='";t.replace(r,function(e,n,i,r,a){return s+=t.slice(o,a).replace(L,function(t){return"\\"+$[t]}),n&&(s+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),
i&&(s+="'+\n((__t=("+i+"))==null?'':__t)+\n'"),r&&(s+="';\n"+r+"\n__p+='"),o=a+e.length,e}),s+="';\n",n.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{i=new Function(n.variable||"obj","_",s)}catch(a){throw a.source=s,a}if(e)return i(e,E);var c=function(t){return i.call(this,t,E)};return c.source="function("+(n.variable||"obj")+"){\n"+s+"}",c},E.chain=function(t){return E(t).chain()};var q=function(t){return this._chain?E(t).chain():t};E.mixin(E),O(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=o[t];E.prototype[t]=function(){var n=this._wrapped;return e.apply(n,arguments),"shift"!=t&&"splice"!=t||0!==n.length||delete n[0],q.call(this,n)}}),O(["concat","join","slice"],function(t){var e=o[t];E.prototype[t]=function(){return q.call(this,e.apply(this._wrapped,arguments))}}),E.extend(E.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this)},{}],261:[function(t,e,n){"use strict";function i(t,e){function n(t){var e=a[c];if(!e)return u.length>0?i(new Error("Multiple errors occurred.",t)):i(null,t);var r=o.once(function(t,e){if(t){if(l)return i(t,null);u.push(t)}c+=1,n(e)});try{0===e.length?(e(),r(null,t)):1===e.length?e(r):e(t,r)}catch(h){console.log("util.async caught error:",h),s.printStackTrace(h),i(h)}}var i=t["finally"]||function(t,n){e(t,n)};i=o.once(i);var r=t.data||{},a=t.functions;if(!o.isFunction(e))return e("Illegal arguments: a callback function must be provided");var c=0,l=void 0===t.stopOnError||t.stopOnError,u=[];n(r)}function r(t){return function(e,n){function r(t,e){return function(n,i){2===h.length?h(t,i):3===h.length?h(t,e,i):h(t,e,n,i)}}function s(t,e){return function(n,i){2===h.length?h(t,i):3===h.length?h(t,e,i):h(t,e,n,i)}}var a=t.selector?t.selector(e):t.items,c=t["finally"]||function(t,e){n(t,e)};if(c=o.once(c),!a)return c(null,e);var l=o.isArray(a);t.before&&t.before(e);var u=[],h=t.iterator;if(l)for(var f=0;f<a.length;f++)u.push(r(a[f],f));else for(var d in a)u.push(s(a[d],d));var p={functions:u,data:e,"finally":c,stopOnError:t.stopOnError};i(p,n)}}var o=t("underscore"),s=t("./util.js"),a={};a.sequential=function(t,e){o.isArray(t)&&(t={functions:t}),i(t,e)},a.iterator=function(t,e){var n;return n=1==arguments.length?t:{items:t,iterator:e},r(n)},a.each=function(t,e){var n=r(t);n(null,e)},e.exports=a},{"./util.js":267,underscore:260}],262:[function(t,e,n){"use strict";var i=t("underscore"),r={};r.ChildNodeIterator=function(t){i.isArray(t)?this.nodes=t:this.nodes=t.childNodes,this.length=this.nodes.length,this.pos=-1},r.ChildNodeIterator.prototype={hasNext:function(){return this.pos<this.length-1},next:function(){return this.pos+=1,this.nodes[this.pos]},back:function(){return this.pos>=0&&(this.pos-=1),this}},r.getChildren=function(t){if(void 0!==t.children)return t.children;for(var e=[],n=t.firstElementChild;n;)e.push(n),n=n.nextElementSibling;return e},r.getNodeType=function(t){return t.nodeType===window.Node.TEXT_NODE?"text":t.nodeType===window.Node.COMMENT_NODE?"comment":t.tagName?t.tagName.toLowerCase():(console.error("Can't get node type for ",t),"unknown")},e.exports=r},{underscore:260}],263:[function(t,e,n){"use strict";var i=t("./util"),r={},o=function(t,e){e?(Error.call(this,t,e.fileName,e.lineNumber),e instanceof o?this.__stack=e.__stack:e.stack?this.__stack=i.parseStackTrace(e):this.__stack=i.callstack(1)):(Error.call(this,t),this.__stack=i.callstack(1)),this.message=t};o.Prototype=function(){this.name="SubstanceError",this.code=-1,this.toString=function(){return this.name+":"+this.message},this.toJSON=function(){return{name:this.name,message:this.message,code:this.code,stack:this.stack}},this.printStackTrace=function(){i.printStackTrace(this)}},o.Prototype.prototype=Error.prototype,o.prototype=new o.Prototype,Object.defineProperty(o.prototype,"stack",{get:function(){for(var t=[],e=0;e<this.__stack.length;e++){var n=this.__stack[e];t.push(n.file+":"+n.line+":"+n.col+" ("+n.func+")")}return t.join("\n")},set:function(){throw new Error("SubstanceError.stack is read-only.")}}),r.SubstanceError=o;var s=function(t,e,n){return function(i){t.call(this,i),this.name=e,this.code=n}};r.define=function(t,e,n){if(!t)throw new o("Name is required.");void 0===e&&(e=-1),n=n||o;var i=s(n,t,e),a=function(){};return a.prototype=n.prototype,i.prototype=new a,i.prototype.constructor=i,r[t]=i,i},e.exports=r},{"./util":267}],264:[function(t,e,n){"use strict";var i=t("underscore"),r=1,o=-1,s=function(t){this.levels=t||{}};s.Prototype=function(){var t=function(t,e){if(t.pos<e.pos)return-1;if(t.pos>e.pos)return 1;if(t.mode<e.mode)return-1;if(t.mode>e.mode)return 1;if(t.mode===r){if(t.level<e.level)return-1;if(t.level>e.level)return 1}if(t.mode===o){if(t.level>e.level)return-1;if(t.level<e.level)return 1}return 0},e=function(t){var e=[];return i.each(t,function(t){var n=this.levels[t.type]||1e3;void 0!==n&&(e.push({pos:t.range[0],mode:r,level:n,id:t.id,type:t.type,node:t}),e.push({pos:t.range[1],mode:o,level:n,id:t.id,type:t.type,node:t}))},this),e};this.onText=function(){},this.onEnter=function(){return null},this.onExit=function(){},this.enter=function(t,e){return this.onEnter(t,e)},this.exit=function(t,e){this.onExit(t,e)},this.createText=function(t,e){this.onText(t,e)},this.start=function(n,i,s){var a=e.call(this,s);a.sort(t.bind(this));for(var c=[{context:n,entry:null}],l=0,u=0;u<a.length;u++){var h=a[u];this.createText(c[c.length-1].context,i.substring(l,h.pos)),l=h.pos;var f,d=1;if(h.mode===r){for(;d<c.length&&!(h.level<c[d].entry.level);d++);c.splice(d,0,{entry:h})}else if(h.mode===o){for(;d<c.length&&c[d].entry.id!==h.id;d++);for(f=d;f<c.length;f++)this.exit(c[f].entry,c[f-1].context);c.splice(d,1)}for(f=d;f<c.length;f++)c[f].context=this.enter(c[f].entry,c[f-1].context)}this.createText(n,i.substring(l))}},s.prototype=new s.Prototype,e.exports=s},{underscore:260}],265:[function(t,e,n){"use strict";var i={},r=t("underscore");i.templates={},i.renderTemplate=function(t,e){return i.templates[t](e)},"undefined"!=typeof window&&(window.console||(window.console={log:function(){}})),i.tpl=function(t,e){e=e||{};var n=window.$("script[name="+t+"]").html();return r.template(n,e)},e.exports=i},{underscore:260}],266:[function(t,e,n){"use strict";var i=function(t){this.index=t.index,this.match=[];for(var e=0;e<t.length;e++)this.match.push(t[e])};i.Prototype=function(){this.captures=function(){return this.match.slice(1)},this.toString=function(){return this.match[0]}},i.prototype=new i.Prototype;var r=function(t){this.exp=t};r.Prototype=function(){this.match=function(t){if(void 0===t)throw new Error("No string given");if(this.exp.global){var e,n=[];for(this.exp.compile(this.exp);null!==(e=this.exp.exec(t));)n.push(new i(e));return n}return this.exp.exec(t)}},r.prototype=new r.Prototype,r.Match=i,e.exports=r},{}],267:[function(t,e,n){"use strict";var i=t("underscore"),r={};r.uuid=function(t,e){var n,i="0123456789abcdefghijklmnopqrstuvwxyz".split(""),r=[],o=16;if(e=e||32)for(n=0;n<e;n++)r[n]=i[0|Math.random()*o];else{var s;for(r[8]=r[13]=r[18]=r[23]="-",r[14]="4",n=0;n<36;n++)r[n]||(s=0|16*Math.random(),r[n]=i[19==n?3&s|8:s])}return(t?t:"")+r.join("")},r.uuidGen=function(t){var e=1;return t=void 0!==t?t:"uuid_",function(n){return n=n||t,n+e++}};var o=function(t,e){var n,i=-1,r=t.length,o=e[0],s=e[1],a=e[2];switch(e.length){case 0:for(;++i<r;)(n=t[i]).callback.call(n.ctx);return;case 1:for(;++i<r;)(n=t[i]).callback.call(n.ctx,o);return;case 2:for(;++i<r;)(n=t[i]).callback.call(n.ctx,o,s);return;case 3:for(;++i<r;)(n=t[i]).callback.call(n.ctx,o,s,a);return;default:for(;++i<r;)(n=t[i]).callback.apply(n.ctx,e)}},s=/\s+/,a=function(t,e,n,i){if(!n)return!0;if("object"==typeof n){for(var r in n)t[e].apply(t,[r,n[r]].concat(i));return!1}if(s.test(n)){for(var o=n.split(s),a=0,c=o.length;a<c;a++)t[e].apply(t,[o[a]].concat(i));return!1}return!0};r.Events={on:function(t,e,n){if(!a(this,"on",t,[e,n])||!e)return this;this._events=this._events||{};var i=this._events[t]||(this._events[t]=[]);return i.push({callback:e,context:n,ctx:n||this}),this},once:function(t,e,n){if(!a(this,"once",t,[e,n])||!e)return this;var r=this,o=i.once(function(){r.off(t,o),e.apply(this,arguments)});return o._callback=e,this.on(t,o,n)},off:function(t,e,n){var r,o,s,c,l,u,h,f;if(!this._events||!a(this,"off",t,[e,n]))return this;if(!t&&!e&&!n)return this._events={},this;for(c=t?[t]:i.keys(this._events),l=0,u=c.length;l<u;l++)if(t=c[l],s=this._events[t]){if(this._events[t]=r=[],e||n)for(h=0,f=s.length;h<f;h++)o=s[h],(e&&e!==o.callback&&e!==o.callback._callback||n&&n!==o.context)&&r.push(o);r.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=Array.prototype.slice.call(arguments,1);if(!a(this,"trigger",t,e))return this;var n=this._events[t],i=this._events.all;return n&&o(n,e),i&&o(i,arguments),this},triggerLater:function(){var t=this,e=arguments;window.setTimeout(function(){t.trigger.apply(t,e)},0)},stopListening:function(t,e,n){var i=this._listeners;if(!i)return this;var r=!e&&!n;"object"==typeof e&&(n=this),t&&((i={})[t._listenerId]=t);for(var o in i)i[o].off(e,n,this),r&&delete this._listeners[o];return this}};var c={listenTo:"on",listenToOnce:"once"};i.each(c,function(t,e){r.Events[e]=function(e,n,r){var o=this._listeners||(this._listeners={}),s=e._listenerId||(e._listenerId=i.uniqueId("l"));return o[s]=e,"object"==typeof n&&(r=this),e[t](n,r,this),this}}),r.Events.bind=r.Events.on,r.Events.unbind=r.Events.off,r.Events.Listener={listenTo:function(t,e,n){if(!i.isFunction(n))throw new Error("Illegal argument: expecting function as callback, was: "+n);return this._handlers=this._handlers||[],t.on(e,n,this),this._handlers.push({unbind:function(){t.off(e,n)}}),this},stopListening:function(){if(this._handlers)for(var t=0;t<this._handlers.length;t++)this._handlers[t].unbind()}},r.propagate=function(t,e){if(!i.isFunction(e))throw"Illegal argument: provided callback is not a function";return function(n){return n?e(n):void e(null,t)}};var l=function(){};r.inherits=function(t,e,n){var r;return r=e&&e.hasOwnProperty("constructor")?e.constructor:function(){t.apply(this,arguments)},i.extend(r,t),l.prototype=t.prototype,r.prototype=new l,e&&i.extend(r.prototype,e),n&&i.extend(r,n),r.prototype.constructor=r,r.__super__=t.prototype,r},r.getJSON=function(e,n){if("undefined"==typeof window||"undefined"!=typeof nwglobal){var i=t("fs"),r=JSON.parse(i.readFileSync(e,"utf8"));n(null,r)}else{var o=window.$;o.getJSON(e).done(function(t){n(null,t)}).error(function(t){n(t,null)})}},r.prototype=function(t){return Object.getPrototypeOf?Object.getPrototypeOf(t):t.__proto__},r.inherit=function(t,e){var n,r=i.isFunction(t)?new t:t;if(i.isFunction(e))e.prototype=r,n=new e;else{var o=function(){};o.prototype=r,n=i.extend(new o,e)}return n},r.pimpl=function(t){var e=function(t){this.self=t};return e.prototype=t,function(t){return t=t||this,new e(t)}},r.parseStackTrace=function(t){var e,n=/([^@]*)@(.*):(\d+)/,i=/\s*at ([^(]*)[(](.*):(\d+):(\d+)[)]/,r=t.stack.split("\n"),o=[];for(e=0;e<r.length;e++){var s=n.exec(r[e]);s||(s=i.exec(r[e]));var a;s?(a={func:s[1],file:s[2],line:s[3],col:s[4]||0},""===a.func&&(a.func="<anonymous>")):a={func:"",file:r[e],line:"",col:""},o.push(a)}return o},r.callstack=function(t){var e;try{throw new Error}catch(n){e=n}var i=r.parseStackTrace(e);return t=t||0,i.splice(t+1)},r.stacktrace=function(t){var e=0===arguments.length?r.callstack().splice(1):r.parseStackTrace(t),n=[];return i.each(e,function(t){n.push(t.file+":"+t.line+":"+t.col+" ("+t.func+")")}),n.join("\n")},r.printStackTrace=function(t,e){if(t.stack){var n;if(void 0!==t.__stack)n=t.__stack;else{if(!i.isString(t.stack))return;n=r.parseStackTrace(t)}e=e||n.length,e=Math.min(e,n.length);for(var o=0;o<e;o++){var s=n[o];console.log(s.file+":"+s.line+":"+s.col,"("+s.func+")")}}},r.diff=function(t,e){var n;return i.isArray(t)&&i.isArray(e)?(n=i.difference(e,t),0===n.length?null:n):i.isObject(t)&&i.isObject(e)?(n={},i.each(Object.keys(e),function(i){var o=r.diff(t[i],e[i]);o&&(n[i]=o)}),i.isEmpty(n)?null:n):t!==e?e:void 0},r.deepclone=function(t){if(void 0!==t)return null===t?null:JSON.parse(JSON.stringify(t))},r.clone=function(t){return null===t||void 0===t?t:i.isFunction(t.clone)?t.clone():r.deepclone(t)},r.freeze=function(t){var e;if(i.isObject(t)){if(Object.isFrozen(t))return t;var n=Object.keys(t);for(e=0;e<n.length;e++){var o=n[e];t[o]=r.freeze(t[o])}return Object.freeze(t)}if(i.isArray(t)){var s=t;for(e=0;e<s.length;e++)s[e]=r.freeze(s[e]);return Object.freeze(s)}return t},r.later=function(t,e){return function(){var n=arguments;window.setTimeout(function(){t.apply(e,n)},0)}},r.isEmpty=function(t){return!t.match(/\w/)},r.slug=function(t){t=t.replace(/^\s+|\s+$/g,""),t=t.toLowerCase();for(var e="/_,:;",n="aaaaeeeeiiiioooouuuunc------",i=0,r=e.length;i<r;i++)t=t.replace(new RegExp(e.charAt(i),"g"),n.charAt(i));return t=t.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-")},r.getReadableFileSizeString=function(t){var e=-1,n=[" kB"," MB"," GB"," TB","PB","EB","ZB","YB"];do t/=1024,e++;while(t>1024);return Math.max(t,.1).toFixed(1)+n[e]},e.exports=r},{fs:129,underscore:260}],268:[function(t,e,n){(function(){var t=this,i=t._,r=Array.prototype,o=Object.prototype,s=Function.prototype,a=r.push,c=r.slice,l=r.concat,u=o.toString,h=o.hasOwnProperty,f=Array.isArray,d=Object.keys,p=s.bind,g=function(t){return t instanceof g?t:this instanceof g?void(this._wrapped=t):new g(t)};"undefined"!=typeof n?("undefined"!=typeof e&&e.exports&&(n=e.exports=g),n._=g):t._=g,g.VERSION="1.7.0";var v=function(t,e,n){if(void 0===e)return t;switch(null==n?3:n){case 1:return function(n){return t.call(e,n)};case 2:return function(n,i){return t.call(e,n,i)};case 3:return function(n,i,r){return t.call(e,n,i,r)};case 4:return function(n,i,r,o){return t.call(e,n,i,r,o)}}return function(){return t.apply(e,arguments)}};g.iteratee=function(t,e,n){return null==t?g.identity:g.isFunction(t)?v(t,e,n):g.isObject(t)?g.matches(t):g.property(t)},g.each=g.forEach=function(t,e,n){if(null==t)return t;e=v(e,n);var i,r=t.length;if(r===+r)for(i=0;i<r;i++)e(t[i],i,t);else{var o=g.keys(t);for(i=0,r=o.length;i<r;i++)e(t[o[i]],o[i],t)}return t},g.map=g.collect=function(t,e,n){if(null==t)return[];e=g.iteratee(e,n);for(var i,r=t.length!==+t.length&&g.keys(t),o=(r||t).length,s=Array(o),a=0;a<o;a++)i=r?r[a]:a,s[a]=e(t[i],i,t);return s};var y="Reduce of empty array with no initial value";g.reduce=g.foldl=g.inject=function(t,e,n,i){null==t&&(t=[]),e=v(e,i,4);var r,o=t.length!==+t.length&&g.keys(t),s=(o||t).length,a=0;if(arguments.length<3){if(!s)throw new TypeError(y);n=t[o?o[a++]:a++]}for(;a<s;a++)r=o?o[a]:a,n=e(n,t[r],r,t);return n},g.reduceRight=g.foldr=function(t,e,n,i){null==t&&(t=[]),e=v(e,i,4);var r,o=t.length!==+t.length&&g.keys(t),s=(o||t).length;if(arguments.length<3){if(!s)throw new TypeError(y);n=t[o?o[--s]:--s]}for(;s--;)r=o?o[s]:s,n=e(n,t[r],r,t);return n},g.find=g.detect=function(t,e,n){var i;return e=g.iteratee(e,n),g.some(t,function(t,n,r){if(e(t,n,r))return i=t,!0}),i},g.filter=g.select=function(t,e,n){var i=[];return null==t?i:(e=g.iteratee(e,n),g.each(t,function(t,n,r){e(t,n,r)&&i.push(t)}),i)},g.reject=function(t,e,n){return g.filter(t,g.negate(g.iteratee(e)),n)},g.every=g.all=function(t,e,n){if(null==t)return!0;e=g.iteratee(e,n);var i,r,o=t.length!==+t.length&&g.keys(t),s=(o||t).length;for(i=0;i<s;i++)if(r=o?o[i]:i,!e(t[r],r,t))return!1;return!0},g.some=g.any=function(t,e,n){if(null==t)return!1;e=g.iteratee(e,n);var i,r,o=t.length!==+t.length&&g.keys(t),s=(o||t).length;for(i=0;i<s;i++)if(r=o?o[i]:i,e(t[r],r,t))return!0;return!1},g.contains=g.include=function(t,e){return null!=t&&(t.length!==+t.length&&(t=g.values(t)),g.indexOf(t,e)>=0)},g.invoke=function(t,e){var n=c.call(arguments,2),i=g.isFunction(e);return g.map(t,function(t){return(i?e:t[e]).apply(t,n)})},g.pluck=function(t,e){return g.map(t,g.property(e))},g.where=function(t,e){return g.filter(t,g.matches(e))},g.findWhere=function(t,e){return g.find(t,g.matches(e))},g.max=function(t,e,n){var i,r,o=-(1/0),s=-(1/0);if(null==e&&null!=t){t=t.length===+t.length?t:g.values(t);for(var a=0,c=t.length;a<c;a++)i=t[a],i>o&&(o=i)}else e=g.iteratee(e,n),g.each(t,function(t,n,i){r=e(t,n,i),(r>s||r===-(1/0)&&o===-(1/0))&&(o=t,s=r)});return o},g.min=function(t,e,n){var i,r,o=1/0,s=1/0;if(null==e&&null!=t){t=t.length===+t.length?t:g.values(t);for(var a=0,c=t.length;a<c;a++)i=t[a],i<o&&(o=i)}else e=g.iteratee(e,n),g.each(t,function(t,n,i){r=e(t,n,i),(r<s||r===1/0&&o===1/0)&&(o=t,s=r)});return o},g.shuffle=function(t){for(var e,n=t&&t.length===+t.length?t:g.values(t),i=n.length,r=Array(i),o=0;o<i;o++)e=g.random(0,o),e!==o&&(r[o]=r[e]),r[e]=n[o];return r},g.sample=function(t,e,n){return null==e||n?(t.length!==+t.length&&(t=g.values(t)),t[g.random(t.length-1)]):g.shuffle(t).slice(0,Math.max(0,e))},g.sortBy=function(t,e,n){return e=g.iteratee(e,n),g.pluck(g.map(t,function(t,n,i){return{value:t,index:n,criteria:e(t,n,i)}}).sort(function(t,e){var n=t.criteria,i=e.criteria;if(n!==i){if(n>i||void 0===n)return 1;if(n<i||void 0===i)return-1}return t.index-e.index}),"value")};var m=function(t){return function(e,n,i){var r={};return n=g.iteratee(n,i),g.each(e,function(i,o){var s=n(i,o,e);t(r,i,s)}),r}};g.groupBy=m(function(t,e,n){g.has(t,n)?t[n].push(e):t[n]=[e]}),g.indexBy=m(function(t,e,n){t[n]=e}),g.countBy=m(function(t,e,n){g.has(t,n)?t[n]++:t[n]=1}),g.sortedIndex=function(t,e,n,i){n=g.iteratee(n,i,1);for(var r=n(e),o=0,s=t.length;o<s;){var a=o+s>>>1;n(t[a])<r?o=a+1:s=a}return o},g.toArray=function(t){return t?g.isArray(t)?c.call(t):t.length===+t.length?g.map(t,g.identity):g.values(t):[]},g.size=function(t){return null==t?0:t.length===+t.length?t.length:g.keys(t).length},g.partition=function(t,e,n){e=g.iteratee(e,n);var i=[],r=[];return g.each(t,function(t,n,o){(e(t,n,o)?i:r).push(t)}),[i,r]},g.first=g.head=g.take=function(t,e,n){if(null!=t)return null==e||n?t[0]:e<0?[]:c.call(t,0,e)},g.initial=function(t,e,n){return c.call(t,0,Math.max(0,t.length-(null==e||n?1:e)))},g.last=function(t,e,n){if(null!=t)return null==e||n?t[t.length-1]:c.call(t,Math.max(t.length-e,0))},g.rest=g.tail=g.drop=function(t,e,n){return c.call(t,null==e||n?1:e)},g.compact=function(t){return g.filter(t,g.identity)};var b=function(t,e,n,i){if(e&&g.every(t,g.isArray))return l.apply(i,t);for(var r=0,o=t.length;r<o;r++){var s=t[r];g.isArray(s)||g.isArguments(s)?e?a.apply(i,s):b(s,e,n,i):n||i.push(s)}return i};g.flatten=function(t,e){return b(t,e,!1,[])},g.without=function(t){return g.difference(t,c.call(arguments,1))},g.uniq=g.unique=function(t,e,n,i){if(null==t)return[];g.isBoolean(e)||(i=n,n=e,e=!1),null!=n&&(n=g.iteratee(n,i));for(var r=[],o=[],s=0,a=t.length;s<a;s++){var c=t[s];if(e)s&&o===c||r.push(c),o=c;else if(n){var l=n(c,s,t);g.indexOf(o,l)<0&&(o.push(l),r.push(c))}else g.indexOf(r,c)<0&&r.push(c)}return r},g.union=function(){return g.uniq(b(arguments,!0,!0,[]))},g.intersection=function(t){if(null==t)return[];for(var e=[],n=arguments.length,i=0,r=t.length;i<r;i++){var o=t[i];if(!g.contains(e,o)){for(var s=1;s<n&&g.contains(arguments[s],o);s++);s===n&&e.push(o)}}return e},g.difference=function(t){var e=b(c.call(arguments,1),!0,!0,[]);return g.filter(t,function(t){return!g.contains(e,t)})},g.zip=function(t){if(null==t)return[];for(var e=g.max(arguments,"length").length,n=Array(e),i=0;i<e;i++)n[i]=g.pluck(arguments,i);return n},g.object=function(t,e){if(null==t)return{};for(var n={},i=0,r=t.length;i<r;i++)e?n[t[i]]=e[i]:n[t[i][0]]=t[i][1];return n},g.indexOf=function(t,e,n){if(null==t)return-1;var i=0,r=t.length;if(n){if("number"!=typeof n)return i=g.sortedIndex(t,e),t[i]===e?i:-1;i=n<0?Math.max(0,r+n):n}for(;i<r;i++)if(t[i]===e)return i;return-1},g.lastIndexOf=function(t,e,n){if(null==t)return-1;var i=t.length;for("number"==typeof n&&(i=n<0?i+n+1:Math.min(i,n+1));--i>=0;)if(t[i]===e)return i;return-1},g.range=function(t,e,n){arguments.length<=1&&(e=t||0,t=0),n=n||1;for(var i=Math.max(Math.ceil((e-t)/n),0),r=Array(i),o=0;o<i;o++,t+=n)r[o]=t;return r};var w=function(){};g.bind=function(t,e){var n,i;if(p&&t.bind===p)return p.apply(t,c.call(arguments,1));if(!g.isFunction(t))throw new TypeError("Bind must be called on a function");return n=c.call(arguments,2),i=function(){if(!(this instanceof i))return t.apply(e,n.concat(c.call(arguments)));w.prototype=t.prototype;var r=new w;w.prototype=null;var o=t.apply(r,n.concat(c.call(arguments)));return g.isObject(o)?o:r}},g.partial=function(t){var e=c.call(arguments,1);return function(){for(var n=0,i=e.slice(),r=0,o=i.length;r<o;r++)i[r]===g&&(i[r]=arguments[n++]);for(;n<arguments.length;)i.push(arguments[n++]);return t.apply(this,i)}},g.bindAll=function(t){var e,n,i=arguments.length;if(i<=1)throw new Error("bindAll must be passed function names");for(e=1;e<i;e++)n=arguments[e],t[n]=g.bind(t[n],t);return t},g.memoize=function(t,e){var n=function(i){var r=n.cache,o=e?e.apply(this,arguments):i;return g.has(r,o)||(r[o]=t.apply(this,arguments)),r[o]};return n.cache={},n},g.delay=function(t,e){var n=c.call(arguments,2);return setTimeout(function(){return t.apply(null,n)},e)},g.defer=function(t){return g.delay.apply(g,[t,1].concat(c.call(arguments,1)))},g.throttle=function(t,e,n){var i,r,o,s=null,a=0;n||(n={});var c=function(){a=n.leading===!1?0:g.now(),s=null,o=t.apply(i,r),s||(i=r=null)};return function(){var l=g.now();a||n.leading!==!1||(a=l);var u=e-(l-a);return i=this,r=arguments,u<=0||u>e?(clearTimeout(s),s=null,a=l,o=t.apply(i,r),s||(i=r=null)):s||n.trailing===!1||(s=setTimeout(c,u)),o}},g.debounce=function(t,e,n){var i,r,o,s,a,c=function(){var l=g.now()-s;l<e&&l>0?i=setTimeout(c,e-l):(i=null,n||(a=t.apply(o,r),i||(o=r=null)))};return function(){o=this,r=arguments,s=g.now();var l=n&&!i;return i||(i=setTimeout(c,e)),l&&(a=t.apply(o,r),o=r=null),a}},g.wrap=function(t,e){return g.partial(e,t)},g.negate=function(t){return function(){return!t.apply(this,arguments)}},g.compose=function(){var t=arguments,e=t.length-1;return function(){for(var n=e,i=t[e].apply(this,arguments);n--;)i=t[n].call(this,i);return i}},g.after=function(t,e){return function(){if(--t<1)return e.apply(this,arguments)}},g.before=function(t,e){var n;return function(){return--t>0?n=e.apply(this,arguments):e=null,n}},g.once=g.partial(g.before,2),g.keys=function(t){if(!g.isObject(t))return[];if(d)return d(t);var e=[];for(var n in t)g.has(t,n)&&e.push(n);return e},g.values=function(t){for(var e=g.keys(t),n=e.length,i=Array(n),r=0;r<n;r++)i[r]=t[e[r]];return i},g.pairs=function(t){for(var e=g.keys(t),n=e.length,i=Array(n),r=0;r<n;r++)i[r]=[e[r],t[e[r]]];return i},g.invert=function(t){for(var e={},n=g.keys(t),i=0,r=n.length;i<r;i++)e[t[n[i]]]=n[i];return e},g.functions=g.methods=function(t){var e=[];for(var n in t)g.isFunction(t[n])&&e.push(n);return e.sort()},g.extend=function(t){if(!g.isObject(t))return t;for(var e,n,i=1,r=arguments.length;i<r;i++){e=arguments[i];for(n in e)h.call(e,n)&&(t[n]=e[n])}return t},g.pick=function(t,e,n){var i,r={};if(null==t)return r;if(g.isFunction(e)){e=v(e,n);for(i in t){var o=t[i];e(o,i,t)&&(r[i]=o)}}else{var s=l.apply([],c.call(arguments,1));t=new Object(t);for(var a=0,u=s.length;a<u;a++)i=s[a],i in t&&(r[i]=t[i])}return r},g.omit=function(t,e,n){if(g.isFunction(e))e=g.negate(e);else{var i=g.map(l.apply([],c.call(arguments,1)),String);e=function(t,e){return!g.contains(i,e)}}return g.pick(t,e,n)},g.defaults=function(t){if(!g.isObject(t))return t;for(var e=1,n=arguments.length;e<n;e++){var i=arguments[e];for(var r in i)void 0===t[r]&&(t[r]=i[r])}return t},g.clone=function(t){return g.isObject(t)?g.isArray(t)?t.slice():g.extend({},t):t},g.tap=function(t,e){return e(t),t};var x=function(t,e,n,i){if(t===e)return 0!==t||1/t===1/e;if(null==t||null==e)return t===e;t instanceof g&&(t=t._wrapped),e instanceof g&&(e=e._wrapped);var r=u.call(t);if(r!==u.call(e))return!1;switch(r){case"[object RegExp]":case"[object String]":return""+t==""+e;case"[object Number]":return+t!==+t?+e!==+e:0===+t?1/+t===1/e:+t===+e;case"[object Date]":case"[object Boolean]":return+t===+e}if("object"!=typeof t||"object"!=typeof e)return!1;for(var o=n.length;o--;)if(n[o]===t)return i[o]===e;var s=t.constructor,a=e.constructor;if(s!==a&&"constructor"in t&&"constructor"in e&&!(g.isFunction(s)&&s instanceof s&&g.isFunction(a)&&a instanceof a))return!1;n.push(t),i.push(e);var c,l;if("[object Array]"===r){if(c=t.length,l=c===e.length)for(;c--&&(l=x(t[c],e[c],n,i)););}else{var h,f=g.keys(t);if(c=f.length,l=g.keys(e).length===c)for(;c--&&(h=f[c],l=g.has(e,h)&&x(t[h],e[h],n,i)););}return n.pop(),i.pop(),l};g.isEqual=function(t,e){return x(t,e,[],[])},g.isEmpty=function(t){if(null==t)return!0;if(g.isArray(t)||g.isString(t)||g.isArguments(t))return 0===t.length;for(var e in t)if(g.has(t,e))return!1;return!0},g.isElement=function(t){return!(!t||1!==t.nodeType)},g.isArray=f||function(t){return"[object Array]"===u.call(t)},g.isObject=function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},g.each(["Arguments","Function","String","Number","Date","RegExp"],function(t){g["is"+t]=function(e){return u.call(e)==="[object "+t+"]"}}),g.isArguments(arguments)||(g.isArguments=function(t){return g.has(t,"callee")}),"function"!=typeof/./&&(g.isFunction=function(t){return"function"==typeof t||!1}),g.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},g.isNaN=function(t){return g.isNumber(t)&&t!==+t},g.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"===u.call(t)},g.isNull=function(t){return null===t},g.isUndefined=function(t){return void 0===t},g.has=function(t,e){return null!=t&&h.call(t,e)},g.noConflict=function(){return t._=i,this},g.identity=function(t){return t},g.constant=function(t){return function(){return t}},g.noop=function(){},g.property=function(t){return function(e){return e[t]}},g.matches=function(t){var e=g.pairs(t),n=e.length;return function(t){if(null==t)return!n;t=new Object(t);for(var i=0;i<n;i++){var r=e[i],o=r[0];if(r[1]!==t[o]||!(o in t))return!1}return!0}},g.times=function(t,e,n){var i=Array(Math.max(0,t));e=v(e,n,1);for(var r=0;r<t;r++)i[r]=e(r);return i},g.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))},g.now=Date.now||function(){return(new Date).getTime()};var _={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},S=g.invert(_),C=function(t){var e=function(e){return t[e]},n="(?:"+g.keys(t).join("|")+")",i=RegExp(n),r=RegExp(n,"g");return function(t){return t=null==t?"":""+t,i.test(t)?t.replace(r,e):t}};g.escape=C(_),g.unescape=C(S),g.result=function(t,e){if(null!=t){var n=t[e];return g.isFunction(n)?t[e]():n}};var E=0;g.uniqueId=function(t){var e=++E+"";return t?t+e:e},g.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var O=/(.)^/,T={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},N=/\\|'|\r|\n|\u2028|\u2029/g,I=function(t){return"\\"+T[t]};g.template=function(t,e,n){!e&&n&&(e=n),e=g.defaults({},e,g.templateSettings);var i=RegExp([(e.escape||O).source,(e.interpolate||O).source,(e.evaluate||O).source].join("|")+"|$","g"),r=0,o="__p+='";t.replace(i,function(e,n,i,s,a){return o+=t.slice(r,a).replace(N,I),r=a+e.length,n?o+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'":i?o+="'+\n((__t=("+i+"))==null?'':__t)+\n'":s&&(o+="';\n"+s+"\n__p+='"),e}),o+="';\n",e.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{var s=new Function(e.variable||"obj","_",o)}catch(a){throw a.source=o,a}var c=function(t){return s.call(this,t,g)},l=e.variable||"obj";return c.source="function("+l+"){\n"+o+"}",c},g.chain=function(t){var e=g(t);return e._chain=!0,e};var A=function(t){return this._chain?g(t).chain():t};g.mixin=function(t){g.each(g.functions(t),function(e){var n=g[e]=t[e];g.prototype[e]=function(){var t=[this._wrapped];return a.apply(t,arguments),A.call(this,n.apply(g,t))}})},g.mixin(g),g.each(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=r[t];g.prototype[t]=function(){var n=this._wrapped;return e.apply(n,arguments),"shift"!==t&&"splice"!==t||0!==n.length||delete n[0],A.call(this,n)}}),g.each(["concat","join","slice"],function(t){var e=r[t];g.prototype[t]=function(){return A.call(this,e.apply(this._wrapped,arguments))}}),g.prototype.value=function(){return this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return g})}).call(this)},{}],269:[function(t,e,n){"use strict";t("../i18n/load");var i=t("archivist-core/browser"),r=t("./backend"),o=new r;$(function(){var t=new i({backend:o});t.start(),window.app=t})},{"../i18n/load":272,"./backend":270,"archivist-core/browser":6}],270:[function(t,e,n){"use strict";var i=t("archivist-core").Substance,r=t("archivist-core/interview"),o="/api/index",s=function(t){};s.Prototype=function(){this.getSubjects=function(t){$.ajax({url:"/api/public/subjects",dataType:"json",success:function(e){t(null,e)},error:function(e){console.error(e.responseText),t(e.responseText)}})},this.getSubjectsModel=function(t){this.getSubjects(function(e,n){t(null,new r.SubjectsModel(null,n))})},this.findDocuments=function(t,e){$.ajax({url:o+"/search?searchQuery="+encodeURIComponent(JSON.stringify(t)),dataType:"json",success:function(t){e(null,t)},error:function(t){console.error(t.responseText),e(t.responseText)}})},this.getNameMap=function(t){$.ajax({url:"/api/public/resources",dataType:"json",success:function(e){t(null,e)},error:function(e){console.error(e.responseText),t(e.responseText)}})}},i.initClass(s),e.exports=s},{"archivist-core":12,"archivist-core/interview":14}],271:[function(t,e,n){e.exports={"metadata.project_name":"Project Name","metadata.project_location":"Project Location","metadata.conductor":"Interview Conductor","metadata.operator":"Video Operator","metadata.sound_operator":"Sound Operator","metadata.interview_location":"Interview Location","metadata.interview_date":"Interview Date","metadata.persons_present":"Persons Present","metadata.interview_duration":"Interview Duration","metadata.published_on":"Published On","metadata.interviewee_bio":"Biography","metadata.show_more":"more...","metadata.show_less":"...less","panels.source":"Source","panels.subjects":"Topics","panels.entities":"Index","panels.info":"Info","entity.type.toponym":"Locations","entity.type.prison":"Prisons","entity.type.person":"Persons","entity.type.definition":"Definitions","entity.unknown_name":"Unknown name","reader.show_resources":"Find references","reader.show_on_map":"Show on map","reader.loading_message":"Loading document... This may take a few seconds.","browser.search_button":"Search","browser.search_placeholder":"Enter search terms","browser.clear_filters":"Clear Filters","browser.loading":"Loading documents...","browser.found":"documents found","browser.minutes":"min","browser.entity_suggestion":"We also found these articles:","browser.no_results":"Your search did not match any documents","browser.facets_title":"Topics:","interview.minutes":"min","entity.unknown_name":"Unknown name","map.toponyms":"Mentioned toponyms","map.prisons":"Mentioned prisons","map.click_helper":"Click on a location to see details","map.list_helper":"Go back to the list of locations","resources.go_back":"Go back to the list of documents","resources.open_map":"Open location on the map"}},{}],272:[function(t,e,n){(function(e){"use strict";var n=t("node-polyglot"),i=t("./en.json"),r=window.storage||window.localStorage,o=r.getItem("locale")||"en",s=JSON.parse(r.getItem("phrases"));"en"!==o&&s||(s=i);var a=new n({locale:o,phrases:s});a.switchLocale=function(t){$.ajax("/i18n/"+t+".json",{}).done(function(e){r.setItem("phrases",JSON.stringify(e)),r.setItem("locale",t),a.extend(e)}).error(function(t,e,n){console.error(n)})},e.i18n=a,a.switchLocale(o)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});
},{"./en.json":271,"node-polyglot":248}]},{},[269]);